<?php

namespace App\Controller\Api;

use App\Controller\Api\AppController;
use App\Controller\App;
use Cake\Auth\DefaultPasswordHasher;
use Cake\Datasource\ConnectionManager;
use Cake\Event\Event;
use Cake\Http\Client;
use Cake\ORM\TableRegistry;
use Cake\Utility\Security;
use Cake\Validation\Validator;
use Firebase\JWT\JWT;
use RNCryptor\RNCryptor\Decryptor;
use RNCryptor\RNCryptor\Encryptor;

// include '../vendor/rncryptor/rncryptor/src/RNCryptor/Decryptor.php';

class IIMobilelatestController extends AppController
{

    public function beforeFilter(Event $event)
    {
        parent::beforeFilter($event);

        $this->request->addDetector([
            'json' => ['accept' => ['application/json'], 'param' => '_ext', 'value' => 'json'],

        ]);
        // Allow users to register and logout.
        // You should not add the "login" action to allow list. Doing so would
        // cause problems with normal functioning of AuthComponent.

    }

    public function initialize()
    {
        parent::initialize();
        $this->Auth->allow(['userLogin', 'verifyOtp', 'prepareRequestBody','refreshAuthToken']);
    } 

    public $helpers = ['CakeJs.Js'];
   
    public function _setPassword($password)
    {        
        return (new DefaultPasswordHasher)->hash($password);   
    }
    public function db($dbs)
    {
        ConnectionManager::config($dbs, [  
            'className' => 'Cake\Database\Connection',
            'driver' => 'Cake\Database\Driver\Mysql',
            'persistent' => false,
            'host' => 'localhost',
            'username' => 'dhanwantari',
            'password' => 'dhanwantari@23~',
            'database' => $dbs,
            'encoding' => 'utf8mb4',
            'timezone' => 'UTC',
            'cacheMetadata' => true,
        ]);
        ConnectionManager::drop('default');
        ConnectionManager::get($dbs);
        \Cake\Datasource\ConnectionManager::alias($dbs, 'default');
        
        $this->loadModel('Users');
        $this->loadmodel('Leaves');
        $this->loadmodel('Contacts');
        $this->loadmodel('Studentfeepending');
        $this->loadmodel('Students');
        $this->loadmodel('Classes');
        $this->loadmodel('Sections');
        $this->loadmodel('Classections');
        $this->loadmodel('Guardians');
        $this->loadmodel('Studentfees');
        $this->loadmodel('Classfee');
        $this->loadmodel('ClasstimeTabs');
        $this->loadmodel('Employees');
        $this->loadmodel('Employeeattendance');
        $this->loadmodel('Subjects');
        $this->loadmodel('Timetables');
        $this->loadmodel('Locations');
        $this->loadmodel('Transports');
        $this->loadmodel('Transportfees');
        $this->loadmodel('StudentTransfees');
        $this->loadmodel('Hostels');
        $this->loadmodel('StudentHostalfees');
        $this->loadmodel('IssueBook');
        $this->loadmodel('BookCopyDetail');
        $this->loadmodel('Book');
        $this->loadmodel('BookCategory');
        $this->loadmodel('CupBoard');
        $this->loadmodel('CupBoardShelf');
        $this->loadmodel('Fine');
        $this->loadmodel('Events');
        $this->loadmodel('Addresses');
        $this->loadmodel('Cities');
        $this->loadmodel('States');
        $this->loadmodel('Country');
        $this->loadmodel('Contacts');
        $this->loadmodel('Eventtypes');
        $this->loadmodel('Studattends');
        $this->loadmodel('Assignments');
        $this->loadmodel('Classteachers');
        $this->loadmodel('Feesheads');
        $this->loadmodel('Smsmanager');
        $this->loadmodel('Smsdelivery');
        $this->loadmodel('Album');
        $this->loadmodel('Exams');
        $this->loadmodel('Studentexamresult');
        $this->loadmodel('DropOutStudent');
        $this->loadmodel('Examtypes');
        $this->loadModel('Schools');
        $this->loadmodel('gatepass');
        $this->loadComponent('Cookie');
    }

    public function prepareRequestBody()
    {
        $data = json_encode($this->request->data);
        $cryptor = new Encryptor;
        $base64Encrypted = $cryptor->encrypt($data, DECRYPT);
        $response['payload'] = $base64Encrypted;
        $this->response->type('application/json');
        $this->response->body(json_encode($response));
        return $this->response;
    }

    public function dPayload($data)
    {
        $base64Encrypted = $data->payload;
        $cryptor = new Decryptor;
        $plaintext = $cryptor->decrypt($base64Encrypted, DECRYPT);
        $postData = json_decode($plaintext);
        return $postData;
    }

    // For Send Sms

    //~ public function addnotice(){

    //~ if( $this->request->is(['post','put']) )
    //~ {
    //~ $req_data = $this->request->data;
    //~ if(count($req_data['image']>0))
    //~ {
    //~ //$size=count($req_data['image']);
    //~ $files=array();
    //~ foreach($req_data['image'] as $work){
    //~ //pr($work);

    //~ $item=$work['tmp_name'];
    //~ $filename=$work['name'];
    //~ $ext=  end(explode('.', $filename));
    //~ $names = md5(time($filename));
    //~ $imagename=$names.'.'.$ext;
    //~ $filePath = WWW_ROOT .'img/'.$imagename;
    //~ if(move_uploaded_file($item, $filePath))
    //~ {
    //~ $files[]=$imagename;
    //~ }

    //~ } pr($files) die;

    //~ $filename=$_FILES['file']['name'];
    //~ //pr($filename); die;

    //~ $item=$_FILES['file']['tmp_name'];
    //~ $ext=  end(explode('.', $filename));
    //~ $names = md5(time($filename));
    //~ $imagename=$names.'.'.$ext;
    //~ $filePath = WWW_ROOT .'img/'.$imagename;
    //~ if(move_uploaded_file($item, $filePath))
    //~ {
    //~ $files=$imagename;
    //~ }
    //~ else
    //~ {
    //~ $files="";
    //~ }
    //~ }

    //~ }

    //~ }

    public function uploadToken()
    {
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $userid = $postData->userId;
            $token = $postData->token;
            $roleId = $postData->roleId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($userid) || empty($idsprimeID)|| empty($token)|| empty($roleId)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $this->loadmodel('Students');
            $rttr = 0;
        if ($roleId == "STUDENT") {
            $uid = explode(',', $userid);
            $student_status = $this->Students->find('all')->where(['Students.id IN' => $uid])->count();
            if ($student_status > 0) {

                foreach ($uid as $kk => $rrt) {

                    $Students = $this->Students->get($rrt);
                    $Students->token = $token;
                    if ($this->Students->save($Students)) {
                        $rttr++;
                    }

                }

                if ($rttr > 0) {
                    $response["success"] = 1;
                    $response["message"] = "Token upload success";

                } else {
                    $response["success"] = 0;
                    $response["message"] = "Token upload failed";
                }

            } else {
                $response["success"] = 0;
                $response["message"] = "Token upload failed";
            }

        } elseif ($roleId == "TEACHER") {

            $emp_status = $this->Employees->find('all')->where(['Employees.id' => $userid])->count();
            if ($emp_status > 0) {
                $Employees = $this->Employees->get($userid);

                $Employees->token = $token;

                if ($this->Employees->save($Employees)) {
                    $response["success"] = 1;
                    $response["message"] = "Token upload success";

                } else {
                    $response["success"] = 0;
                    $response["message"] = "Token upload failed";
                }

            } else {

                $response["success"] = 0;
                $response["message"] = "Token upload failed";
            }

        } else {

            $response["success"] = 0;
            $response["message"] = "Token upload failed";

        }

        echo json_encode($response);
        die;
    }

    }

    public function sendsms()
    {

        $current_date = date('Y-m-d');
        $this->autoRender = false;
        $attendence_status = $this->Studattends->find()->where(['Studattends.status' => 'A', 'Studattends.date' => $current_date])->count();

        $category = "Absent";
        $smstemp = $this->Smsmanager->find('all')->select(['id', 'message'])->where(['category' => $category])->order(['id' => 'ASC'])->first();
        $smstemp_id = $smstemp['id'];
        $mesg = "Dear Parent, Please be informed that your ward is absent from school today.";

        $connsssks = ConnectionManager::get('default');

        $mesg1 = addslashes($mesg);
        $connsssks->execute("INSERT INTO
				`sms_deliveries`(`sms_temp_id`, `message`, `total students`,`status`) VALUES
				('" . $smstemp_id . "','" . $mesg1 . "','" . $attendence_status . "','Y')");

        $smsdelivery = $this->Smsdelivery->find('all')->select(['id'])->where(['sms_temp_id' => $smstemp_id])->order(['id' => 'DESC'])->first();

        if ($attendence_status > 0) {
            $attendences = $this->Studattends->find('all')->contain('Students')->where(['Studattends.status' => 'A', 'Studattends.date' => $current_date])->toarray();

            $g = 0;

            foreach ($attendences as $j) {

                $mobile = trim($j['student']['sms_mobile']);
                $fname = trim(ucwords(strtolower($j['student']['fname'])));
                $middlename = trim(ucwords(strtolower($j['student']['middlename'])));
                $lname = trim(ucwords(strtolower($j['student']['lname'])));
                $names = $fname . " " . $middlename . " " . $lname;
                $conn = ConnectionManager::get('default');
                $g++;
                $mesg = "Dear Parent, Please be informed that your ward " . $names . " is absent from school today.";

                $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

                if ($result == "Invalid Input Data") {
                    $connsssksg = ConnectionManager::get('default');
                    date_default_timezone_set('Asia/Kolkata');
                    $date = date('Y-m-d H:i:s');

                    $connsssksg->execute("INSERT INTO
				`sms_deliveries_details`(`stud_id`, `smsmobile`, `sms_deliv_id`, `sms_temp_id`,`created`,`status`) VALUES
				('" . $j['student']['id'] . "','" . $mobile . "','" . $smsdelivery['id'] . "','" . $smstemp_id . "','" . $date . "','N')");

                } else if ($result == "Invalid Mobile Numbers") {
                    $connsssksk = ConnectionManager::get('default');
                    date_default_timezone_set('Asia/Kolkata');
                    $date = date('Y-m-d H:i:s');

                    $connsssksk->execute("INSERT INTO
				`sms_deliveries_details`(`stud_id`, `smsmobile`, `sms_deliv_id`, `sms_temp_id`,`created`,`status`) VALUES
				('" . $j['student']['id'] . "','" . $mobile . "','" . $smsdelivery['id'] . "','" . $smstemp_id . "','" . $date . "','N')");

                } else if ($result == "Insufficient credits") {
                    $connsssksks = ConnectionManager::get('default');
                    date_default_timezone_set('Asia/Kolkata');
                    $date = date('Y-m-d H:i:s');

                    $connsssksks->execute("INSERT INTO
				`sms_deliveries_details`(`stud_id`, `smsmobile`, `sms_deliv_id`, `sms_temp_id`,`created`,`status`) VALUES
				('" . $j['student']['id'] . "','" . $mobile . "','" . $smsdelivery['id'] . "','" . $smstemp_id . "','" . $date . "','N')");

                    echo "Insufficient credits";die;

                } else {

                    $connsssks = ConnectionManager::get('default');
                    date_default_timezone_set('Asia/Kolkata');
                    $date = date('Y-m-d H:i:s');

                    $connsssks->execute("INSERT INTO
				`sms_deliveries_details`(`stud_id`, `smsmobile`, `sms_deliv_id`, `sms_temp_id`,`created`) VALUES
				('" . $j['student']['id'] . "','" . $mobile . "','" . $smsdelivery['id'] . "','" . $smstemp_id . "','" . $date . "')");

                }

            }

        } else {

            echo "Fail";die;

        }
        echo "Success" . $g;die;
    }

    public function sendsmsexam()
    {

        $current_date = date('Y-m-d');
        $this->autoRender = false;
        $attendence_status = $this->Students->find()->where(['Students.status' => 'Y', 'Students.class_id !=' => '27'])->count();

        if ($attendence_status > 0) {
            $attendences = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.class_id !=' => '27'])->toarray();

            $g = 0;

            foreach ($attendences as $j) {

                $mobile = trim($j['sms_mobile']);

                $conn = ConnectionManager::get('default');
                $g++;
                $mesg = "Dear Parent,Kindly note that Open House for Result Declaration for all classes is on 13th October 2018 between 8:30 A.M. and 11:30 A.M.";

                $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

            }

        } else {

            echo "Fail";die;

        }
        echo "Success" . $g;die;
    }

    public function sendsmswinterwear()
    {

        $current_date = date('Y-m-d');
        $this->autoRender = false;
        $this->loadmodel('Newmember');
        $attendence_status = $this->Newmember->find()->where(['Newmember.status' => 'N'])->count();

        if ($attendence_status > 0) {

            $attendences = $this->Newmember->find('all')->where(['Newmember.status' => 'N'])->toarray();

            $g = 0;

            foreach ($attendences as $j) {

                $mobile = trim($j['mobile']);

                $conn = ConnectionManager::get('default');
                $g++;
                $mesg = 'Why should you cast your 1st preference vote in favor of FCS Yogesh Kumar Sharma Ballot No. 22 "To setting up of the portal for professional work assignment..." Kindly vote and support Jaipur chapter NIRC Election Dated ..22/12/2018';

                $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Aea6d66cfd228286924a936a199a11283&sender=Prbull&to=' . $mobile . '&sender=MYYRDS&message=' . urlencode($mesg));
                if ($result == "Invalid Input Data") {
                    $connsssksg = ConnectionManager::get('default');
                    $connsssksg->execute("UPDATE `newmember` SET `status`='N' WHERE `id`='" . $j['id'] . "'");

                } else if ($result == "Invalid Mobile Numbers") {
                    $connsssksk = ConnectionManager::get('default');

                    $connsssksk->execute("UPDATE `newmember` SET `status`='N' WHERE `id`='" . $j['id'] . "'");

                } else if ($result == "Insufficient credits") {

                    echo "Insufficient credits";die;

                } else {

                    $connsssks = ConnectionManager::get('default');

                    $connsssks->execute("UPDATE `newmember` SET `status`='Y' WHERE `id`='" . $j['id'] . "'");

                }

            }

        } else {

            echo "Fail";die;

        }
        echo "Success" . $g;die;
    }
/*
// For Student login
public function userLogin()
{
$this->loadmodel('Users');
$this->autoRender = false;
$response = array();

if (isset($_POST) && !empty($_POST)) {
//pr($this->request->data); die;
$mobile = $_POST["mobile"];

$login_type = $_POST['login_type'];
if (empty($_POST["mobile"]) || empty($_POST["login_type"])) {
$response["success"] = 0;
$response["message"] = "Invalid Paramenters";
echo json_encode($response);
return;
}
if ($login_type == 'Student') {

//$student_id="S12007";

$students = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.sms_mobile' => $mobile])->first();
if (!empty($students)) {

$mobile = trim($students['sms_mobile']);

if($students['sms_mobile']=="9314744342"){
$data['otp'] = 1234;
}else{
$data['otp'] = rand(1001, 9999);
}
$success = 0;
$mesg = "Your One Time Password for Sanskar School  is " . $data['otp'];

// $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

$patch = $this->Students->patchEntity($students, $data);
$this->Students->save($patch);
$result = 1;
if ($result) {
$response["success"] = 1;
$response["otp"] = $data['otp'];
$response["message"] = "OTP send successfully to registered mobile number";
} else {
$response["success"] = 0;
$response["message"] = "Error In sending OTP. Please Try Again";

}

echo json_encode($response);
return;

} else {

$response["success"] = 0;
$response["message"] = "You Are Not A Registered Student";
echo json_encode($response);
}

} else if ($login_type == 'Staff') {
//pr($user); die;

$emp = $this->Employees->find('all')->where(['Employees.mobile' => $mobile, 'status' => 'Y'])->first();
$user = $this->Users->find('all')->where(['tech_id' => $emp->id])->first();
if (!empty($emp) && ($user['role_id'] == '3' || $user['role_id'] == '21')) {
$mobile = trim($emp['mobile']);
if($emp['mobile']=="9829596972"){
$data['otp'] = 1234;
}else{
$data['otp'] = rand(1001, 9999);
}
$mesg = "Your One Time Password for Sanskar School  is " . $data['otp'];

// $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));
$patch = $this->Employees->patchEntity($emp, $data);
$this->Employees->save($patch);
$result = 1;
if ($result) {
$response["success"] = 1;
$response['otp'] = $data['otp'];
$response["message"] = "OTP send successfully to registered mobile number";

} else {
$response["success"] = 0;
$response["message"] = "Error In sending OTP. Please Try Again";

}

echo json_encode($response);

} else {
$response["success"] = 0;
$response["message"] = "You Are Not a Registered Employee";
echo json_encode($response);
}

} else if ($login_type == 'Admin') {
$response["success"] = 0;
$response["message"] = "This Section is Under Development";
echo json_encode($response);
} else {
$response["success"] = 0;
$response["message"] = "Invalid User Type";
echo json_encode($response);
}

} else {

$response["success"] = 0;
echo json_encode($response);

}
}
 */
    // For Student login
    public function userLogin()
    {
        $this->autoRender = false;
        $this->loadModel('Users');
        $response = array();
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $mobile = $postData->mobile;
            $login_type = $postData->login_type;

            if (empty($mobile) || empty($login_type)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Paramenters";
                echo json_encode($response);
                return;
            }

            if ($login_type == 'Student') {

                //$student_id="S12007";

                $users = $this->Users->find('all')->where(['Users.role_id' => '2', 'Users.mobile' => $mobile])->first();
                if (!empty($users)) {

                    $mobile = trim($users['mobile']);

                    // $data['otp'] = rand(1001, 9999);
                    $data['otp'] = 1234;

                    $success = 0;
                    $mesg = "Your One Time Password for School  is " . $data['otp'];
//$result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

                    $patch = $this->Users->patchEntity($users, $data);
                    $this->Users->save($patch);
                    $result = 1;
                    if ($result) {
                        $response["success"] = 1;
                        // $response["otp"] = $data['otp'];
                        $response["message"] = "OTP send successfully to registered mobile number";
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Error In sending OTP. Please Try Again";

                    }

                    echo json_encode($response);
                    return;

                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not A Registered Student";
                    echo json_encode($response);
                }

            } else if ($login_type == 'Staff') {
                //pr($user); die;
                $user = $this->Users->find('all')->where(['Users.mobile' => $mobile])->first();

                if (!empty($user) && ($user['role_id'] == '3' || $user['role_id'] == '21')) {
                    $mobile = trim($user['mobile']);

                    // $data['otp'] = rand(1001, 9999);
                    $data['otp'] = 1234;

                    $mesg = "Your One Time Password for School  is " . $data['otp'];

                    // $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));
                    $patch = $this->Users->patchEntity($user, $data);
                    $this->Users->save($patch);
                    $result = 1;
                    if ($result) {
                        $response["success"] = 1;
                        // $response['otp'] = $data['otp'];
                        $response["message"] = "OTP send successfully to registered mobile number";

                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Error In sending OTP. Please Try Again";

                    }

                    echo json_encode($response);

                } else {
                    $response["success"] = 0;
                    $response["message"] = "You Are Not a Registered Employee";
                    echo json_encode($response);
                }

            } else if ($login_type == 'Admin') {
                $user = $this->Users->find('all')->where(['Users.mobile' => $mobile, 'is_admin' => 'Y'])->first();

                if (!empty($user)) {
                    $mobile = trim($user['mobile']);

                    $data['otp'] = rand(1001, 9999);
                    // $data['otp'] = 1234;

                    $mesg = "Your One Time Password for School  is " . $data['otp'];
                    $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));
                    $patch = $this->Users->patchEntity($user, $data);
                    $this->Users->save($patch);
                    $result = 1;
                    if ($result) {
                        $response["success"] = 1;
                        // $response['otp'] = $data['otp'];
                        $response["message"] = "OTP send successfully to registered mobile number";

                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Error In sending OTP. Please Try Again";

                    }

                    echo json_encode($response);

                } else {
                    $response["success"] = 0;
                    $response["message"] = "You Are Not a Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["success"] = 0;
                $response["message"] = "Invalid User Type";
                echo json_encode($response);
            }

        }
    }

    public function verifyOtp()
    {
        $this->autoRender = false;
        $this->loadModel('Users');
        $this->loadModel('Schools');
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $login_type = $postData->login_type;
            $mobile = $postData->mobile;
            $otp = $postData->otp;
            if (empty($mobile) || empty($login_type) || empty($otp)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Paramenters";
                echo json_encode($response);
                return;
            }
            if ($login_type == 'Student') {
                $studentsVerify = $this->Users->exists(['Users.role_id' => '2', 'Users.mobile' => $mobile, 'otp' => $otp]);
                if ($studentsVerify) {
                    $students = $this->Users->find('all')->where(['Users.role_id' => '2', 'Users.mobile' => $mobile])->group(['Users.db'])->toarray();

                    $result = 1;
                    $response["success"] = 1;
                    $data['userInfo']["roleId"] = 'STUDENT';
                    $data['userInfo']["mobile"] = $mobile;

                    $data['userInfo']['detail'] = array();

                    foreach ($students as $student) {

                        $school = $this->Schools->find('all')->where(['Schools.id' => $student['c_id']])->first();

                        $school_name = $school['school_name'];
                        $enroll["idsprimeID"] = $student['db'];
                        $enroll['school_name'] = $school_name;
                        $filename2 = 'https://idsprime.com/images/' . $student['db'] . 'logo.png';

                        if ($this->is_url_exist($filename2)) {
                            $enroll["logo"] = 'https://idsprime.com/images/' . $student['db'] . 'logo.png';
                        } else {
                            $enroll["logo"] = null;

                        }
                        $enroll['school_name'] = $school_name;
                        $studentsdetail = $this->Users->find('all')->where(['Users.role_id' => '2', 'Users.mobile' => $mobile, 'Users.db' => $student['db']])->toarray();
                        $enroll["userdetail"] = array();
                        foreach ($studentsdetail as $studentsde) {
                            $studentinfo['id'] = $studentsde['student_id'];
                            $studentinfo['enrollNo'] = $studentsde['email'];
                            $enroll["userdetail"][] = $studentinfo;
                            // array_push($data["userInfo"]['detail'], $enroll["details"]);
                        }
                        array_push($data["userInfo"]['detail'], $enroll);
                    }
                    $data['userInfo']['authToken'] = JWT::encode([
                        'sub' => $user['id'],
                        'exp' => time() + 604800,
                    ],
                        Security::salt());
                    /*     $result = 1;
                    $response["success"] = 1;
                    $response['userInfo']["roleId"] = 'STUDENT';
                    $response['userInfo']['detail'] = array();
                    foreach ($students as $student) {
                    if ($student['board_id'] == '1') {
                    $email = 'C' . $student['enroll'];
                    } else if ($student['board_id'] == '2') {
                    $email = 'CAM' . $student['enroll'];
                    } else {
                    $email = 'IB' . $student['enroll'];
                    }
                    $enroll['id'] = $student['id'];
                    $enroll['enrollNo'] = $email;
                    array_push($response["userInfo"]['detail'], $enroll);
                    }
                     */
                    $cryptor = new Encryptor;
                    $response['output'] = $cryptor->encrypt(json_encode($data), DECRYPT);
                    echo json_encode($response);
                    return;

                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);
                    return;
                }
            } else if ($login_type == 'Staff') {

                $empVerify = $this->Users->exists(['Users.mobile' => $mobile, 'otp' => $otp]);
                if ($empVerify) {
                    $user = $this->Users->find('all')->where(['Users.mobile' => $mobile])->first();

                    $response["success"] = 1;
                    if ($user['role_id'] == '3') {
                        $dateRange['userInfo']['roleId'] = 'TEACHER';
                    } else if ($emp['role_id'] == '21') {
                        $dateRange['userInfo']['roleId'] = 'GUARD';
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Invalid User Type";
                        echo json_encode($response);
                        return;
                    }

                    $school = $this->Schools->find('all')->where(['Schools.id' => $user['c_id']])->first();

                    $school_name = $school['school_name'];
                    $data['userInfo']["idsprimeID"] = $user['db'];
                    $data['userInfo']['school_name'] = $school_name;
                    $filename2 = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    if ($this->is_url_exist($filename2)) {
                        $data['userInfo']["logo"] = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    } else {
                        $data['userInfo']["logo"] = null;

                    }
                    $data['userInfo']['empId'] = $user['tech_id'];
                    $data['userInfo']['authToken'] = JWT::encode([
                        'sub' => $user['id'],
                        'exp' => time() + 604800,
                    ],
                        Security::salt());
                    $cryptor = new Encryptor;
                    $response['output'] = $cryptor->encrypt(json_encode($data), DECRYPT);
                    echo json_encode($response);
                    return;
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);
                    return;
                }

            } else if ($login_type == 'Admin') {
                $empVerify = $this->Users->exists(['Users.mobile' => $mobile, 'otp' => $otp]);
                if ($empVerify) {
                    $user = $this->Users->find('all')->where(['Users.mobile' => $mobile])->first();

                    $response["success"] = 1;
                    $data['userInfo']['empId'] = $user['id'];
                    if ($user['role_id'] == '1') {
                        $data['userInfo']['roleId'] = 'ADMIN';
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Invalid User Type";
                        echo json_encode($response);
                        return;
                    }

                    $school = $this->Schools->find('all')->where(['Schools.id' => $user['c_id']])->first();

                    $school_name = $school['school_name'];
                    $data['userInfo']['schoolInfo']["idsprimeID"] = $user['db'];
                    $data['userInfo']['schoolInfo']['school_name'] = $school_name;
                    $filename2 = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    if ($this->is_url_exist($filename2)) {
                        $data['userInfo']['schoolInfo']["logo"] = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    } else {
                        $data['userInfo']['schoolInfo']["logo"] = null;

                    }
                    $data['userInfo']['authToken'] = JWT::encode([
                        'sub' => $user['id'],
                        'exp' => time() + 604800,
                    ],
                        Security::salt());
                    $cryptor = new Encryptor;
                    $response['output'] = $cryptor->encrypt(json_encode($data), DECRYPT);
                    echo json_encode($response);
                    return;
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);
                    return;
                }
            } else {
                $response["success"] = 0;
                $response["message"] = "Invalid User Type";
                echo json_encode($response);
                return;
            }
        }
    }
    public function refreshAuthToken()
    {
        $this->autoRender = false;
        $this->loadModel('Users');
        $this->loadModel('Schools');
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $login_type = $postData->login_type;
            $mobile = $postData->mobile;
            $otp = $postData->otp;
            if (empty($mobile) || empty($login_type)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Paramenters";
                echo json_encode($response);
                return;
            }
            if ($login_type == 'Student') {
                $studentsVerify = $this->Users->exists(['Users.role_id' => '2', 'Users.mobile' => $mobile]);
                if ($studentsVerify) {
                    $students = $this->Users->find('all')->where(['Users.role_id' => '2', 'Users.mobile' => $mobile])->group(['Users.db'])->toarray();

                    $result = 1;
                    $response["success"] = 1;
                    $data['userInfo']["roleId"] = 'STUDENT';
                    $data['userInfo']["mobile"] = $mobile;

                    $data['userInfo']['detail'] = array();

                    foreach ($students as $student) {

                        $school = $this->Schools->find('all')->where(['Schools.id' => $student['c_id']])->first();

                        $school_name = $school['school_name'];
                        $enroll["idsprimeID"] = $student['db'];
                        $enroll['school_name'] = $school_name;
                        $filename2 = 'https://idsprime.com/images/' . $student['db'] . 'logo.png';

                        if ($this->is_url_exist($filename2)) {
                            $enroll["logo"] = 'https://idsprime.com/images/' . $student['db'] . 'logo.png';
                        } else {
                            $enroll["logo"] = null;

                        }
                        $enroll['school_name'] = $school_name;
                        $studentsdetail = $this->Users->find('all')->where(['Users.role_id' => '2', 'Users.mobile' => $mobile, 'Users.db' => $student['db']])->toarray();
                        $enroll["userdetail"] = array();
                        foreach ($studentsdetail as $studentsde) {
                            $studentinfo['id'] = $studentsde['student_id'];
                            $studentinfo['enrollNo'] = $studentsde['email'];
                            $enroll["userdetail"][] = $studentinfo;
                            // array_push($data["userInfo"]['detail'], $enroll["details"]);
                        }
                        array_push($data["userInfo"]['detail'], $enroll);
                    }
                    $data['userInfo']['authToken'] = JWT::encode([
                        'sub' => $user['id'],
                        'exp' => time() + 604800,
                    ],
                        Security::salt());
                    /*     $result = 1;
                    $response["success"] = 1;
                    $response['userInfo']["roleId"] = 'STUDENT';
                    $response['userInfo']['detail'] = array();
                    foreach ($students as $student) {
                    if ($student['board_id'] == '1') {
                    $email = 'C' . $student['enroll'];
                    } else if ($student['board_id'] == '2') {
                    $email = 'CAM' . $student['enroll'];
                    } else {
                    $email = 'IB' . $student['enroll'];
                    }
                    $enroll['id'] = $student['id'];
                    $enroll['enrollNo'] = $email;
                    array_push($response["userInfo"]['detail'], $enroll);
                    }
                     */
                    $cryptor = new Encryptor;
                    $response['output'] = $cryptor->encrypt(json_encode($data), DECRYPT);
                    echo json_encode($response);
                    return;

                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);
                    return;
                }
            } else if ($login_type == 'Staff') {

                $empVerify = $this->Users->exists(['Users.mobile' => $mobile]);
                if ($empVerify) {
                    $user = $this->Users->find('all')->where(['Users.mobile' => $mobile])->first();

                    $response["success"] = 1;
                    if ($user['role_id'] == '3') {
                        $dateRange['userInfo']['roleId'] = 'TEACHER';
                    } else if ($emp['role_id'] == '21') {
                        $dateRange['userInfo']['roleId'] = 'GUARD';
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Invalid User Type";
                        echo json_encode($response);
                        return;
                    }

                    $school = $this->Schools->find('all')->where(['Schools.id' => $user['c_id']])->first();

                    $school_name = $school['school_name'];
                    $data['userInfo']["idsprimeID"] = $user['db'];
                    $data['userInfo']['school_name'] = $school_name;
                    $filename2 = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    if ($this->is_url_exist($filename2)) {
                        $data['userInfo']["logo"] = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    } else {
                        $data['userInfo']["logo"] = null;

                    }
                    $data['userInfo']['empId'] = $user['tech_id'];
                    $data['userInfo']['authToken'] = JWT::encode([
                        'sub' => $user['id'],
                        'exp' => time() + 604800,
                    ],
                        Security::salt());
                    $cryptor = new Encryptor;
                    $response['output'] = $cryptor->encrypt(json_encode($data), DECRYPT);
                    echo json_encode($response);
                    return;
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);
                    return;
                }

            } else if ($login_type == 'Admin') {
                $empVerify = $this->Users->exists(['Users.mobile' => $mobile]);
                if ($empVerify) {
                    $user = $this->Users->find('all')->where(['Users.mobile' => $mobile])->first();

                    $response["success"] = 1;
                    $data['userInfo']['empId'] = $user['id'];
                    if ($user['role_id'] == '1') {
                        $data['userInfo']['roleId'] = 'ADMIN';
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "Invalid User Type";
                        echo json_encode($response);
                        return;
                    }

                    $school = $this->Schools->find('all')->where(['Schools.id' => $user['c_id']])->first();

                    $school_name = $school['school_name'];
                    $data['userInfo']['schoolInfo']["idsprimeID"] = $user['db'];
                    $data['userInfo']['schoolInfo']['school_name'] = $school_name;
                    $filename2 = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    if ($this->is_url_exist($filename2)) {
                        $data['userInfo']['schoolInfo']["logo"] = 'https://idsprime.com/images/' . $user['db'] . 'logo.png';
                    } else {
                        $data['userInfo']['schoolInfo']["logo"] = null;

                    }
                    $data['userInfo']['authToken'] = JWT::encode([
                        'sub' => $user['id'],
                        'exp' => time() + 604800,
                    ],
                        Security::salt());
                    $cryptor = new Encryptor;
                    $response['output'] = $cryptor->encrypt(json_encode($data), DECRYPT);
                    echo json_encode($response);
                    return;
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);
                    return;
                }
            } else {
                $response["success"] = 0;
                $response["message"] = "Invalid User Type";
                echo json_encode($response);
                return;
            }
        }
    }
    /*
    public function verifyOtp()
    {
    $this->autoRender = false;
    if ($this->request->is('post')) {
    if (empty($_POST["mobile"]) || empty($_POST["login_type"]) || empty($_POST["otp"])) {
    $response["success"] = 0;
    $response["message"] = "Invalid Paramenters";
    echo json_encode($response);
    return;
    }
    $login_type = $_POST["login_type"];
    $mobile = $_POST["mobile"];
    $otp = $_POST["otp"];
    if ($login_type == 'Student') {
    $studentsVerify = $this->Users->exists(['Students.status' => 'Y', 'Students.sms_mobile' => $mobile, 'otp' => $otp]);
    if ($studentsVerify) {
    $students = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.sms_mobile' => $mobile])->toarray();

    $result = 1;
    $response["success"] = 1;
    $response['userInfo']["roleId"] = 'STUDENT';
    $response['userInfo']['detail'] = array();
    foreach ($students as $student) {
    if ($student['board_id'] == '1') {
    $email = 'C' . $student['enroll'];
    } else if ($student['board_id'] == '2') {
    $email = 'CAM' . $student['enroll'];
    } else {
    $email = 'IB' . $student['enroll'];
    }
    $enroll['id'] = $student['id'];
    $enroll['enrollNo'] = $email;
    array_push($response["userInfo"]['detail'], $enroll);
    }

    echo json_encode($response);
    return;

    } else {
    $response["success"] = 0;
    $response["message"] = "Invalid OTP";
    echo json_encode($response);
    return;
    }
    } else if ($login_type == 'Staff') {
    $empVerify = $this->Employees->exists(['Employees.mobile' => $mobile, 'status' => 'Y', 'otp' => $otp]);
    if ($empVerify) {
    $emp = $this->Employees->find('all')->contain(['Users'])->where(['Employees.mobile' => $mobile])->first();
    $response["success"] = 1;
    if ($emp['user']['role_id'] == '3') {
    $response['userInfo']['roleId'] = 'TEACHER';
    } else if ($emp['user']['role_id'] == '21') {
    $response['userInfo']['roleId'] = 'GUARD';
    } else {
    $response["success"] = 0;
    $response["message"] = "Invalid User Type";
    echo json_encode($response);
    return;
    }
    $response['userInfo']['empId'] = $emp['id'];
    echo json_encode($response);
    return;
    } else {
    $response["success"] = 0;
    $response["message"] = "Invalid OTP";
    echo json_encode($response);
    return;
    }

    } else if ($login_type == 'Admin') {
    $response["success"] = 0;
    $response["message"] = "Invalid Paramenters";
    echo json_encode($response);
    return;
    } else {
    $response["success"] = 0;
    $response["message"] = "Invalid User Type";
    echo json_encode($response);
    return;
    }
    } else {
    $response["success"] = 0;
    $response['message'] = "Invalid data type";
    echo json_encode($response);

    }
    }
     */
    public function getTeacherInfo()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            //pr($this->request->data['empId']); die;
            $empid = $postData->empId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($empid) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Paameters";
                return;
            }
            $this->db($idsprimeID);

            $employee = $this->Employees->find('all')->where(['id' => $empid])->first();

            $emp_id = $employee['id'];

            $class_section1 = $this->Classteachers->find('all')->where(['teach_id' => $emp_id])->contain(['Classes', 'Sections'])->order(['teacher_type ASC'])->first();

            if (empty($class_section1)) {
                $class_section2 = $this->Classections->find('all')->where(['FIND_IN_SET(\'' . $emp_id . '\',Classections.teacher_id)'])->contain(['Classes', 'Sections'])->first();
            }

            if (!empty($class_section1)) {
                $asd = 1;
                $class_section = $class_section1->toArray();
            } else if (!empty($class_section2)) {
                $asd = 2;
                $class_section = $class_section2->toArray();

            }

            //pr($class_section);die;

            $address = $this->Addresses->find('all')->where(['Addresses.user_id' => $emp_id, 'Addresses.type' => '1'])->first();

            $current_address = $address['c_address'];
            $p_address = $address['p_address'];
            $current_city = $this->cities($address['c_city_id']);
            $city_name = $current_city[0]['name'];
            $current_state = $this->states($address['c_s_id']);
            $state_name = $current_state[0]['name'];
            $current_country = $this->countries($address['c_c_id']);
            $country_name = $current_country[0]['name'];

            $p_current_city = $this->cities($address['p_city_id']);
            $p_city_name = $current_city[0]['name'];
            $p_current_state = $this->states($address['p_s_id']);
            $p_state = $p_current_state[0]['name'];
            $p_current_country = $this->countries($address['p_c_id']);
            $p_country = $p_current_country[0]['name'];

            $response["success"] = 1;
            //$response["details"] = [];

            $product["employee_id"] = $emp_id;
            $product["fname"] = ucwords(strtolower($employee['fname']));
            $product["middlename"] = ucwords(strtolower($employee['middlename']));
            $product["lname"] = ucwords(strtolower($employee['lname']));
            $product["email"] = $employee['email'];
            if ($class_section['class_id']) {
                $product["class_id"] = $class_section['class_id'];
                $product["class"] = $class_section['class']['title'];

            } else {
                $product["class_id"] = '0';
                $product["class"] = 'N/A';

            }
            $product["dob"] = date('d-m-Y', strtotime($employee['dob']));
            $product["f_h_name"] = ucwords(strtolower($employee['f_h_name']));
            if ($class_section['section_id']) {
                $product["section_id"] = $class_section['section_id'];

                $product["section"] = $class_section['section']['title'];

            } else {
                $product["section_id"] = '0';
                $product["section"] = 'N/A';
            }

            $product["mobile"] = $employee['mobile'];
            $product["joiningdate"] = date('d-m-Y', strtotime($employee['joiningdate']));

            $product["department_id"] = $employee['department_id'];
            $product["designation_id"] = $employee['designation_id'];
            $product["department"] = $employee['department']['name'];
            if ($asd == '1') {
                if ($class_section['teacher_type'] == '2') {
                    $product["designation"] = "Co-Class Teacher";
                } else {
                    $product["designation"] = "Class Teacher";
                }
            } else {
                $product["designation"] = "Teacher";
            }
            $product["current_address"] = $current_address;
            $product["current_city"] = $city_name;
            $product["current_state"] = $state_name;
            $product["current_country"] = $country_name;
            $product["current_address_pincode"] = $address['c_pincode'];
            $product["permanant_address"] = $p_address;
            $product["permanant_city"] = $p_city_name;
            $product["permanant_state"] = $p_state;
            $product["permanant_country"] = $p_country;
            $product["permanant_address_pincode"] = $address['p_pincode'];

            if (!empty($employee['file'])) {
                $product["image"] = SITE_URL . 'webroot/uploads/' . $employee['file'];
            } else {
                $product["image"] = null;
            }
            //array_push($response["details"], $product);
            $response["details"] = $product;

            echo json_encode($response, JSON_UNESCAPED_SLASHES);
        }

    }
    public function getStudentInfo()
    {

        $this->loadmodel('Users');
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $ids = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($ids) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                die;
            }
            $this->db($idsprimeID);
            //pr($this->request->data);die;
            $id = explode(',', $postData->id);
            //pr($id);die;
            $response["success"] = 1;
            $response["students"] = array();
            foreach ($id as $s_id) {
                //pr($s_id);die;
                $student = $this->Students->find('all')->where(['Students.id' => $s_id, 'Students.status' => 'Y'])->first();
                //pr($student);
                $section_id = $this->findsections($student['section_id']);
                $class_id = $this->findclass($student['class_id']);
                $teacher = $this->findclasstecher($student['class_id'], $student['section_id']);
                //pr($teacher);die;
                if (!empty($student['fathername'])) {
                    $fatername = ucwords(strtolower($student['fathername']));
                }

                $current_address = $student['address'];
                $p_address = $student['address'];

                $city_name = "Jaipur";

                $state_name = "Rajasthan";

                $country_name = "India";
                //echo $country_name; die;

                $p_city_name = "Jaipur";

                $p_state = "Rajasthan";

                $p_country = "India";
                $product["id"] = $student['id'];
                $product["fname"] = ucwords(strtolower($student['fname']));
                $product["middlename"] = ucwords(strtolower($student['middlename']));
                $product["lname"] = ucwords(strtolower($student['lname']));
                $product["email"] = $student['username'];
                $product["dob"] = date('d-m-Y', strtotime($student['dob']));
                $product["gender"] = $student['gender'];
                $product["admission_no"] = $student['formno'];
                $product["roll_no"] = $student['enroll'];

                if ($student['board_id'] == '1') {
                    $bordds = "C";

                } else if ($student['board_id'] == '2') {
                    $bordds = "CAM";
                } else if ($student['board_id'] == '3') {

                    $bordds = "IB";
                }

                $product["enroll_no"] = $bordds . $student['enroll'];
                $product["class_id"] = $student['class_id'];
                $product["section_id"] = $student['section_id'];
                $product["mobile"] = $student['sms_mobile'];
                $product["class"] = $class_id['title'];
                $product["stclass"] = $class_id['title'];
                $product["section"] = $section_id['title'];
                $product["teacher_name"] = ucwords(strtolower($teacher[0]['employee']['fname'])) . " " . ucwords(strtolower($teacher[0]['employee']['lname']));
                $product["acedamicyear"] = $student['acedmicyear'];
                $product["current_address"] = ucwords(strtolower($student['address']));
                $product["current_city"] = ucwords(strtolower($student['city']));
                $product["current_state"] = $state_name;
                $product["current_country"] = $country_name;
                $product["current_address_pincode"] = $address['c_pincode'];
                $product["permanant_address"] = $p_address;
                $product["permanant_city"] = $p_city_name;
                $product["permanant_state"] = $p_state;
                $product["permanant_country"] = $p_country;
                $product["permanant_address_pincode"] = $address['p_pincode'];
                $product["fathername"] = $fatername;
                $product["mothername"] = ucwords(strtolower($student['mothername']));
                $product["guardian_mobileno"] = $guardian['mobileno'];
                if ($student['board_id'] == '1') {
                    $bordd = "";

                } else if ($student['board_id'] == '2') {
                    $bordd = "CAM";
                } else if ($student['board_id'] == '3') {

                    $bordd = "IB";
                }
                $filename2 = 'http://sanskar.idsprime.com/webroot/stu/' . $bordd . $student['enroll'] . '.JPG';

                if ($this->is_url_exist($filename2)) {
                    $product["image"] = 'http://sanskar.idsprime.com/webroot/stu/' . $bordd . $student['enroll'] . '.JPG';
                } else {
                    $product["image"] = null;

                }
                array_push($response["students"], $product);

            }
            echo json_encode($response, JSON_UNESCAPED_SLASHES);
        }
    }

    public function is_url_exist($url)
    {
        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_NOBODY, true);
        curl_exec($ch);
        $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

        if ($code == 200) {
            $status = true;
        } else {
            $status = false;
        }
        curl_close($ch);
        return $status;
    }

    public function findstudentfee()
    {

        $this->autoRender = false;
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $id = $postData->enroll_no;
            $role = $postData->role_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($id) || empty($role)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            //$id='42';
            //$id='6286';
            //$role='10';
            if ($role == '10') {
                $bid = ['2', '3'];
            } else if ($role == '11') {
                $bid = ['1'];

            } else {
                $bid = ['1', '2', '3'];

            }

            $student = $this->Students->find('all')->where(['Students.enroll' => $id, 'Students.board_id IN ' => $bid, 'Students.status' => 'Y'])->first();

            if ($student["class_id"]) {
                $users = $this->Users->find('all')->where(['Users.id' => '1'])->first();

                $acedmicyear = $users['academic_year'];

                $acedmiclassid = $student["class_id"];

                $classfee = $this->Classfee->find('all')->contain(['Classes'])->group('Classfee.academic_year')->where(['Classfee.fee_h_id IN' => ['2', '9'], 'Classfee.academic_year' => $acedmicyear, 'Classfee.class_id' => $acedmiclassid])->order(['Classfee.id' => 'ASC'])->select(['qu1_fees' => 'Classfee.qu1_fees', 'qu2_fees' => $this->Classfee->find()->func()->sum('Classfee.qu2_fees'), 'qu3_fees' => $this->Classfee->find()->func()->sum('Classfee.qu3_fees'), 'qu4_fees' => $this->Classfee->find()->func()->sum('Classfee.qu4_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.class_id',
                ])->toarray();
                $studentfeesk = $this->Studentfees->find('all')->where(['Studentfees.student_id' => $student["id"], 'Studentfees.acedmicyear' => $acedmicyear, 'Studentfees.status' => 'Y'])->toarray();

                $studentfees = $this->Studentfees->find('all')->where(['Studentfees.student_id' => $id, 'Studentfees.refrencepending' => '0', 'Studentfees.acedmicyear' => $acedmicyear, 'Studentfees.status' => 'Y'])->toarray();
                $fid = ['7', '3', '4', '9'];
                $preclassfee = $this->Classfee->find('all')->contain(['Classes'])->where(['Classfee.academic_year' => $acedmicyear, 'Classfee.class_id' => $acedmiclassid, 'Classfee.fee_h_id IN' => $fid])->order(['Classfee.fee_h_id' => 'ASC'])->toarray();

                $response["success"] = 1;
                $response["output"] = array();
                foreach ($studentfees as $k => $value) {
                    $quas[] = unserialize($value['quarter']);

                }

                $quaf = array();

                foreach ($quas as $h => $vale) {

                    $quaf = array_merge($quaf, $vale);

                }
                $rt = array();
                foreach ($quaf as $j => $t) {

                    $qua[] = $j;
                }

                $jk = 1;
                $kl = 0;
                $y = 1;
                $total = 0;
                if (isset($classfee) && !empty($classfee)) {

                    foreach ($preclassfee as $krt => $value) {

                        $findfee = $this->findfeeheadsname($value['fee_h_id']);

                        if ($findfee['name'] == "Admission Fee") {if (!in_array("Admission Fee", $qua)) {

                            $product["feeheads"] = "Admission Fee";

                            $dat = date('Y-m-d', strtotime($value['qu' . $jk . '_date']));if ($dat != '1970-01-01') {$product["feedate"] = date('d-m-Y', strtotime($dat));

                                $product["fees"] = number_format($value['qu' . $jk . '_fees'], 0, ',', '');
                                $total += $product["fees"];
                            } else { $product["fees"] = "not-set";}

                            array_push($response["output"], $product);
                        }

                        }

                        if ($findfee['name'] == "Caution Money") {

                            if (!in_array("Caution Money", $qua)) {

                                $product["feeheads"] = "Caution Money";

                                $dat = date('Y-m-d', strtotime($value['qu' . $jk . '_date']));if ($dat != '1970-01-01') {$product["feedate"] = date('d-m-Y', strtotime($dat));

                                    $product["fees"] = number_format($value['qu' . $jk . '_fees'], 0, ',', '');
                                    $total += $product["fees"];
                                } else { $product["fees"] = "not-set";}
                                array_push($response["output"], $product);

                            }

                        }

                        if ($findfee['name'] == "Development Fee") {

                            if (!in_array("Development Fee", $qua)) {
                                $product["feeheads"] = "Development Fee";

                                $dat = date('Y-m-d', strtotime($value['qu' . $jk . '_date']));if ($dat != '1970-01-01') {$product["feedate"] = date('d-m-Y', strtotime($dat));

                                    $product["fees"] = number_format($value['qu' . $jk . '_fees'], 0, ',', '');
                                    $total += $product["fees"];
                                } else { $product["fees"] = "not-set";}
                                array_push($response["output"], $product);
                            }

                        }

                        if ($findfee['name'] == "Miscellaneous Fee") {

                            if (!in_array("Miscellaneous Fee", $qua)) {

                                $product["feeheads"] = "Miscellaneous Fee";

                                $dat = date('Y-m-d', strtotime($value['qu' . $jk . '_date']));if ($dat != '1970-01-01') {$product["feedate"] = date('d-m-Y', strtotime($dat));

                                    $product["fees"] = number_format($value['qu' . $jk . '_fees'], 0, ',', '');
                                    $total += $product["fees"];
                                } else { $product["fees"] = "not-set";}

                                array_push($response["output"], $product);
                            }

                        }

                    }

                }
                for ($i = 1; $i < 5; $i++) {

                    $rg = $this->findclassfee($acedmiclassid, $acedmicyear);

                    if ($i == 1) {

                        if (!in_array("Quater" . $i, $qua)) {
                            $product["feeheads"] = "Tution Fee (April-June)";
                            $dat = date('Y-m-d', strtotime($rg['qu' . $i . '_date']));if ($dat != '1970-01-01') {
                                $product["feedate"] = date('d-m-Y', strtotime($dat));
                                $product["fees"] = number_format($classfee[0]['qu' . $i . '_fees'], 0, ',', '');
                                $total += $product["fees"];} else {
                                $product["feedate"] = '0';
                                $product["fees"] = '0';
                            }

                            array_push($response["output"], $product);

                        }
                    }if ($i == 2) {

                        if (!in_array("Quater" . $i, $qua)) {
                            $product["feeheads"] = "Tution Fee (July-Sept)";
                            $dat = date('Y-m-d', strtotime($rg['qu' . $i . '_date']));if ($dat != '1970-01-01') {
                                $product["feedate"] = date('d-m-Y', strtotime($dat));
                                $product["fees"] = number_format($classfee[0]['qu' . $i . '_fees'], 0, ',', '');

                                $total += $product["fees"];} else {
                                $product["feedate"] = '0';
                                $product["fees"] = '0';
                            }

                            array_push($response["output"], $product);
                        }
                    }

                    if ($i == 3) {

                        if (!in_array("Quater" . $i, $qua)) {
                            $product["feeheads"] = "Tution Fee (Oct-Dec)";
                            $dat = date('Y-m-d', strtotime($rg['qu' . $i . '_date']));if ($dat != '1970-01-01') {
                                $product["feedate"] = date('d-m-Y', strtotime($dat));
                                $product["fees"] = number_format($classfee[0]['qu' . $i . '_fees'], 0, ',', '');
                                $total += $product["fees"];

                            } else {
                                $product["feedate"] = '0';
                                $product["fees"] = '0';
                            }array_push($response["output"], $product);
                        }
                    }

                    if ($i == 4) {

                        if (!in_array("Quater" . $i, $qua)) {
                            $product["feeheads"] = "Tution Fee (Jan-March)";
                            $dat = date('Y-m-d', strtotime($rg['qu' . $i . '_date']));if ($dat != '1970-01-01') {
                                $product["feedate"] = date('d-m-Y', strtotime($dat));
                                $product["fees"] = number_format($classfee[0]['qu' . $i . '_fees'], 0, ',', '');

                                $total += $product["fees"];} else {
                                $product["feedate"] = '0';
                                $product["fees"] = '0';
                            }

                            array_push($response["output"], $product);
                        }
                    }

                }

                $response["total1"] = $total;

                $response["output2"] = array();
                $product = array();
                $fees = $this->Studentfees->find('all')->select(['id', 'deposite_amt', 'fee', 'discount', 'quarter'])->where(['Studentfees.student_id' => $student['id'], 'Studentfees.acedmicyear' => $acedamicyear, 'Studentfees.status' => 'Y'])->toArray();

                $total2 = 0;

                if ($studentfeesk) {$quass = array();foreach ($studentfeesk as $valsf) {

                    $quass = unserialize($valsf['quarter']);

                    $rst = array();
                    foreach ($quass as $sj => $dt) {

                        $rst[] = $sj;
                    }

                    $product["paidrefno"] = $valsf['id'];

                    $dats = date('Y-m-d', strtotime($valsf['paydate']));if ($dats != '1970-01-01') {$product["paidpaydate"] = date('d-m-Y', strtotime($dats));} else { $product["paidpaydate"] = "not-set";}
                    $product["paidfeeamt"] = number_format($valsf['deposite_amt'], 0, ',', '');
                    $total2 += $product["paidfeeamt"];
                    array_push($response["output2"], $product);
                }

                    $response["total2"] = $total2;

                } else {

                    $product["paidrefno"] = '';

                    $product["paidpaydate"] = "No Paid Fee Yet";
                    $product["paidfeeamt"] = '';
                    $response["total2"] = '0';
                    array_push($response["output2"], $product);
                }

                echo json_encode($response, JSON_UNESCAPED_SLASHES);

            } else {

                $response["success"] = 0;
                echo json_encode($response);

            }
        }

    }
    public function findclassfee($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Classfee');

// Start a new query.

        return $articles->find('all')->contain(['Classes'])->group('Classfee.academic_year')->group('Classfee.class_id')->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year])->order(['Classfee.id' => 'ASC'])->first();
    }

    public function findfeeheadsname($id)
    {

        $articles = TableRegistry::get('Feesheads');
        return $articles->find('all')->where(['Feesheads.id' => $id])->first();

    }
    public function CalculateDiscount($id, $cid, $acedamicyear)
    {

        $fees = 0;
        $conn = ConnectionManager::get('default');
        $sintall = "select * FROM class_fee_allocations WHERE academic_year='" . $acedamicyear . "' AND class_id =" . $cid;
        $rinstall = $conn->execute($sintall)->fetch('assoc');
        $installment = $rinstall['qu1_fees'];

        $p_user_id = "select * from discountcategory  where name=(select discountcategory FROM students WHERE id=" . $id . " and discountcategory!=''  order by id desc limit 1)";
        $result = $conn->execute($p_user_id)->fetch('assoc');
        $quas[] = unserialize($result['discount']);
        $quas1[] = unserialize($result['fh_id']);
        $fix = $quas[0][2];
        $percent = $quas1[0][2];

        if ($percent > 0) {
            $fees = $installment - ($installment * $percent) / 100;
        } else {
            $fees = $installment - $fix;

        }

        return $fees;

    }
    public function feetool()
    {

        $this->autoRender = false;
        $cnt = 0;
        $response = array();
        $conn = ConnectionManager::get('default');
        $acedamicyear = '2018-19';
        //Testing
        $fees = $this->Studentfees->find('all')->select(['student_id', 'id', 'deposite_amt', 'fee', 'discount', 'quarter', 'recipetno', 'discountcategory', 'paydate'])->where(['Studentfees.acedmicyear' => $acedamicyear, 'Studentfees.status' => 'Y'])->toArray();

        foreach ($fees as $values) {
            $quas = array();
            $quaf = array();
            $quas[] = unserialize($values['quarter']);
//}
            //pr($quas);
            //die;

            foreach ($quas as $h => $vale) {
                if (array_key_exists("Caution Money", $vale) && $vale['Caution Money'] > 5000) {
                    echo ($values['student_id'] . "-" . $vale['Caution Money']);
                    echo ("<br>");
                }
                if (array_key_exists("Admission Fee", $vale) && $vale['Admission Fee'] != 25000) {
                    //echo($values['student_id'] . "-" . $vale['Admission Fee']);
                    //echo("<br>");
                }
                if (array_key_exists("Miscellaneous  Fee", $vale) && $vale['Miscellaneous  Fee'] != 1850) {
                    //echo($values['student_id'] . "-" . $vale['Admission Fee']);
                    //echo("<br>");
                }
                if (array_key_exists("Quater1", $vale) && $vale['Quater1'] < 15000) {
                    //echo($values['student_id'] . "-" . $vale['Quater1']);
                    //echo("<br>");
                }
                if (array_key_exists("Quater2", $vale) && $vale['Quater2'] < 15000) {
                    //    echo($values['student_id'] . "-" . $vale['Quater2']);
                    //echo("<br>");
                }
                if (array_key_exists("Quater3", $vale) && $vale['Quater3'] < 15000) {
                    //echo($values['student_id'] . "-" . $vale['Quater3']);
                    //echo("<br>");
                }
                if (array_key_exists("Quater4", $vale) && $vale['Quater4'] < 15000) {
                    //echo($values['student_id'] . "-" . $vale['Quater4']);
                    //echo("<br>");
                }

                $cnt++;
            }

        }
        die;

    }

    public function classspractical($id = null)
    {

        $articles = TableRegistry::get('Subjects');

        return $articles->find('all')->where(['id' => $id])->select(['id', 'name', 'is_practicalfee'])->where(['is_practicalfee !=' => 0])->first();

    }

    public function finddisountstudenthistory($stid)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Studentfees');

// Start a new query.
        return $articles->find('all')->where(['Studentfees.student_id' => $stid, 'Studentfees.status' => 'Y'])->order(['Studentfees.id' => 'ASC'])->toArray();
    }

    public function singleStudentFees()
    {

        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $str = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($str) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $conn = ConnectionManager::get('default');

            $student = $this->Students->find('all')->where(['Students.id' => $str, 'Students.status' => 'Y'])->first();
            if ($student['category'] == 'RTE') {

                $response["success"] = 0;
                $response["output"] = null;
                $response["message"] = "You are RTE student in our Record.";
                echo json_encode($response);die;
            }
            $acedamicyear = $student["acedmicyear"];
            $class_id = $student["class_id"];

            $final_fees = $this->CalculateDiscount($student['id'], $class_id, $acedamicyear);

            $fees = $this->Studentfees->find('all')->select(['id', 'deposite_amt', 'fee', 'discount', 'quarter', 'recipetno', 'discountcategory', 'paydate'])->where(['Studentfees.student_id' => $student['id'], 'Studentfees.acedmicyear' => $acedamicyear, 'Studentfees.status' => 'Y'])->toArray();

            $paidfeestotal = 0;

            $discount = 0;
            foreach ($fees as $values) {
                $quater[] = unserialize($values['quarter']);
                $discount += $values['discount'];
                if ($values['recipetno'] != '0') {

                    $deposit += $values['deposite_amt'];
                }
                $fees = $this->Studentfeepending->find('all')->select(['amt'])->where(['Studentfeepending.r_id' => $values['id'], 'Studentfeepending.status' => 'N'])->first();
                $pendingamt += $fees['amt'];

            }

            $asd = array();
            foreach ($quater as $j => $l) {

                $asd += $l;

            }

            foreach ($asd as $j => $yu) {
                $paidfeestotals += $yu;

            }

            $paidfeestotal = $deposit;

            $amount = $this->findamount($class_id, $acedamicyear);
            $amount2 = $this->findamount($class_id, $acedamicyear);

            $newarray = array();

            foreach ($quater as $key => $value) {
                if ($value == 'Quater1') {
                    $newarray[] = 'qu1_fees';
                } else if ($value == 'Quater2') {
                    $newarray[] = 'qu2_fees';
                } else if ($value == 'Quater3') {
                    $newarray[] = 'qu3_fees';
                } else if ($value == 'Quater4') {
                    $newarray[] = 'qu4_fees';
                }

            }

            foreach ($newarray as $key => $iteam) {
                if (!in_array($iteam, $amount2[0])) {
                    $amount2[0][$iteam] = '';
                }

            }

            $findamount4month = $this->findamount4month($class_id, $acedamicyear);
            $findamount3month = $this->findamount3month($class_id, $acedamicyear);
            $findamount2month = $this->findamount2month($class_id, $acedamicyear);
            $findamount1month = $this->findamount1month($class_id, $acedamicyear);

            $student = $this->Students->find('all')->where(['Students.id' => $str, 'Students.status' => 'Y'])->first();
            $disfees = $student['dis_fees'];

            $findamount1month['qu1_fees'] = $findamount1month['qu1_fees'];

            $total_class_fees = ($amount[0]['qu1_fees'] + $amount[0]['qu2_fees'] + $amount[0]['qu3_fees'] + $amount[0]['qu4_fees']);

            // echo  $total_class_fees; die;

            $findsum = $findamount4month['qu4_fees'] + $findamount3month['qu3_fees'] + $findamount2month['qu2_fees'] + $findamount1month['qu1_fees'];

            if ($findsum > $paidfeestotals) {
                $total_due = $total_class_fees - $paidfeestotals;
            } else {
                $total_due = 0;

            }
            if ($findsum > $paidfeestotals) {
                $dueamt = $findsum - $paidfeestotals;
            } else {
                $dueamt = 0;

            }

            //$dueamt=$dueamt+$pendingamt;

            $output["success"] = 1;
            //$response["output"] = array();

            $product["discount"] = number_format($discount, 0, ',', '');
            //$dueamt= $dueamt-$discount;
            //$product["due_amount"]=number_format($dueamt,0,',','');
            $product["pending_fee"] = number_format($pendingamt, 0, ',', '');
            //$total_due=$total_due-$discount;

            //array_push($response["output"], $product);
            $response["totalfees"] = array();

            $t = array();
            $response["outstanding"] = array();
            //$response["outstanding"]= $total_due;
            $s = array();
            $response["duefee"] = array();

            if ($id > '5974' && $student['board_id'] == '1') {

                //  $quaterd[]="Admission Fee";
                $quaterd[] = "Development Fee";
                $quaterd[] = "Caution Money";

            } else {

                // $quaterd[]="Admission Fee";
                $quaterd[] = "Development Fee";
                $quaterd[] = "Caution Money";

            }

            if ($findamount1month['qu1_fees']) {
                $quaterd[] = "Miscellaneous Fee";
                $quaterd[] = "Quater1";
            }

            if ($findamount2month['qu2_fees']) {

                $quaterd[] = "Quater2";
            }

            if ($findamount3month['qu3_fees']) {

                $quaterd[] = "Quater3";
            }

            if ($findamount4month['qu4_fees']) {

                $quaterd[] = "Quater4";
            }

            if ($id > '5974' && $student['board_id'] == '1') {
                // $quateroutstand[]="Admission Fee";
                $quateroutstand[] = "Development Fee";
                $quateroutstand[] = "Caution Money";

            } else {

                //$quateroutstand[]="Admission Fee";
                $quateroutstand[] = "Development Fee";
                $quateroutstand[] = "Caution Money";

            }
            $quateroutstand[] = "Miscellaneous Fee";
            $quateroutstand[] = "Quater1";
            $quateroutstand[] = "Quater2";
            $quateroutstand[] = "Quater3";
            $quateroutstand[] = "Quater4";

            $dueamts = 0;

            $studentfees = $this->finddisountstudent($student['id'], $acedamicyear);

            $studentfeeshistory = $this->finddisountstudenthistory($student['id']);

            $quas33 = array();
            $praticale = 0;
            if ($student['class_id'] == 12 || $student['class_id'] == 13
                || $student['class_id'] == 15 || $student['class_id'] == 17 ||
                $student['class_id'] == 20 || $student['class_id'] == 22 ||
                $student['class_id'] == 26 || $student['class_id'] == 27) {

                $compsid = explode(',', $student['comp_sid']);
                $opt_sid = explode(',', $student['opt_sid']);
                foreach ($compsid as $k => $g) {

                    $subjectpracticals = $this->classspractical($g);
                    if ($subjectpracticals) {

                        $praticale += $subjectpracticals['is_practicalfee'];

                    }
                }

                foreach ($opt_sid as $ks => $gs) {

                    $subjectpracticalss = $this->classspractical($gs);
                    if ($subjectpracticalss) {

                        $praticale += $subjectpracticalss['is_practicalfee'];

                    }

                }

            }

            foreach ($studentfeeshistory as $ks => $values) {
                $quas33[] = unserialize($values['quarter']);

            }

            $quaf33 = array();

            foreach ($quas33 as $fhs => $vales) {

                $quaf33 = array_merge($quaf33, $vales);

            }
            $rt33 = array();
            foreach ($quaf33 as $js => $ts) {
                if ($js == "Admission Fee" || $js == "Development Fee" || $js == "Caution Money") {
                    $qua33[] = $js;
                }
            }

            if (!in_array("Admission Fee", $qua33)) {

                $response["success"] = 0;
                $response["output"] = null;
                $response["message"] = "Kindly Contact to Fee Adminstrator.";
                echo json_encode($response);die;
            }

            $quas = array();

            foreach ($studentfees as $k => $value) {
                $quas[] = unserialize($value['quarter']);

            }

            $quaf = array();

            foreach ($quas as $fh => $vale) {

                $quaf = array_merge($quaf, $vale);

            }

            $rt = array();
            foreach ($quaf as $j => $t) {
                if ($j != "Admission Fee" && $j != "Development Fee" && $j != "Caution Money") {
                    $qua[] = $j;
                }
            }

            $quahh = array();

            if (isset($qua)) {
                $quahh = array_merge($qua, $qua33);
            } else {
                $quahh = $qua33;

            }

            $h = array();

            foreach ($quaterd as $hj => $ty) {

                $dff = 0;

                if (!empty($quahh)) {

                    foreach ($quahh as $tj => $hy) {

                        if ($hy == $ty) {

                            $dff++;
                        } else {

                        }

                    }
                }

                if ($dff == '0') {

                    if ($ty == "Quater1") {

                        $tys = "Tution Fee";

                    } else if ($ty == "Quater2") {
                        $tys = "Tution Fee";

                    } else if ($ty == "Quater3") {

                        $tys = "Tution Fee";
                    } else if ($ty == "Quater4") {

                        $tys = "Tution Fee";
                    } else if ($ty == "Miscellaneous Fee") {

                        $tys = "Miscellaneous Fee";
                    } else if ($ty == "Development Fee") {

                        $tys = "Development Fee";
                    } else if ($ty == "Caution Money") {

                        $tys = "Caution Money";
                    }

                    $feeshead = $this->findfeeheadsid($tys);

                    $err = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feeshead['id']);

                    if ($ty == "Quater4") {
                        if (!in_array($ty, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $h['description'] = "Tution Fee (Jan-March) :Practical Fee";
                                $date = "qu4_date";
                                $due_total += $newfinal;
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount4month[$date]));
                                $h['fee'] = number_format($newfinal, 0, ',', '');
                                $dueamts += $h['fee'];
                            } else {

                                $h['description'] = "Tution Fee (Jan-March)";
                                $date = "qu4_date";
                                $due_total += $final_fees;
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount4month[$date]));
                                $h['fee'] = number_format($final_fees, 0, ',', '');
                                $dueamts += $h['fee'];

                            }
                            array_push($response["duefee"], $h);
                        }
                    } else if ($ty == "Quater3") {

                        if (!in_array($ty, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $h['description'] = "Tution Fee (Oct-Dec) :Practical Fee";
                                $date = "qu3_date";
                                $due_total += $newfinal;
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount3month[$date]));
                                $h['fee'] = number_format($newfinal, 0, ',', '');
                                $dueamts += $h['fee'];
                            } else {

                                $h['description'] = "Tution Fee (Oct-Dec)";
                                $date = "qu3_date";
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount3month[$date]));
                                $h['fee'] = number_format($final_fees, 0, ',', '');
                                $due_total += $final_fees;
                                $dueamts += $h['fee'];

                            }
                            array_push($response["duefee"], $h);

                        }
                    } else if ($ty == "Quater2") {
                        if (!in_array($ty, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $h['description'] = "Tution Fee (July-Sept) :Practical Fee";
                                $date = "qu2_date";
                                $due_total += $newfinal;
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount2month[$date]));
                                $h['fee'] = number_format($newfinal, 0, ',', '');
                                $dueamts += $h['fee'];
                            } else {

                                $h['description'] = "Tution Fee (July-Sept)";
                                $date = "qu2_date";
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount2month[$date]));
                                $h['fee'] = number_format($final_fees, 0, ',', '');
                                $due_total += $final_fees;
                                $dueamts += $h['fee'];

                            }
                            array_push($response["duefee"], $h);

                        }

                    } elseif ($ty == "Quater1") {

                        if (!in_array($ty, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $h['description'] = "Tution Fee (April-June) :Practical Fee";
                                $date = "qu1_date";
                                $due_total += $newfinal;
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount1month[$date]));
                                $h['fee'] = number_format($newfinal, 0, ',', '');
                                $dueamts += $h['fee'];
                            } else {
                                $h['description'] = "Tution Fee (April-June)";
                                $date = "qu1_date";
                                $h['lastdate'] = date('d-m-Y', strtotime($findamount1month[$date]));
                                $h['fee'] = number_format($final_fees, 0, ',', '');
                                $due_total += $final_fees;
                                $dueamts += $h['fee'];
                            }
                            array_push($response["duefee"], $h);

                        }

                    } elseif ($ty == "Miscellaneous Fee") {

                        if (!in_array($ty, $quahh)) {
                            $h['description'] = "Miscellaneous Fee";
                            $date = "qu1_date";
                            $h['lastdate'] = date('d-m-Y', strtotime($findamount1month[$date]));

                            $feesheadmisc = $this->findfeeheadsid("Miscellaneous Fee");

                            $errmisg = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feesheadmisc['id']);

                            $h['fee'] = number_format($errmisg[0]['qu1_fees'], 0, ',', '');
                            $due_total += $errmisg[0]['qu1_fees'];
                            $dueamts += $h['fee'];

                            array_push($response["duefee"], $h);

                        }

                    } elseif ($ty == "Caution Money") {
                        if (!in_array($ty, $quahh)) {
                            $h['description'] = "Caution Money";
                            $date = "qu1_date";
                            $h['lastdate'] = date('d-m-Y', strtotime($findamount1month[$date]));

                            $feesheadmiscaut = $this->findfeeheadsid("Caution Money");

                            $errmis4 = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feesheadmiscaut['id']);

                            $h['fee'] = number_format($errmis4[0]['qu1_fees'], 0, ',', '');
                            $due_total += $errmis4[0]['qu1_fees'];
                            $dueamts += $h['fee'];

                            array_push($response["duefee"], $h);

                        }

                    } elseif ($ty == "Development Fee") {
                        if (!in_array($ty, $quahh)) {
                            $h['description'] = "Development Fee";
                            $date = "qu1_date";
                            $h['lastdate'] = date('d-m-Y', strtotime($findamount1month[$date]));

                            $feesheadmisdev = $this->findfeeheadsid("Development Fee");

                            $errmis4dev = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feesheadmisdev['id']);

                            $h['fee'] = number_format($errmis4dev[0]['qu1_fees'], 0, ',', '');
                            $due_total += $errmis4dev[0]['qu1_fees'];
                            $dueamts += $h['fee'];

                            array_push($response["duefee"], $h);

                        }

                    }
                }

            }

            foreach ($quateroutstand as $hjd => $tyd) {

                $dffd = 0;
                if (!empty($quahh)) {

                    foreach ($quahh as $tjd => $hyd) {
                        if ($hyd == $tyd) {

                            $dffd++;
                        } else {

                        }

                    }
                }

                if ($dffd == '0') {

                    $rg = $this->findclassfee($student['class_id'], $acedamicyear);

                    if ($tyd == "Caution Money") {
                        if (!in_array($tyd, $quahh)) {

                            $feesheadcaut = $this->findfeeheadsid("Caution Money");

                            $errmiscaution = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feesheadcaut['id']);

                            $sd['description'] = "Caution Money";
                            $dated = "qu1_date";
                            $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu1_date']));
                            $sd['fee'] = number_format($errmiscaution[0]['qu1_fees'], 0, ',', '');
                            $outstanding_total += $errmiscaution[0]['qu1_fees'];
                            $total_dueout += $errmiscaution[0]['qu1_fees'];

                            array_push($response["outstanding"], $sd);
                        }
                    } else if ($tyd == "Development Fee") {
                        if (!in_array($tyd, $quahh)) {

                            $feesheaddev = $this->findfeeheadsid("Development Fee");

                            $errmisdev = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feesheaddev['id']);

                            $sd['description'] = "Development Fee";
                            $dated = "qu1_date";
                            $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu1_date']));
                            $sd['fee'] = number_format($errmisdev[0]['qu1_fees'], 0, ',', '');
                            $outstanding_total += $errmisdev[0]['qu1_fees'];
                            $total_dueout += $errmisdev[0]['qu1_fees'];

                            array_push($response["outstanding"], $sd);
                        }
                    } elseif ($tyd == "Miscellaneous Fee") {
                        if (!in_array($tyd, $quahh)) {

                            $feesheadmis = $this->findfeeheadsid("Miscellaneous Fee");

                            $errmis = $this->findfeeheadsamount($student['class_id'], $acedamicyear, $feesheadmis['id']);

                            $sd['description'] = "Miscellaneous Fee";
                            $dated = "qu1_date";
                            $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu1_date']));
                            $sd['fee'] = number_format($errmis[0]['qu1_fees'], 0, ',', '');
                            $outstanding_total += $errmis[0]['qu1_fees'];
                            $total_dueout += $errmis[0]['qu1_fees'];

                            array_push($response["outstanding"], $sd);
                        }
                    } else if ($tyd == "Quater4") {
                        if (!in_array($tyd, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $sd['description'] = "Tution Fee (Jan-March) :Practical Fee";
                                $dated = "qu4_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu4_date']));
                                $sd['fee'] = number_format($newfinal, 0, ',', '');
                                $outstanding_total += $newfinal;
                                $total_dueout += $sd['fee'];
                            } else {

                                $sd['description'] = "Tution Fee (Jan-March)";
                                $dated = "qu4_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu4_date']));
                                $sd['fee'] = number_format($final_fees, 0, ',', '');
                                $outstanding_total += $final_fees;
                                $total_dueout += $sd['fee'];

                            }

                            array_push($response["outstanding"], $sd);
                        }
                    } else if ($tyd == "Quater3") {

                        if (!in_array($tyd, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $sd['description'] = "Tution Fee (Oct-Dec) :Practical Fee";
                                $dated = "qu3_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu3_date']));
                                $sd['fee'] = number_format($newfinal, 0, ',', '');
                                $outstanding_total += $newfinal;
                                $total_dueout += $sd['fee'];
                            } else {

                                $sd['description'] = "Tution Fee (Oct-Dec)";
                                $dated = "qu3_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu3_date']));

                                $sd['fee'] = number_format($final_fees, 0, ',', '');
                                $outstanding_total += $final_fees;
                                $total_dueout += $sd['fee'];
                            }
                            array_push($response["outstanding"], $sd);

                        }
                    } else if ($tyd == "Quater2") {
                        if (!in_array($tyd, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $sd['description'] = "Tution Fee (July-Sept) :Practical Fee";
                                $dated = "qu2_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu2_date']));
                                $sd['fee'] = number_format($newfinal, 0, ',', '');
                                $outstanding_total += $newfinal;
                                $total_dueout += $sd['fee'];
                            } else {

                                $sd['description'] = "Tution Fee (July-Sept)";
                                $dated = "qu2_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu2_date']));

                                $sd['fee'] = number_format($final_fees, 0, ',', '');
                                $outstanding_total += $final_fees;

                                $total_dueout += $sd['fee'];

                            }
                            array_push($response["outstanding"], $sd);

                        }

                    } elseif ($tyd == "Quater1") {
                        if (!in_array($tyd, $quahh)) {

                            if ($praticale != 0) {
                                $newfinal = $final_fees + $praticale;
                                $sd['description'] = "Tution Fee (April-June) :Practical Fee";
                                $dated = "qu1_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu1_date']));
                                $sd['fee'] = number_format($newfinal, 0, ',', '');
                                $outstanding_total += $newfinal;
                                $total_dueout += $sd['fee'];
                            } else {

                                $sd['description'] = "Tution Fee (April-June)";
                                $dated = "qu1_date";
                                $sd['lastdate'] = date('d-m-Y', strtotime($rg['qu1_date']));
                                $outstanding_total += $final_fees;
                                $sd['fee'] = number_format($final_fees, 0, ',', '');

                                $total_dueout += $sd['fee'];

                            }
                            array_push($response["outstanding"], $sd);

                        }

                    }
                }

            }

            //Pending Fees
            $pending = $this->Studentfeepending->find('all')->select(['id', 'recipetnos', 'amt', 'created'])->where(['Studentfeepending.s_id' => $student['id'], 'Studentfeepending.status' => 'N'])->toArray();

            foreach ($pending as $values) {
                $sd['description'] = "Previous Due Ref. : " . $values['recipetnos'];
                $sd['lastdate'] = date('d-m-Y', strtotime($values['created']));

                $sd['fee'] = number_format($values['amt'], 0, ',', '');
                $outstanding_total += $values['amt'];
                array_push($response["outstanding"], $sd);
            }

            //Pending Fees

            $product["due_amount"] = number_format($due_total, 0, ',', '');

            if ($due_total > 0) {
                $product['payOnlineUrl'] = 'https://www.sanskarjaipur.com/online-fees/';
            } else {
                $product['payOnlineUrl'] = null;
            }
            $product["outstanding_amount"] = number_format($outstanding_total, 0, ',', '');
            $product["paidfees"] = number_format($paidfeestotal, 0, ',', '');
            $totaltopay = $outstanding_total + $paidfeestotal;
            $product["totalfees"] = number_format($totaltopay, 0, ',', '');
            $response["overall"] = $product;
            $output["output"] = $response;

            echo json_encode($output);die;

        }

    }

    public function findfeeheadsamount($id, $a_year, $feeheads)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Classfee');

// Start a new query.

        return $articles->find('all')->contain(['Classes'])->group('Classfee.academic_year')->group('Classfee.class_id')->select(['qu1_fees' => $articles->find()->func()->sum('Classfee.qu1_fees'), 'qu2_fees' => $articles->find('all')->func()->sum('Classfee.qu2_fees'), 'qu3_fees' => $articles->find('all')->func()->sum('Classfee.qu3_fees'), 'qu4_fees' => $articles->find('all')->func()->sum('Classfee.qu4_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.class_id',
        ])->where(['Classfee.class_id' => $id, 'Classfee.fee_h_id' => $feeheads, 'Classfee.academic_year' => $a_year])->order(['Classfee.id' => 'ASC'])->toArray();
    }

    public function findfeeheadsid($name)
    {

        $articles = TableRegistry::get('Feesheads');
        return $articles->find('all')->where(['Feesheads.name' => $name])->first();

    }

    public function finddisountstudent($stid, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Studentfees');

// Start a new query.
        return $articles->find('all')->where(['Studentfees.student_id' => $stid, 'Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y'])->order(['Studentfees.id' => 'ASC'])->toArray();
    }

    public function singleStudenttotalfees()
    {
        $this->loadmodel('Banks');
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $s_id = $postData->s_id;
            $acedamicyear = $postData->acedamicyear;
            $class_id = $postData->class_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($s_id) || empty($acedamicyear) || empty($class_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            /*$id= '12015';
            $acedamicyear= '2017-18';
            $class_id= '3'; */
            $student = $this->Students->find('all')->where(['Students.id' => $s_id, 'Students.status' => 'Y'])->first();
            // $id = $student['id'];
            $fees = $this->Studentfees->find('all')->select(['id', 'fee', 'discount', 'quarter'])->where(['Studentfees.student_id' => $s_id, 'Studentfees.acedmicyear' => $acedamicyear])->toArray();
            $paidfeestotal = 0;

            $discount = 0;
            foreach ($fees as $values) {
                $quater[] = unserialize($values['quarter']);
            }
            //pr($quater);
            $q = array();
            foreach ($quater as $key => $values) {
                foreach ($values as $keys => $fe) {
                    if ($keys != 'Misc. Fee') {
                        $paidfeestotal += $fe;
                    }
                    $q[] = $keys;
                }
                //pr($q);die;
                //$paidfeestotal += $values;
            }
            //$discount+=$values['amount']-$values['fee'];

            //pr($q);die;

            $amount = $this->findamount($class_id, $acedamicyear);
            $amount2 = $this->findamount($class_id, $acedamicyear);
            //pr($amount2);
            $newarray = array();
            foreach ($q as $key => $value) {
                if ($value == 'Quater1') {
                    $newarray[] = 'qu1_fees';
                } else if ($value == 'Quater2') {
                    $newarray[] = 'qu2_fees';
                } else if ($value == 'Quater3') {
                    $newarray[] = 'qu3_fees';
                } else if ($value == 'Quater4') {
                    $newarray[] = 'qu4_fees';
                }

            }

            foreach ($newarray as $key => $iteam) {
                if (!in_array($iteam, $amount2[0])) {
                    $amount2[0][$iteam] = '';
                }

            }
            //pr($amount2);die;

            $findamount4month = $this->findamount4month($class_id, $acedamicyear);
            $findamount3month = $this->findamount3month($class_id, $acedamicyear);
            $findamount2month = $this->findamount2month($class_id, $acedamicyear);
            $findamount1month = $this->findamount1month($class_id, $acedamicyear);
            $student = $this->Students->find('all')->where(['Students.id' => $id, 'Students.status' => 'Y'])->first();
            $disfees = $student['dis_fees'];
            if ($disfees) {

                $netamount = $findamount4month['qu4_fees'] / 100 * $disfees;
                $findamount4month['qu4_fees'] = $findamount4month['qu4_fees'] - $netamount;

                $netamountt = $amount[0]['qu1_fees'] / 100 * $disfees;
                $amount[0]['qu1_fees'] = $amount[0]['qu1_fees'] - $netamountt;

                $discount += $netamountt;
                $netamountt3 = $amount2[0]['qu1_fees'] / 100 * $disfees;
                $amount2[0]['qu1_fees'] = $amount2[0]['qu1_fees'] - $netamountt3;

            }
            $findamount4month['qu4_fees'] = $findamount4month['qu4_fees'];

            if ($disfees) {
                $netamount2 = $findamount3month['qu3_fees'] / 100 * $disfees;
                $findamount3month['qu3_fees'] = $findamount3month['qu3_fees'] - $netamount2;

                $netamountto = $amount[0]['qu2_fees'] / 100 * $disfees;
                $amount[0]['qu2_fees'] = $amount[0]['qu2_fees'] - $netamountto;
                $discount += $netamountto;
                $netamountto3 = $amount2[0]['qu2_fees'] / 100 * $disfees;
                $amount2[0]['qu2_fees'] = $amount2[0]['qu2_fees'] - $netamountto3;

            }
            $findamount3month['qu3_fees'] = $findamount3month['qu3_fees'];
            if ($disfees) {
                $netamount3 = $findamount2month['qu2_fees'] / 100 * $disfees;
                $findamount2month['qu2_fees'] = $findamount2month['qu2_fees'] - $netamount3;

                $netamounttot = $amount[0]['qu3_fees'] / 100 * $disfees;
                $amount[0]['qu3_fees'] = $amount[0]['qu3_fees'] - $netamounttot;
                $discount += $netamounttot;
                $netamounttot3 = $amount2[0]['qu3_fees'] / 100 * $disfees;
                $amount2[0]['qu3_fees'] = $amount2[0]['qu3_fees'] - $netamounttot3;

            }
            $findamount2month['qu2_fees'] = $findamount2month['qu2_fees'];
            if ($disfees) {
                $netamount4 = $findamount1month['qu1_fees'] / 100 * $disfees;
                $findamount1month['qu1_fees'] = $findamount1month['qu1_fees'] - $netamount4;

                $netamounttotl = $amount[0]['qu4_fees'] / 100 * $disfees;
                $amount[0]['qu4_fees'] = $amount[0]['qu4_fees'] - $netamounttotl;
                $discount += $netamounttotl;
                $netamounttotl3 = $amount2[0]['qu4_fees'] / 100 * $disfees;
                $amount2[0]['qu4_fees'] = $amount2[0]['qu4_fees'] - $netamounttotl3;
            }

            $findamount1month['qu1_fees'] = $findamount1month['qu1_fees'];

            $total_class_fees = ($amount[0]['qu1_fees'] + $amount[0]['qu2_fees'] + $amount[0]['qu3_fees'] + $amount[0]['qu4_fees']);

            $findsum = $findamount4month['qu4_fees'] + $findamount3month['qu3_fees'] + $findamount2month['qu2_fees'] + $findamount1month['qu1_fees'];

            if ($findsum > $paidfeestotal) {
                $dueamt = $findsum - $paidfeestotal;
            }

            $total_due = ($total_class_fees - $paidfeestotal);
            //pr($total_due);die;
            $response["success"] = 1;
            $response["output"] = array();

            $product["totalfees"] = number_format($total_class_fees, 0, ',', '');
            // $product["paidfees"]=number_format($paidfeestotal,0,',','');
            //  $product["discount"]=number_format($discount,0,',','');
            //$dueamt= $dueamt-$discount;
            //$product["due_amount"]=number_format($dueamt,0,',','');
            //$total_due=$total_due-$discount;
            //  $product["outstanding_amount"]=number_format($total_due,0,',','');
            array_push($response["output"], $product);
            $response["totalfees"] = array();

            $t = array();
            //$response["outstanding"]=array();
            //$response["outstanding"]= $total_due;
            $s = array();
            // $response["duefee"]=array();
            $h = array();
            $paydate1 = array();
            $paid = $this->Studentfees->find('all')->where(['Studentfees.student_id' => $s_id, 'Studentfees.acedmicyear' => $acedamicyear])->toarray();
            //pr($paid);die;
            foreach ($paid as $paid_value) {

                $paid1 = unserialize($paid_value['quarter']);
                //pr($paid1);die;
                $paid1_keys = array();
                foreach ($paid1 as $paid1_key => $paid_valuess) {
                    $paid1_keys[] = $paid1_key;
                }

                $paydate1[$paid_value['id']] = $paid1_keys;

            }

            //pr($paydate);die;
            //    $cond = array();
            foreach ($paydate1 as $pay_key => $pay_value) {
                //pr($pay_value);
                if (in_array('Admission Fee', $pay_value) || in_array('Development Fee', $pay_value) || in_array('Miscellaneous Fee', $pay_value) || in_array('Quater1', $pay_value) || in_array('Caution Money', $pay_value)) {

                    $cond[] = $pay_key;
                }
            }
            //pr($cond);die;

            for ($i = 1; $i <= 4; $i++) {
                $key = "qu" . $i . "_fees";
                $date = "qu" . $i . "_date";
                $paydate = '';

                if ($amount[0][$key]) {

                    $t['Quater'] = "Quater" . $i;
                    $t['lastdate'] = date('d-m-Y', strtotime($amount[0][$date]));
                    $t['fee'] = number_format($amount[0][$key], 0, ',', '');
                    $paydate['paydate'] = '';
                    $t['paydate'] = '';
                    $t["mode"] = '';
                    $t['installment'] = 'Pending';

                    $t["challan_no"] = '';
                    $t["bank"] = '';
                    $t["cheque_no"] = '';

                    //$t["discount"] = $paydate['discount'];

                    $cond1 = '';
                    if (in_array($t['quarter'], $paydate_value)) {
                        echo "ok";die;
                        if ($t['quarter'] != 'Quater1') {
                            $cond1 = $cond;

                        } else {
                            $cond1 = $cond;
                        }
                        $paydate = $this->Studentfees->find('all')->where(['Studentfees.id IN' => $cond1])->first();

                        $t['paydate'] = date('d-m-Y', strtotime($value['paydate']));
                        $t['installment'] = 'Paid';

                        $t["mode"] = $paydate['mode'];
                        if ($t['mode'] == 'Cheque') {

                            $t["cheque_no"] = $paydate['cheque_no'];
                        } else {
                            $t["cheque_no"] = '';

                        }
                        if ($paydate['challan_no'] != '0') {
                            $t["challan_no"] = $paydate['challan_no'];
                        }
                        if ($paydate['bank_id'] != '0') {
                            $bank = $this->Banks->find('all')->where(['id' => $paydate['bank_id']])->first();
                            if ($bank['name'] != '') {
                                $t["bank"] = $bank['name'];
                            }
                        }
                        array_push($response["totalfees"], $t);
                    } else {
                        $t['paydate'] = '';

                        $t['installment'] = 'Pending';

                        array_push($response["totalfees"], $t);

                    }

                }

                if ($amount2[0][$key]) {

                    $s['Quater'] = "Quater" . $i;
                    $s['lastdate'] = date('d-m-Y', strtotime($amount2[0][$date]));
                    $s['fee'] = number_format($amount2[0][$key], 0, ',', '');
                    //array_push($response["outstanding"], $s);

                    if ($findamount1month[$key]) {

                        $h['Quater'] = "Quater" . $i;

                        $h['lastdate'] = date('d-m-Y', strtotime($findamount1month[$date]));
                        $h['fee'] = number_format($findamount1month[$key], 0, ',', '');

                        //array_push($response["duefee"], $h);
                    }

                    if ($findamount2month[$key]) {
                        $h['Quater'] = "Quater" . $i;
                        $h['lastdate'] = date('d-m-Y', strtotime($findamount2month[$date]));
                        $h['fee'] = number_format($findamount2month[$key], 0, ',', '');

                        //array_push($response["duefee"], $h);
                    }
                    if ($findamount3month[$key]) {

                        $h['Quater'] = "Quater" . $i;

                        $h['lastdate'] = date('d-m-Y', strtotime($findamount3month[$date]));
                        $h['fee'] = number_format($findamount3month[$key], 0, ',', '');

                        //array_push($response["duefee"], $h);
                    }
                    if ($findamount4month[$key]) {

                        $h['Quater'] = "Quater" . $i;

                        $h['lastdate'] = date('d-m-Y', strtotime($findamount4month[$date]));
                        $h['fee'] = number_format($findamount4month[$key], 0, ',', '');

                        //array_push($response["duefee"], $h);
                    }

                }
            }

            echo json_encode($response);

        }

    }

    public function receipt()
    {
        $this->loadmodel('Banks');
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $str = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($str) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $student = $this->Students->find('all')->where(['Students.id' => $str, 'Students.status' => 'Y'])->first();
            $acedamicyeard = $student['acedmicyear'];
            $student_datas = $this->Studentfees->find('all')->where(['Studentfees.student_id' => $student['id'], 'Studentfees.acedmicyear' => $acedamicyeard, 'Studentfees.status' => 'Y'])->toarray();

            $fees = $student_datas[0]['fee'];
            if (!empty($fees) && isset($fees)) {
                $response["success"] = 1;
                $response["output"] = array();
                $quas = array();
                foreach ($student_datas as $value) {

                    if ($value['recipetno'] != '0') {

                        $product["receipt_no"] = $value['recipetno'];

                        $product["paydate"] = date('d-m-Y', strtotime($value['paydate']));
                        $quas = unserialize($value['quarter']);
                        $quter = array();

                        $muy = 0;
                        foreach ($quas as $iteam['quarter'] => $iteam['amount']) {
                            if ($iteam['quarter'] == 'Quater1') {

                                $muy++;
                                $quter[] = "First Quarter(April-June)" . ": Paid";

                            } else if ($iteam['quarter'] == 'Quater2') {

                                $muy++;
                                $quter[] = "Second Quarter (July-Sept)" . ": Paid";

                            } else if ($iteam['quarter'] == 'Quater3') {

                                $muy++;
                                $quter[] = "Third Quarter  (Oct-Dec)" . ": Paid";

                            } else if ($iteam['quarter'] == 'Quater4') {
                                $muy++;
                                $quter[] = "Fourth Quarter  (Jan-March)" . ": Paid";

                            } else if ($iteam['quarter'] == 'Admission Fee') {
                                $muy++;
                                $quter[] = "Admission Fee" . ": Paid";

                            } else if ($iteam['quarter'] == 'Development Fee') {
                                $muy++;
                                $quter[] = "Development Fee" . ": Paid";

                            } else if ($iteam['quarter'] == 'Development Fee') {
                                $muy++;
                                $quter[] = "Development Fee" . ": Paid";

                            } else if ($iteam['quarter'] == 'Caution Money') {
                                $muy++;
                                $quter[] = "Caution Money" . ": Paid";

                            } else if ($iteam['quarter'] == 'Miscellaneous Fee') {
                                $muy++;
                                $quter[] = "Miscellaneous Fee" . ": Paid";

                            }

                        }

                        $product["description"] = implode(", ", $quter);
                        $product["fee"] = number_format($value['deposite_amt'], 0, ',', '');

                        $product["mode"] = $value['mode'];

                        if ($value['cheque_no'] != '0') {

                            $product["cheque_no"] = $value['cheque_no'];
                        } else {

                            $product["cheque_no"] = null;

                        }

                        if ($value['bank'] != '') {

                            $product["bank"] = $value['bank'];

                        } else {
                            $product["bank"] = null;

                        }
                        array_push($response["output"], $product);

                    }
                }
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "You have not submitted any fees";
                echo json_encode($response);

            }
        }

    }

    public function findpendingrefrencefee($id, $amt)
    {

        $articles = TableRegistry::get('Studentfeepending');
        return $articles->find('all')->where(['Studentfeepending.r_id' => $id, 'Studentfeepending.amt' => $amt])->first();

    }

    public function timeTable()
    {
        //$this->loadmodel('ClasstimeTabs');
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $class = $postData->class;
            $section = $postData->section;
            $idsprimeID = $postData->idsprimeID;
            if (empty($class) || empty($section) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = array();
            $product = array();
            $classtitle = $this->Classes->find('all')->select(['id'])->where(['title' => $class])->order(['title' => 'Asc'])->first()->toArray();
            $sectiontitle = $this->Sections->find('all')->select(['id'])->where(['title' => $section])->order(['title' => 'Asc'])->first()->toArray();
            $class = $classtitle['id'];
            $section = $sectiontitle['id'];
            //  $section='10';
            $sectionss = $this->Classections->find('all')->where(['Classections.class_id' => $class, 'Classections.section_id' => $section])->toArray();
            $is_break = $this->Timetables->find('all')->select(['is_break', 'time_from', 'time_to'])->where(['Timetables.is_break' => 1])->toArray();
//    pr($is_break); die;
            $break_time_from = $is_break[0]['time_from'];
            $time_to = $is_break[0]['time_to'];
            $class = $sectionss[0]['id'];
            $timetable_datas = $this->ClasstimeTabs->find('all')->where(['ClasstimeTabs.class_id' => $class])->contain(['Timetables', 'Employees', 'Subjects'])->order(['ClasstimeTabs.id' => 'Asc'])->count();
            if ($timetable_datas > 0) {
                $timetable_data = $this->ClasstimeTabs->find('all')->where(['ClasstimeTabs.class_id' => $class])->contain(['Timetables', 'Employees', 'Subjects'])->order(['ClasstimeTabs.id' => 'Asc'])->toarray();

                $response["success"] = 1;
                $response["break_start"] = $break_time_from;
                $response["break_close"] = $time_to;
                $response["output"] = array();

                foreach ($timetable_data as $values) {
                    $product["weekday"] = $values['weekday'];
                    $product["subjects"] = $values['Subjects']['name'];
                    $product["alias"] = $values['Subjects']['alias'];
                    $product["employees"] = $values['Employees']['fname'];
                    $product["time_from"] = $values['Timetables']['time_from'];
                    $product["time_to"] = $values['Timetables']['time_to'];
                    array_push($response["output"], $product);
                }
                echo json_encode($response);

            } else {
                $response["success"] = 0;
                echo json_encode($response);
            }

        }
    }
    public function findtransporttotalamount($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Transportfees');

// Start a new query.

        return $articles->find('all')->group('Transportfees.academic_year')->group('Transportfees.loc_id')->select(['id' => $articles->find('all'), 'fee' => $articles->find('all'), 'discount' => $articles->find('all'), 'amount' => $articles->find('all'), 'quarter' => $articles->find('all')])->where(['Transportfees.loc_id' => $id, 'Transportfees.academic_year' => $a_year])->order(['Transportfees.id' => 'ASC'])->toArray();
    }
    public function transport()
    {
        $this->autoRender = false;
        $response = array();
        $product = array();
        if (isset($_POST) && !empty($_POST)) {
            $id = $_POST["enroll_no"];
            $student_id = ltrim($id, 'S');
            $acedmicyear = "2017-18";
//$student_id='12011';
            $student = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->first()->toArray();
            // $student_trans = $this->StudentTransfees->find('all')->where(['StudentTransfees.student_id' => $student_id ,'StudentTransfees.acedmicyear' => $acedmicyear])->toarray();
            //print_r($student_trans);
            $is_transport = $student['is_transport'];
            $location_id = $student['transportloc_id'];
            $acedmicyear = $student['acedmicyear'];
            $amount = $this->findtransportamount($location_id, $acedmicyear);
            //print_r($amount); die;

            $discount = 0;
            $disfees = $student['dis_fees'];

            if ($disfees) {

                $netamount = $amount[0]['qu1_fees'] / 100 * $disfees;
                $discount += $netamount;
                $amount[0]['qu1_fees'] = $amount[0]['qu1_fees'] - $netamount;
                $netamounte = $amount[0]['qu2_fees'] / 100 * $disfees;
                $amount[0]['qu2_fees'] = $amount[0]['qu2_fees'] - $netamounte;
                $discount += $netamounte;
                $netamount2e = $amount[0]['qu3_fees'] / 100 * $disfees;
                $amount[0]['qu3_fees'] = $amount[0]['qu3_fees'] - $netamount2e;
                $discount += $netamount2e;
                $netamount2es = $amount[0]['qu4_fees'] / 100 * $disfees;
                $amount[0]['qu4_fees'] = $amount[0]['qu4_fees'] - $netamount2es;
                $discount += $netamount2es;
            }

            $total = $amount[0]['qu1_fees'] + $amount[0]['qu2_fees'] + $amount[0]['qu3_fees'] + $amount[0]['qu4_fees'];

            $paidamount = $this->findpaidtransportamount($student_id, $acedmicyear);
            //  print_r($paidamount); die;

            $total1 = 0;
            foreach ($paidamount as $key => $value) {
                $total1 += number_format($value['fee'], 0, ',', '');

            }
            $outstanding_amount = $total - $total1;
            if ($is_transport == "1" && !empty($location_id)) {
                $response["success"] = 1;
                $response["output"] = array();
                $loc = $this->Locations->find('all')->where(['id' => $location_id])->first()->toArray();
                $route = $this->findroute($location_id);
                $product["location"] = $loc['name'];
                $product["vechical_no"] = $route[0]['vechical_no'];
                $product["driver_name"] = $route[0]['driver_name'];
                $product["driver_mobile"] = $route[0]['driver_mobile'];
                $product["discount"] = $discount;

                $product["total_transport_fees"] = number_format($total, 0, ',', '');
                $product["total_transport_paidfees"] = $total1;
                $product["outstanding_amount"] = number_format($outstanding_amount, 0, ',', '');
                array_push($response["output"], $product);
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "No Transport Assign";
                echo json_encode($response);

            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }

    }
    public function changePassword()
    {
        $this->autoRender = false;
        $response = array();
        if (isset($_POST) && !empty($_POST)) {
            $student_id = $_POST["id"];

            $password = $_POST["newPassword"];

            $student = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->first();

            //$mobile = $student['sms_mobile'];
            $mobile = "8233172526";
            $hasher = new DefaultPasswordHasher();
            $newpassword = $hasher->hash($password);
            //$oldhashpass = $hasher->hash($oldPass);
            $board_id = $student['board_id'];
            $enroll = $student['enroll'];
            if ($board_id == '1') {
                $enroll = "C" . $enroll;
            } else if ($board_id == '2') {
                $enroll = "CAM" . $enroll;
            } else if ($board_id == '3') {
                $enroll = "IB" . $enroll;
            }
            $this->request->data['email'] = $enroll;
            $this->request->data['password'] = $_POST["password"];
            $exist = $this->Auth->identify($this->request->data);

            if ($exist) {
                $email = $this->Users->find('all')->where(['email' => $enroll, 'role_id' => '2'])->toarray();

                if (!empty($email)) {
                    $conn = ConnectionManager::get('default');
                    $detail = 'UPDATE `users` SET `password` ="' . $newpassword . '",`confirm_pass` ="' . $password . '" WHERE `email` = "' . $enroll . '"';
                    $conn->execute($detail);
                    $mesg = "Thanks for Register on School Erp.Your New Password is " . $password . " Call :9829732221 for Support";
                    $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));
                    $response["success"] = 1;
                    echo json_encode($response);
                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not A Registered Student";
                    echo json_encode($response);
                }
            } else {
                $response["success"] = 0;
                $response["message"] = "Wrong Existing Password";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }
    }
    public function updateToken()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $roll = $postData->roll;
            $student_id = $postData->enroll;
            $token = $postData->token;
            $idsprimeID = $postData->idsprimeID;
            if (empty($roll) || empty($student_id) || empty($token) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = array();
            if ($roll == "Student") {
                //echo $roll;
                //echo $token; die;
                $enroll = ltrim($student_id, 'S');
                //echo $enroll; die;
                $detail = 'UPDATE `students` SET `token` ="' . $token . '" WHERE `id` = "' . $enroll . '"';
                //echo $detail;
                //$detail="UPDATE  `silvelwh_idsprime`.`students` SET  `token` =  '12345' WHERE  `students`.`id` =12004";
                $conn = ConnectionManager::get('default');

                $conn->execute($detail);
                //$data=$this->Students->query($detail);
                //echo $data; die;
                //$detail="UPDATE  `silvelwh_idsprime`.`students` SET  `token` =  'vipin' WHERE  `students`.`id` =12004";
                $response["success"] = 1;
            } else if ($roll == "Teacher") {
                $this->Employees->query("update employee set token='" . $token . "' where email=" . $student_id);
                $response["success"] = 1;
            } else {
                $response["success"] = 0;
            }
            echo json_encode($response);
        }
    }
    public function transportReceipt()
    {

        $this->loadmodel('Banks');
        $this->loadmodel('StudentTransfees');
        $this->autoRender = false;
        $response = array();
        if (isset($_POST) && !empty($_POST)) {
            $id = $_POST["enroll_no"];
            $enroll = ltrim($id, 'S');
            $acedamicyeard = $_POST["acedamicyear"];
            $paidamount = $this->findpaidtransportamount($enroll, $acedamicyeard);
            //  pr($paidamount); die;
            //$paidamount=$this->find('all')->where(['StudentTransfees.student_id' =>$enroll ,'StudentTransfees.acedmicyear' =>$acedamicyeard]);
            // pr($paidamount); die;
            if (count($paidamount) > 0) {
                $response["success"] = 1;
                $response["output"] = array();
                foreach ($paidamount as $value) {
                    $product["receipt_no"] = $value['id'];
                    $product["paydate"] = date('d-m-Y', strtotime($value['paydate']));
                    $product["quarter"] = $value['quarter'];
                    $product["amount"] = $value['amount'];
                    $product["fee"] = number_format($value['fee'], 0, ',', '');
                    if ($value['discount'] != '0') {
                        $product["discount"] = $value['discount'];
                    }
                    $product["mode"] = $value['mode'];
                    if ($value['mode'] == 'Cheque') {

                        $product["cheque_no"] = $value['cheque_no'];
                    }
                    if ($value['challan_no'] != '0') {
                        $product["challan_no"] = $value['challan_no'];
                    }
                    if ($value['bank_id'] != '0') {
                        $bank = $this->Banks->find('all')->where(['id' => $value['bank_id']])->first();
                        if ($bank['name'] != '') {
                            $product["bank"] = $bank['name'];
                        }
                    }
                    array_push($response["output"], $product);
                }
                echo json_encode($response);
            } else {
                $response["message"] = "You have Not submit Any Quarter Fees";
                echo json_encode($response);

            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }

    }

    public function forgot()
    {
        $this->autoRender = false;
        $response = array();
        if (isset($_POST) && !empty($_POST)) {
            //pr($_POST); die;;
            //$student_id = $_POST["enroll_no"];
            $mobile = $_POST["mobile"];
            //$student_id="S12007";
            if (strpos($student_id, 'CAM') !== false) {
                $enroll = ltrim($student_id, 'CAM');
                $bid = "2";
            } elseif (strpos($student_id, 'IB') !== false) {
                $enroll = ltrim($student_id, 'IB');
                $bid = "3";

            } else {

                $enroll = ltrim($student_id, 'C');

                $bid = "1";
            }

            //$count = $this->Students->find('all')->where(['Students.id' => $enroll, 'Students.board_id' => $bid, 'Students.status' => 'Y'])->count();
            $students = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.sms_mobile' => $mobile])->toarray();
            //pr($students);; die;;
            if (!empty($students)) {

                //$mobile = $student['sms_mobile'];
                $mobile = "8233172526";
                $data['otp'] = rand(1001, 9999);
                $success = 0;
                foreach ($students as $student) {
                    if ($student['board_id'] == '1') {
                        $email = 'C' . $student['enroll'];
                    } else if ($student['board_id'] == '2') {
                        $email = 'CAM' . $student['enroll'];
                    } else {
                        $email = 'IB' . $student['enroll'];
                    }

                    $user = $this->Users->find('all')->where(['email' => $email])->first();
                    //pr($user); die;
                    $patch = $this->Users->patchEntity($user, $data);
                    $users = $this->Users->save($patch);
                    $userId[] = $users->id;
                    if ($users) {
                        $success = 1;
                    }
                }
                if ($success == 1) {
                    $mesg = "Your One Time Password for Sanskar School  is " . $data['otp'];
                    $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

                    $response["success"] = 1;
                    $response["UserId"] = $userId;
                    $response["mobile"] = $mobile;

                    $response["message"] = "OTP send successfully to registered mobile number";

                } else {
                    $response["success"] = 0;
                    $response["message"] = "Error In sending OTP. Please Try Again";

                }

                echo json_encode($response);

            } else {

                $response["success"] = 0;
                $response["message"] = "You Are Not A Registered Student";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);

        }

    }
    public function resetpassword()
    {
        $this->autoRender = false;
        if ($this->request->is('post')) {
            $id = $_POST['userId'];
            $otp = $_POST['otp'];
            $mobile = $_POST['mobile'];
            $users = explode(',', $id);
            foreach ($users as $user) {
                $det = $this->Users->get($user);
                //pr($otp); die;
                if ($otp == $det['otp']) {

                    $password = bin2hex(random_bytes(3));
                    $hasher = new DefaultPasswordHasher();
                    $newpassword = $hasher->hash($password);
                    $conn = ConnectionManager::get('default');
                    $detail = 'UPDATE `users` SET `password` ="' . $newpassword . '",`confirm_pass` ="' . $password . '" WHERE `id` = "' . $user . '"';
                    $conn->execute($detail);
                    //pr($mobile); die;
                    $mesg = "Thanks for Register on School Erp.Your New Password is " . $password . " Call :9829732221 for Support";
                    $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));
                    $response["success"] = 1;
                    $response["message"] = "A New Password has been sent to your registered mobile number";
                    echo json_encode($response);
                    break;
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Invalid OTP";
                    echo json_encode($response);

                }

            }

        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);

        }
    }

    public function hostel()
    {
        $this->autoRender = false;
        $response = array();
        $product = array();
        $this->loadmodel('Banks');
        if (isset($_POST) && !empty($_POST)) {
            $student_id = $_POST["enroll_no"];
            //$student_id='12011';
            $enroll = ltrim($student_id, 'S');
            $student = $this->Students->find('all')->where(['Students.id' => $enroll, 'Students.status' => 'Y'])->first()->toArray();
            $is_hostel = $student['is_hostel'];
            $hostel_id = $student['h_id'];

            $disfees = $student['dis_fees'];

            if ($is_hostel == "1" && !empty($hostel_id)) {
                $hostel = $this->Hostels->find('all')->where(['Hostels.id' => $hostel_id])->first()->toArray();
                $hostel_name = $hostel['name'];
                $hostel_room_no = $student['room_no'];
                $wardenname = $hostel['wardenname'];
                $w_mobile = $hostel['w_mobile'];
                $total_hostel_fees = $hostel['fees'];
                $paidamount = $this->findhostelamount($student['id'], $student['acedmicyear'], $hostel_id);
                // print_r($paidamount); die;
                $netamount = $total_hostel_fees / 100 * $disfees;
                $total_hostel_fees = $total_hostel_fees - $netamount;
                $paid_hostel_fees = $paidamount['0']['fee'];
                $discount = $paidamount['0']['discount'];

                $response["success"] = 1;
                $response["output"] = array();
                $product["hostel_name"] = $hostel_name;
                $product["mode"] = $paidamount['0']['mode'];
                $product["cheque_no"] = $paidamount['0']['cheque_no'];
                $product["receipt_no"] = $paidamount['0']['id'];
                $product["challan_no"] = $paidamount['0']['challan_no'];
                $product["paydate"] = date('d-m-Y', strtotime($paidamount['0']['paydate']));
                //  $product["created"]=$paidamount['0']['created']['time'];

                $bank = $this->Banks->find('all')->where(['id' => $paidamount['0']['bank_id']])->first()->toArray();
                // print_r($bank);die;
                if ($bank['name'] != '') {
                    $product["bank"] = $bank['name'];
                }

                $product["room_no"] = $hostel_room_no;
                $product["wardenname"] = $wardenname;
                $product["w_mobile"] = $w_mobile;
                $product["total_hostel_fees"] = number_format($total_hostel_fees, 0, ',', '');
                $product["paid_hostel_fees"] = number_format($paid_hostel_fees, 0, ',', '');
                $product["discount"] = $netamount;
                array_push($response["output"], $product);
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "No Hostel Assign";
                echo json_encode($response);

            }

        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }

    }

    public function searchbooklibrary()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $student_id = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($student_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = array();
            $product = array();
            $counts = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->count();
            if ($counts > 0) {
                $student = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->order(['Students.id' => 'DESC'])->first();
                //pr($student['board_id']);die;
                $b = $student['board_id'];
                if (empty($student['middlename'])) {
                    $name = $student['fname'] . " " . $student['lname'];
                } else {
                    $name = $student['fname'] . " " . $student['middlename'] . " " . $student['lname'];
                }

                //echo $name; die;
                $enroll = $student['enroll'];
                //echo $b;
                //echo $compete_name;die;
                $count = $this->IssueBook->find('all')->where(['IssueBook.holder_id' => $enroll, 'IssueBook.board' => $b, 'IssueBook.status' => 'Y'])->count();
                //echo $count;die;
                if ($count > 0) {
                    $student_issus_book = $this->IssueBook->find('all')->where(['IssueBook.holder_id' => $enroll, 'IssueBook.board' => $b, 'IssueBook.status' => 'Y'])->order(['IssueBook.id' => 'DESC'])->toArray();
                    $response["success"] = 1;
                    $response["output"] = array();

                    foreach ($student_issus_book as $value) {

                        $issue_date = strftime('%d-%b-%Y', strtotime($value['issue_date']));
                        $due_date = strftime('%d-%b-%Y', strtotime($value['due_date']));
                        $assn_no = $this->findbookid($value['asn_no2']);

                        //$fine = $this->findfine($value['asn_no2'], $enroll);
                        foreach ($assn_no as $valued) {
                            $book_id = $valued['book_id'];
                            $book = $this->findbook($book_id);

                            //echo $book[0]['name'];
                            $product["issue_date"] = $issue_date;
                            $product["due_date"] = $due_date;
                            $product["book_name"] = $book[0]['name'];

                            array_push($response["output"], $product);
                        }

                    }
                    echo json_encode($response);
                } else {
                    $response["success"] = 1;
                    $response["output"] = null;
                    $response["message"] = "No Issued Any Book From Library";
                    echo json_encode($response);
                }

            }
        }

    }

    public function library()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $student_id = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($student_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = array();
            $product = array();
//$student_id="S12048";
            //$enroll = ltrim($student_id, 'S');
            $student = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->order(['Students.id' => 'DESC'])->first();
            //$counts = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->count();
            //pr($counts);die;
            if (!empty($student)) {

                //pr($student['board_id']);die;
                $b = $student['board_id'];
                if (empty($student['middlename'])) {
                    $name = $student['fname'] . " " . $student['lname'];
                } else {
                    $name = $student['fname'] . " " . $student['middlename'] . " " . $student['lname'];
                }

                //echo $name; die;
                $enroll = $student['enroll'];
                //echo $b;
                //echo $compete_name;die;
                $count = $this->IssueBook->find('all')->where(['IssueBook.holder_id' => $enroll, 'IssueBook.board' => $b, 'IssueBook.status' => 'Y'])->count();
                //echo $count;die;
                if ($count > 0) {
                    $student_issus_book = $this->IssueBook->find('all')->where(['IssueBook.holder_id' => $enroll, 'IssueBook.board' => $b, 'IssueBook.status' => 'Y'])->order(['IssueBook.id' => 'DESC'])->toArray();
                    $response["success"] = 1;
                    $response["output"] = array();

                    foreach ($student_issus_book as $value) {

                        $issue_date = strftime('%d-%b-%Y', strtotime($value['issue_date']));
                        $due_date = strftime('%d-%b-%Y', strtotime($value['due_date']));
                        $assn_no = $this->findbookid($value['asn_no2']);

                        //$fine = $this->findfine($value['asn_no2'], $enroll);
                        foreach ($assn_no as $valued) {
                            $book_id = $valued['book_id'];
                            $book = $this->findbook($book_id);

                            //echo $book[0]['name'];
                            $product["issue_date"] = $issue_date;
                            $product["due_date"] = $due_date;
                            $product["book_name"] = $book[0]['name'];

                            array_push($response["output"], $product);
                        }

                    }
                    echo json_encode($response);
                } else {
                    $response["success"] = 1;
                    $response["output"] = null;
                    $response["message"] = "Not Issued Any Book From Library";
                    echo json_encode($response);
                }

            } else {
                $response["success"] = 0;
                $response["message"] = "Invalid Post Parameter";
                echo json_encode($response);

            }
        }

    }

    public function resultsearch()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else if (1 == 2) {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $student_id = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($student_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = array();
            $product = array();
            $date = date('Y-m-d H:i:s');
            // if (isset($_POST) && !empty($_POST)) {

            $counts = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->count();
            if ($counts > 0) {
                $student = $this->Students->find('all')->where(['Students.id' => $student_id, 'Students.status' => 'Y'])->order(['Students.id' => 'DESC'])->first();

                $b = $student['board_id'];
                if (empty($student['middlename'])) {
                    $name = $student['fname'] . " " . $student['lname'];
                } else {
                    $name = $student['fname'] . " " . $student['middlename'] . " " . $student['lname'];
                }
                $pyp = [18, 19, 1, 2, 3, 4, 6];

                if (in_array($student['class_id'], $pyp)) {
                    $c = 0;
                    $response["success"] = 1;
                    $response["output"] = array();
                    $classes = implode(',', $pyp);
                    $exam_type2 = $this->Examtypes->find('all')->where(['Examtypes.class_id' => $classes, 'Examtypes.examname' => 'Term1(Vatika to V)', 'Examtypes.term' => 2])->first();

                    $exam_id2 = $this->Exams->find('all')->where(['FIND_IN_SET(\'' . $exam_type2['id'] . '\',Exams.e_type_id)', 'acedamicyear' => $student['acedmicyear']])->first();
                    $res_date2 = date('Y-m-d', strtotime($exam_id2['resultdeclare_date'])) . " 08:00:00";
                    if (!empty($exam_type2) && strtotime($res_date2) <= strtotime($date)) {
                        $studentclass = $this->findclass($student['class_id']);
                        $studentsection = $this->findsections($student['section_id']);
                        $product["examname"] = "Half Yearly";
                        $product["class"] = $studentclass['title'] . '-' . $studentsection['title'];
                        $product["resultdeclare"] = strftime('%d-%b-%Y', strtotime($exam_id['resultdeclare_date']));
                        $prms = base64_encode($student['class_id'] . '/' . $student['section_id'] . '/' . $student['id'] . '/' . $exam_id2['id']);

                        $product["link"] = ADMIN_URL . 'Primarycentral/printsreportcard/' . $prms;

                        array_push($response["output"], $product);
                        $c = 1;

                    }
                    $exam_type = $this->Examtypes->find('all')->where(['Examtypes.class_id' => $classes, 'Examtypes.examname' => 'Term1(Vatika to V)', 'Examtypes.term' => 1])->first();

                    $exam_id = $this->Exams->find('all')->where(['FIND_IN_SET(\'' . $exam_type['id'] . '\',Exams.e_type_id)', 'acedamicyear' => $student['acedmicyear']])->first();
                    $res_date1 = date('Y-m-d', strtotime($exam_id['resultdeclare_date'])) . " 08:00:00";
                    if (!empty($exam_type) && strtotime($res_date1) <= strtotime($date)) {
                        $studentclass = $this->findclass($student['class_id']);
                        $studentsection = $this->findsections($student['section_id']);
                        $product["examname"] = "Annual";
                        $product["class"] = $studentclass['title'] . '-' . $studentsection['title'];
                        $product["resultdeclare"] = strftime('%d-%b-%Y', strtotime($exam_id['resultdeclare_date']));
                        $prms = base64_encode($student['class_id'] . '/' . $student['section_id'] . '/' . $student['id'] . '/' . $exam_id['id']);

                        $product["link"] = ADMIN_URL . 'Primarycentral/printsreportcard/' . $prms;

                        array_push($response["output"], $product);
                        $c = 1;

                    }
                    if ($c == 1) {
                        echo json_encode($response);
                    } else {
                        $response["success"] = 1;
                        $response["output"] = null;
                        $response["message"] = "No exam result found for this class !";
                        echo json_encode($response);
                    }
                } else {
                    $count = $this->Studentexamresult->find('all')->where(['Studentexamresult.stud_id' => $student_id, 'Studentexamresult.class_id' => $student['class_id'], 'Studentexamresult.sect_id' => $student['section_id']])->count();

                    $student_exam_result = $this->Studentexamresult->find('all')->contain(['Exams'])->where(['Studentexamresult.stud_id' => $student_id, 'Studentexamresult.class_id' => $student['class_id'], 'Studentexamresult.sect_id' => $student['section_id'], 'Studentexamresult.term' => '1'])->first();
                    //pr($student_exam_result); die;

                    $student_exam_result2 = $this->Studentexamresult->find('all')->where(['Studentexamresult.stud_id' => $student_id, 'Studentexamresult.class_id' => $student['class_id'], 'Studentexamresult.sect_id' => $student['section_id'], 'Studentexamresult.term' => '2'])->first();
                    //pr($student_exam_result); die;
                    $examfind = $this->Exams->find('all')->where(['Exams.id' => $student_exam_result['exam_id'], 'Exams.acedamicyear' => $student['acedmicyear']])->order(['Exams.id' => 'DESC'])->first();
                    //pr($examfind); die;
                    $res_date1 = date('Y-m-d', strtotime($examfind['resultdeclare_date'])) . " 08:00:00";
                    $examfind2 = $this->Exams->find('all')->where(['Exams.id' => $student_exam_result2['exam_id'], 'Exams.acedamicyear' => $student['acedmicyear']])->order(['Exams.id' => 'DESC'])->first();
                    $res_date2 = date('Y-m-d', strtotime($examfind['resultdeclare_date'])) . " 08:00:00";
                    if ($examfind['id'] && strtotime($res_date1) <= strtotime($date)) {
                        $response["success"] = 1;
                        $response["output"] = array();
                        $studentclass = $this->findclass($student_exam_result['class_id']);
                        $studentsection = $this->findsections($student_exam_result['sect_id']);
                        $product["examname"] = "Half Yearly";
                        $product["class"] = $studentclass['title'] . '-' . $studentsection['title'];
                        $product["resultdeclare"] = strftime('%d-%b-%Y', strtotime($examfind['resultdeclare_date']));

                        if ($student_exam_result['class_id'] == '7' || $student_exam_result['class_id'] == '8' || $student_exam_result['class_id'] == '9') {
                            $product["link"] = ADMIN_URL . 'studentexamresult/resultall/' . $student_exam_result['class_id'] . '/' . $student_exam_result['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result['stud_id'];

                        } else if ($student_exam_result['class_id'] == '10' || $student_exam_result['class_id'] == '11') {

                            $product["link"] = ADMIN_URL . 'studentexamresult/resultallixx/' . $student_exam_result['class_id'] . '/' . $student_exam_result['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result['stud_id'];

                        } else if ($student_exam_result['class_id'] == '23' || $student_exam_result['class_id'] == '24') {

                            $product["link"] = ADMIN_URL . 'studentexamresult/resultallcam/' . $student_exam_result['class_id'] . '/' . $student_exam_result['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result['stud_id'];

                        } else if ($student_exam_result['class_id'] == '25') {

                            $product["link"] = ADMIN_URL . 'studentexamresult/resultallcamnine/' . $student_exam_result['class_id'] . '/' . $student_exam_result['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result['stud_id'];

                        } else {
                            $product["link"] = ADMIN_URL . 'studentexamresult/resultallscience/' . $student_exam_result['class_id'] . '/' . $student_exam_result['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result['stud_id'];

                        }

                        array_push($response["output"], $product);
                        if ($examfind2['id'] && strtotime($res_date2) <= strtotime($date)) {
                            $product["examname"] = "Anuual";
                            $product["class"] = $studentclass['title'] . '-' . $studentsection['title'];
                            $product["resultdeclare"] = strftime('%d-%b-%Y', strtotime($examfind2['resultdeclare_date']));

                            if ($student_exam_result2['class_id'] == '7' || $student_exam_result2['class_id'] == '8' || $student_exam_result2['class_id'] == '9') {
                                $product["link"] = ADMIN_URL . 'studentexamresult/resultall2/' . $student_exam_result2['class_id'] . '/' . $student_exam_result2['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result2['stud_id'];

                            } else if ($student_exam_result2['class_id'] == '10' || $student_exam_result2['class_id'] == '11') {

                                $product["link"] = ADMIN_URL . 'studentexamresult/resultallixx2/' . $student_exam_result2['class_id'] . '/' . $student_exam_result2['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result2['stud_id'];

                            } else if ($student_exam_result2['class_id'] == '23' || $student_exam_result2['class_id'] == '24') {

                                $product["link"] = ADMIN_URL . 'studentexamresult/resultallcam2/' . $student_exam_result2['class_id'] . '/' . $student_exam_result2['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result2['stud_id'];

                            } else if ($student_exam_result2['class_id'] == '25') {

                                $product["link"] = ADMIN_URL . 'studentexamresult/resultallcamnine2/' . $student_exam_result2['class_id'] . '/' . $student_exam_result2['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result2['stud_id'];

                            } else {
                                $product["link"] = ADMIN_URL . 'studentexamresult/resultallscience2/' . $student_exam_result2['class_id'] . '/' . $student_exam_result2['sect_id'] . '/' . $examfind['acedamicyear'] . '/' . $student_exam_result2['stud_id'];

                            }

                            // array_push($response["output"], $product);
                        }

                        echo json_encode($response);
                    } else {
                        $response["success"] = 1;
                        $response["output"] = null;
                        $response["message"] = "No exam result found for this class !";
                        echo json_encode($response);
                    }

                }
            } else {
                $response["success"] = 0;
                $response["message"] = "No Registered Student Found";
                $response["output"] = null;
                echo json_encode($response);

            }
        } else {
            $response["success"] = 1;
            $response["message"] = "Page under maintenance";
            $response["output"] = null;
            echo json_encode($response);

        }

    }

    public function holidays()
    {
        $this->autoRender = false;
        $response = array();
        $product = array();
        $event = $this->Events->find('all')->where(['Events.eventt' => '8'])->contain(['Eventtypes'])->toArray();
        $colorcode = '';
        $response["success"] = 1;
        $response["output"] = array();
        foreach ($event as $key => $iteam) {
            $id = $iteam['id'];
            $title = $iteam['title'];
            $desc = $iteam['detail'];
            $starttime = date('d-m-Y h:i:s a', strtotime($iteam['starttime']));
            $endtime = date('d-m-Y h:i:s', strtotime($iteam['endtime']));
            //$colorcode = $iteam['eventtype']['colorcode'];
            $eventypename = $iteam['eventtype']['name'];
            $product["id"] = $id;
            $product["title"] = $title;
            $product["description"] = $desc;
            $product["event_type"] = $eventypename;
            $product["start"] = $starttime;
            $product["end"] = $endtime;
            //$product["color"] = $colorcode;
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

//-----------------------------------------------------------
    public function viewevents()
    {

        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $period = $postData->date;
            $idsprimeID = $postData->idsprimeID;
            if (empty($period) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            if (empty($period)) {
                $period = date('m-Y');
            }
            $expDate = explode('-', $period);
            $month = $expDate[0];
            $year = $expDate[1];

            $response = array();
            $product = array();
            $event_exist = 0;
            $d = cal_days_in_month(CAL_GREGORIAN, $month, $year);
            $colorcode = '';
            $response["success"] = 1;
            $response["output"] = array();
            for ($i = 1; $i <= $d; $i++) {
                $date_src = $year . '-' . $month . '-' . $i;
                $date_src = date('Y-m-d', strtotime($date_src));
                //echo $date_src;
                $iteam = $this->Events->find('all')->where(['Events.eventt !=' => '13', 'DATE(starttime) <=' => $date_src, 'DATE(endtime) >= ' => $date_src])->contain(['Eventtypes'])->first();
                //pr($iteam);
                if (!empty($iteam)) {
                    $event_exist = 1;
                    $id = $iteam['id'];
                    $title = $iteam['title'];
                    $desc = $iteam['detail'];
                    $starttime = date('Y-m-d', strtotime($date_src));
                    $endtime = date('Y-m-d', strtotime($date_src));
                    $colorcode = $iteam['eventtype']['colorcode'];
                    $eventypename = $iteam['eventtype']['name'];

                    $product["id"] = $id;
                    $product["title"] = $title;
                    $product["description"] = $desc;
                    $product["event_type"] = $eventypename;
                    $product["start"] = $starttime;
                    $product["end"] = $endtime;
                    $product["color"] = $colorcode;
                    array_push($response["output"], $product);
                }
            }
            //pr($event); die;
            //$event=$this->Events->find('all')->contain(['Eventtypes'])->toArray();
            if ($event_exist == 0) {
                $response["success"] = 1;
                $response["output"] = array();
                $response['message'] = "No Events in this Month";
            }

            echo json_encode($response);
        }
    }
//-----------------------------------------------------------

    public function eventtype()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $idsprimeID = $postData->idsprimeID;
            if (empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = array();
            $product = array();
            //    $event=$this->Events->find('all')->where(['Events.eventt NOT IN'=>array('8','10')])->contain(['Eventtypes'])->toArray();
            //$events=$this->Eventtypes->find('all')->toArray();
            $events = $this->Eventtypes->find('all')->where(['Eventtypes.id !=' => '13'])->toArray();
            $response["success"] = 1;
            $response["output"] = array();
            foreach ($events as $key => $iteam) {

                $product["id"] = $iteam['id'];
                $product["name"] = $iteam['name'];
                $product["colorcode"] = $iteam['colorcode'];
                array_push($response["output"], $product);
            }
            echo json_encode($response);
        }

    }

    public function eventtypenotice()
    {

        $this->autoRender = false;
        $response = array();
        $product = array();
        //    $event=$this->Events->find('all')->where(['Events.eventt NOT IN'=>array('8','10')])->contain(['Eventtypes'])->toArray();
        //$events=$this->Eventtypes->find('all')->toArray();
        $events = $this->Eventtypes->find('all')->toArray();
        $response["success"] = 1;
        $response["output"] = array();
        foreach ($events as $key => $iteam) {

            $product["id"] = $iteam['id'];
            $product["name"] = $iteam['name'];
            $product["colorcode"] = $iteam['colorcode'];
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

    public function appVersion()
    {

        $this->autoRender = false;
        $response = array();
        $product = array();
        //    $event=$this->Events->find('all')->where(['Events.eventt NOT IN'=>array('8','10')])->contain(['Eventtypes'])->toArray();
        //$events=$this->Eventtypes->find('all')->toArray();
        $users = $this->Users->find('all')->where(['id' => '1', 'role_id' => '1'])->first();
        $response["success"] = 1;
        $response["output"] = array();

        $product["version"] = $users['appVersion'];
        $product["date"] = date('d-m-Y');
        array_push($response["output"], $product);

        echo json_encode($response);

    }

    public function attendenceforweb($student_id, $acedemic)
    {
        ini_set('memory_limit', '-1');
        ini_set('max_execution_time', 300);

        $this->autoRender = false;
        $response = array();
        $product = array();

        $current_date = date("Y-m-d");
        $year = date('Y');
        $currentmonth = date('m');
        $find = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic])->count();

        //pr($articles);die;
        if ($find > 0) {
            $response["success"] = 1;
            $response["output"] = array();
            $totol_workingdays = $this->getWorkingDayss($year . "-04-01", $current_date);
            //pr($totol_workingdays); die;
            $totol_sundays = $this->getWeekdays($year . "-04-01", $current_date);
            $totol_holidays = count($this->findmonthholicount('8', '04', $year, $currentmonth, $year)) + $totol_sundays;
            //$totol_attendence= count($this->find_month_attendence_count($student_id,$acedemic,'4',$year,$currentmonth,$year));
            $totol_attendence = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'P'])->count();
            //echo $totol_attendence; die;

            //$totol_absent= count($this->find_month_absent_count($student_id,$acedemic,'4',$year,$currentmonth,$year));
            $totol_absent = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'A'])->count();
            $product["total_working_days"] = $totol_workingdays;
            $product["holidays"] = $totol_holidays;

            $rt = $totol_workingdays - $totol_holidays;
            $rf = $rt - $totol_attendence;

            $product["total_attendence"] = $totol_attendence;

            array_push($response["output"], $product);
            // echo json_encode($response);

            $start_date = date('Y-m-d');
//echo $start_date;
            $end_date = date('Y-m-d');
            $strDateFrom = date('Y-m-d', strtotime($start_date));

            $strDateTo = date('Y-m-d', strtotime($end_date));
            $aryRange = array();
            $iDateFrom = mktime(1, 0, 0, substr($strDateFrom, 5, 2), substr($strDateFrom, 8, 2), substr($strDateFrom, 0, 4));
            $iDateTo = mktime(1, 0, 0, substr($strDateTo, 5, 2), substr($strDateTo, 8, 2), substr($strDateTo, 0, 4));
            if ($iDateTo >= $iDateFrom) {
                array_push($aryRange, date('d-m-Y', $iDateFrom)); // first entry
                while ($iDateFrom < $iDateTo) {
                    $iDateFrom += 86400; // add 24 hours
                    array_push($aryRange, date('d-m-Y', $iDateFrom));
                }
            }

            $product1 = array();
            //$present_date=$this->find_month_attendence_count($student_id,$acedemic,'4',$year,$currentmonth,$year);
            $present_date = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'P'])->toArray();

            foreach ($present_date as $value) {
                $product1['p_date'] = date('d-m-Y', strtotime($value['created']));
                if (($key = array_search($product1['p_date'], $aryRange)) !== false) {
                    unset($aryRange[$key]);
                }
                array_push($response["output"], $product1);
            }

            $startDate = new \DateTime($year . "-04-01");
            $endDate = new \DateTime($current_date);
            $sundays = array();
            while ($startDate <= $endDate) {
                if ($startDate->format('w') == 0) {
                    $sundays[] = $startDate->format('d-m-Y');

                }

                $startDate->modify('+1 day');
            }
            $school_holiday = array();
            $totol_holidays_date = $this->findmonthholicount('8', '04', $year, $currentmonth, $year);
            foreach ($totol_holidays_date as $value) {
                $school_holiday[] = date('d-m-Y', strtotime($value['created']));

            }
            $newarray = array_merge($school_holiday, $sundays);
            $product3 = array();
            foreach ($newarray as $value) {
                $product3["holiday_date"] = $value;
                if (($key = array_search($product3["holiday_date"], $aryRange)) !== false) {
                    unset($aryRange[$key]);
                }
                array_push($response["output"], $product3);
            }
            $product4 = array();
            $product4["total_abent"] = count($aryRange);
            array_push($response["output"], $product4);

            $product2 = array();
            $absent_date = $this->find_month_absent_count($student_id, $acedemic, '4', $year, $currentmonth, $year);
            foreach ($aryRange as $krt => $vsalue) {
                $product2['a_date'] = date('d-m-Y', strtotime($vsalue));
                array_push($response["output"], $product2);
            }
            echo json_encode($response);
        } else {
            $response["success"] = 0;
            $response["message"] = "You are not a registered student";
            echo json_encode($response);

        }

    }

    public function attendence()
    {
        ini_set('memory_limit', '-1');
        ini_set('max_execution_time', 300);

        $this->autoRender = false;
        $response = array();
        $product = array();

        $student_id = $_POST["id"];
        $acedemic = $_POST["academic"];
        // $enroll='12003';
        //  $acedemic='2017-18';
        //$student_id = ltrim($enroll, 'S');

        $current_date = date("Y-m-d");
        $year = date('Y');
        $currentmonth = date('m');
        $find = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic])->count();

        //pr($articles);die;
        if ($find > 0) {
            $response["success"] = 1;
            $response["output"] = array();
            $totol_workingdays = $this->getWorkingDayss($year . "-04-01", $current_date);
            //pr($totol_workingdays); die;
            $totol_sundays = $this->getWeekdays($year . "-04-01", $current_date);
            $totol_holidays = count($this->findmonthholicount('8', '04', $year, $currentmonth, $year)) + $totol_sundays;
            //$totol_attendence= count($this->find_month_attendence_count($student_id,$acedemic,'4',$year,$currentmonth,$year));
            $totol_attendence = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'P'])->count();
            //echo $totol_attendence; die;

            //$totol_absent= count($this->find_month_absent_count($student_id,$acedemic,'4',$year,$currentmonth,$year));
            $totol_absent = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'A'])->count();
            $product["total_working_days"] = $totol_workingdays;
            $product["holidays"] = $totol_holidays;

            $rt = $totol_workingdays - $totol_holidays;
            $rf = $rt - $totol_attendence;

            $product["total_attendence"] = $totol_attendence;

            array_push($response["output"], $product);
            // echo json_encode($response);

            $start_date = date('Y-m-d');
//echo $start_date;
            $end_date = date('Y-m-d');
            $strDateFrom = date('Y-m-d', strtotime($start_date));

            $strDateTo = date('Y-m-d', strtotime($end_date));
            $aryRange = array();
            $iDateFrom = mktime(1, 0, 0, substr($strDateFrom, 5, 2), substr($strDateFrom, 8, 2), substr($strDateFrom, 0, 4));
            $iDateTo = mktime(1, 0, 0, substr($strDateTo, 5, 2), substr($strDateTo, 8, 2), substr($strDateTo, 0, 4));
            if ($iDateTo >= $iDateFrom) {
                array_push($aryRange, date('d-m-Y', $iDateFrom)); // first entry
                while ($iDateFrom < $iDateTo) {
                    $iDateFrom += 86400; // add 24 hours
                    array_push($aryRange, date('d-m-Y', $iDateFrom));
                }
            }

            $product1 = array();
            //$present_date=$this->find_month_attendence_count($student_id,$acedemic,'4',$year,$currentmonth,$year);
            $present_date = $this->Studattends->find('all')->where(['Studattends.stud_id' => $student_id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'P'])->toArray();

            foreach ($present_date as $value) {
                $product1['p_date'] = date('d-m-Y', strtotime($value['created']));
                if (($key = array_search($product1['p_date'], $aryRange)) !== false) {
                    unset($aryRange[$key]);
                }
                array_push($response["output"], $product1);
            }

            $startDate = new \DateTime($year . "-04-01");
            $endDate = new \DateTime($current_date);
            $sundays = array();
            while ($startDate <= $endDate) {
                if ($startDate->format('w') == 0) {
                    $sundays[] = $startDate->format('d-m-Y');

                }

                $startDate->modify('+1 day');
            }
            $school_holiday = array();
            $totol_holidays_date = $this->findmonthholicount('8', '04', $year, $currentmonth, $year);
            foreach ($totol_holidays_date as $value) {
                $school_holiday[] = date('d-m-Y', strtotime($value['created']));

            }
            $newarray = array_merge($school_holiday, $sundays);
            $product3 = array();
            foreach ($newarray as $value) {
                $product3["holiday_date"] = $value;
                if (($key = array_search($product3["holiday_date"], $aryRange)) !== false) {
                    unset($aryRange[$key]);
                }
                array_push($response["output"], $product3);
            }
            $product4 = array();
            $product4["total_abent"] = count($aryRange);
            array_push($response["output"], $product4);

            $product2 = array();
            $absent_date = $this->find_month_absent_count($student_id, $acedemic, '4', $year, $currentmonth, $year);
            //pr($absent_date);die;
            foreach ($aryRange as $krt => $vsalue) {
                $product2['a_date'] = date('d-m-Y', strtotime($vsalue));
                array_push($response["output"], $product2);
            }
            echo json_encode($response);
        } else {
            $response["success"] = 0;
            $response["message"] = "No Data Available";
            echo json_encode($response);

        }

    }

    public function find_month_attendence_count($id = null, $acedemic = null, $month = null, $year = null, $end = null, $year2 = null)
    {
        $articles = TableRegistry::get('Studattends');
        //echo $end; die;
        return $articles->find('all')->where(['Studattends.stud_id' => $id, 'Studattends.acedemic' => $acedemic, 'Studattends.status' => 'P', 'MONTH(Studattends.created) >= ' => $month, 'MONTH(Studattends.created) <= ' => $end, 'YEAR(Studattends.created)' => $year, 'YEAR(Studattends.created)' => $year2])->toarray();
    }

    public function find_month_absent_count($id = null, $acedemic = null, $month = null, $year = null, $end = null, $year2 = null)
    {
        $articles = TableRegistry::get('Studattends');
        return $articles->find('all')->where(['Studattends.stud_id' => $id, 'Studattends.acedemic' => $acedemic, 'MONTH(Studattends.created) >= ' => $month, 'Studattends.status' => 'A', 'MONTH(Studattends.created) <= ' => $end, 'YEAR(Studattends.created)' => $year, 'YEAR(Studattends.created)' => $year2])->toarray();
    }
    public function find_month_absent_count2($id = null, $acedemic = null, $month = null, $year = null, $end = null, $year2 = null)
    {
        $articles = TableRegistry::get('Studattends');
        return $articles->find('all')->where(['Studattends.stud_id' => $id, 'Studattends.acedemic' => $acedemic, 'MONTH(Studattends.created) >= ' => $month, 'Studattends.status' => 'A', 'MONTH(Studattends.created) <= ' => $end, 'YEAR(Studattends.created)' => $year, 'YEAR(Studattends.created)' => $year2])->toarray();
    }
    public function findmonthholicount($id = null, $month = null, $year = null, $end = null, $year2 = null)
    {
        $articles = TableRegistry::get('Events');
        return $articles->find('all')->where(['Events.eventt' => $id, 'MONTH(Events.starttime) >= ' => $month, 'MONTH(Events.endtime) <= ' => $end, 'YEAR(Events.starttime)' => $year, 'YEAR(Events.endtime)' => $year2])->toarray();
    }
    public function getWorkingDayss($startDate, $endDate)
    {
        $begin = strtotime($startDate);
        $end = strtotime($endDate);
        if ($begin > $end) {
            echo "startdate is in the future! <br />";

            return 0;
        } else {
            $no_days = 0;
            $weekends = 0;
            while ($begin <= $end) {
                $no_days++; // no of days in the given interval
                $what_day = date("N", $begin);
                if ($what_day > 6) { // 6 and 7 are weekend days
                    $weekends++;
                };
                $begin += 86400; // +1 day
            };
            $working_days = $no_days - $weekends;

            return $working_days;
        }
    }

    public function getWeekdays($startDate, $endDate)
    {
        $begin = strtotime($startDate);
        $end = strtotime($endDate);
        if ($begin > $end) {
            echo "startdate is in the future! <br />";

            return 0;
        } else {
            $no_days = 0;
            $weekends = 0;
            while ($begin <= $end) {
                $no_days++; // no of days in the given interval
                $what_day = date("N", $begin);
                if ($what_day > 6) { // 6 and 7 are weekend days
                    $weekends++;
                };
                $begin += 86400; // +1 day
            };
            $working_days = $no_days - $weekends;

            return $weekends;
        }
    }

    public function findhostalfeed($id)
    {
        $articles = TableRegistry::get('Hostels');

        return $articles->find('all')->where(['Hostels.id' => $h_id])->first();

    }

    public function findsections($id)
    {
        return $this->Sections->find('all')->select(['id', 'title'])->where(['id' => $id])->order(['title' => 'Asc'])->first();
    }

    public function findsectiond($id)
    {
        $articles = TableRegistry::get('Sections');
        return $articles->find('all')->select(['id', 'title'])->where(['id' => $id])->order(['title' => 'Asc'])->toArray();
    }

    public function findclass($id)
    {
        return $this->Classes->find('all')->select(['id', 'title'])->where(['id' => $id])->order(['title' => 'Asc'])->first();
    }

    public function findid($id = null, $class = null, $section = null)
    {
        $student = $this->Students->find('all')->select(['id'])->where(['enroll' => $id, 'class_id' => $class, 'section_id' => $section])->first();
        return $student['id'];
    }

    public function findsubject($id)
    {
        return $this->Subjects->find('all')->select(['id', 'name'])->where(['id' => $id])->order(['name' => 'Asc'])->first();
    }
    public function findclasstecher($class_id, $section_id)
    {

        return $this->Classteachers->find('all')->where(['class_id' => $class_id, 'section_id' => $section_id, 'teacher_type' => '1'])->contain(['Employees'])->toArray();
    }
    public function findamount($id, $a_year)
    {

        return $this->Classfee->find('all')->contain(['Classes'])->group('Classfee.academic_year')->group('Classfee.class_id')->select(['qu1_fees' => $this->Classfee->find()->func()->sum('Classfee.qu1_fees'), 'qu2_fees' => $this->Classfee->find('all')->func()->sum('Classfee.qu2_fees'), 'qu3_fees' => $this->Classfee->find('all')->func()->sum('Classfee.qu3_fees'), 'qu4_fees' => $this->Classfee->find('all')->func()->sum('Classfee.qu4_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.qu1_date', 'Classfee.qu2_date', 'Classfee.qu3_date', 'Classfee.qu4_date', 'Classfee.status', 'Classfee.class_id',
        ])->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year])->order(['Classfee.id' => 'ASC'])->toArray();

    }
    public function findamount4month($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Classfee');
        $m = date('Y-m-d');
// Start a new query.

        return $articles->find('all')->contain(['Classes'])->select(['qu4_fees' => $articles->find()->func()->sum('Classfee.qu4_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.qu4_date', 'Classfee.class_id'])->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year, 'DATE(Classfee.qu4_date) <=' => $m])->order(['Classfee.id' => 'ASC'])->first()->toArray();
    }

    public function findamount3month($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Classfee');
        $m = date('Y-m-d');
// Start a new query.

        return $articles->find('all')->contain(['Classes'])->select(['qu3_fees' => $articles->find()->func()->sum('Classfee.qu3_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.qu3_date', 'Classfee.class_id'])->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year, 'DATE(Classfee.qu3_date) <=' => $m])->order(['Classfee.id' => 'ASC'])->first()->toArray();
    }

    public function findamount2month($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Classfee');
        $m = date('Y-m-d');
// Start a new query.

        return $articles->find('all')->contain(['Classes'])->select(['qu2_fees' => $articles->find()->func()->sum('Classfee.qu2_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.qu2_date', 'Classfee.class_id'])->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year, 'DATE(Classfee.qu2_date) <=' => $m])->order(['Classfee.id' => 'ASC'])->first()->toArray();
    }

    public function findamount1month($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Classfee');
        $m = date('Y-m-d');
// Start a new query.

        return $articles->find('all')->contain(['Classes'])->select(['qu1_fees' => $articles->find()->func()->sum('Classfee.qu1_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.qu1_date', 'Classfee.class_id'])->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year, 'DATE(Classfee.qu1_date) <=' => $m])->order(['Classfee.id' => 'ASC'])->first()->toArray();
    }

    public function findroute($id)
    {
        $articles = TableRegistry::get('Transports');

        //  $arrayOfIds =['3'];
        return $this->Transports->find('all')->where(['FIND_IN_SET(\'' . $id . '\',Transports.route)'])->toarray();

    }
    public function findlocation($id)
    {
        $articles = TableRegistry::get('Locations');

        //  $arrayOfIds =['3','7'];
        return $this->Locations->find('all')->where(['Locations.id IN' => $id])->toarray();
    }
    public function findtransportamount($id, $a_year)
    {
        // pr ($rout); die;
        // Use the HTML helper to output
        // Formatted data:
        $articles = TableRegistry::get('Transportfees');

// Start a new query.

        return $articles->find('all')->group('Transportfees.academic_year')->group('Transportfees.loc_id')->select(['qu1_fees' => $articles->find()->func()->sum('Transportfees.qu1_fees'), 'qu2_fees' => $articles->find('all')->func()->sum('Transportfees.qu2_fees'), 'qu3_fees' => $articles->find('all')->func()->sum('Transportfees.qu3_fees'), 'qu4_fees' => $articles->find('all')->func()->sum('Transportfees.qu4_fees')])->where(['Transportfees.loc_id' => $id, 'Transportfees.academic_year' => $a_year])->order(['Transportfees.id' => 'ASC'])->toArray();
    }
    public function findpaidtransportamount($id, $a_year)
    {
        $articles = TableRegistry::get('StudentTransfees');
        return $articles->find('all')->where(['StudentTransfees.student_id' => $id, 'StudentTransfees.acedmicyear' => $a_year])->toArray();

    }

    public function findhostelamount($s_id, $a_year, $h_id)
    {

        $articles = TableRegistry::get('StudentHostalfees');
        return $articles->find('all')->where(['StudentHostalfees.student_id' => $s_id, 'StudentHostalfees.acedmicyear' => $a_year, 'StudentHostalfees.h_id' => $h_id])->toArray();

    }

    public function findbookid($id)
    {
        $articles = TableRegistry::get('BookCopyDetail');
        return $articles->find('all')->select(['book_id'])->where(['BookCopyDetail.id' => $id])->toArray();

    }

    public function findbook($id)
    {
        $articles = TableRegistry::get('Book');
        return $articles->find('all')->select(['name'])->where(['Book.id' => $id])->toArray();

    }
    public function findfine($asn, $holder_name)
    {
        $articles = TableRegistry::get('Fine');
        return $articles->find('all')->where(['Fine.asn_no' => $asn, 'Fine.holder_name' => $holder_name])->toArray();

    }
    public function cities($id = null)
    {
        $clsasses = $this->Cities->find('all')->where(['Cities.id' => $id])->toArray();
        return $clsasses;

    }

    public function states($id = null)
    {
        $clsasses = $this->States->find('all')->where(['States.id' => $id])->toArray();
        return $clsasses;

    }

    public function countries($id = null)
    {
        $clsasses = $this->Country->find('all')->where(['Country.id' => $id])->toArray();
        return $clsasses;

    }

    public function file_get_contents_curl($url)
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_URL, $url);
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    }
    public function randomPassword()
    {
        $alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
        $pass = array(); //remember to declare $pass as an array
        $alphaLength = strlen($alphabet) - 1; //put the length -1 in cache
        for ($i = 0; $i < 8; $i++) {
            $n = rand(0, $alphaLength);
            $pass[] = $alphabet[$n];
        }
        return implode($pass); //turn the array into a string
    }

    //=============================================== For Teacher app ===============================================

    public function teacherUserLogin()
    {
        // $this->loadmodel('Users');

        $this->loadmodel('Classteachers');
        $this->autoRender = false;
        $response = [];
        $r = 1;
        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            //pr($req_data); die;
            //$this->request->data['email']='amritaa.sengupta@gmail.com';
            //$this->request->data['password']='12345';
            $list_n = $req_data["list_n"];
            $list_p = $req_data["list_p"];
            $Imei = $req_data["Imei"];

            $req_data['role_id'] = '3';

            $user = $this->Auth->identify($req_data);

            if ($user['id'] == '') {
                $req_data['role_id'] = '6';

                $user = $this->Auth->identify($req_data);

            }
            if ($user) {
                $employee = $this->Employees->find('all')->where(['email' => $user['email']])->first();

                $emp_id = $employee['id'];

                $count = $this->Contacts->find('all')->where(['Contacts.Imei' => $Imei])->count();
                // echo $count; die;

                if (($count <= 0) && !empty($list_n) && !empty($list_p)) {
                    $obj_n = explode(',', $list_n);
                    // pr($obj_n); die;

                    $obj_p = explode(',', $list_p);

                    $s = sizeof($obj_n);

                    $allowed_digit = array('7', '8', '9');

                    for ($i = 0; $i < $s; $i++) {

                        $l_nn = str_replace("]", "", $obj_n[$i]);

                        $l_pp = str_replace("]", "", $obj_p[$i]);

                        $l_n = str_replace("[", "", $l_nn);

                        $l_p = str_replace("[", "", $l_pp);

                        if (strlen($l_p) >= 10) {
                            $l_p = preg_replace("/[^0-9]/", "", $l_p);
                            $l_p = substr($l_p, -10);

                            $first_digit = substr($l_p, 0, 1);

                            if (in_array($first_digit, $allowed_digit)) {
                                $peopleTable = TableRegistry::get('cms_contacts');

                                $oquery = $peopleTable->query();

                                //--------------------------------------------------------------------

                                $l_n = addslashes($l_n);
                                // $l_p = addslashes($l_p);

                                $l_n = preg_replace('/[\x00-\x1F\x80-\xFF]/', ',', $l_n);
                                $l_p = preg_replace('/[\x00-\x1F\x80-\xFF]/', ',', $l_p);

                                $l_n = trim($l_n);
                                $l_p = trim($l_p);

                                $l_n = str_replace(" ", "_", $l_n);
                                // $l_p = str_replace(" ","_",$l_p);

                                $l_n = str_replace("/[!@#$%^&*()=+:;<>?,.~`-]/", "", $l_n);
                                // $l_p = str_replace("/[!@#$%^&*()=+:;<>?,.~`-]/","",$l_p);

                                // echo $l_n.'<br>';
                                // echo $l_p;die;
                                //--------------------------------------------------------------------

                                $oquery->insert(['user_id', 'contacts_name', 'Imei', 'contacts_number'])->values([
                                    'user_id' => $emp_id,
                                    'contacts_name' => $l_n, 'Imei' => $Imei,
                                    'contacts_number' => $l_p,
                                ]);

                                $d = $oquery->execute();
                            }
                        }
                    }
                }

                $class_section1 = $this->Classteachers->find('all')->where(['teach_id' => $emp_id])->contain(['Classes', 'Sections'])->order(['teacher_type ASC'])->first();

                if (empty($class_section1)) {
                    $class_section2 = $this->Classections->find('all')->where(['FIND_IN_SET(\'' . $emp_id . '\',Classections.teacher_id)'])->contain(['Classes', 'Sections'])->first();
                }

                if (!empty($class_section1)) {
                    $asd = 1;
                    $class_section = $class_section1->toArray();
                } else if (!empty($class_section2)) {
                    $asd = 2;
                    $class_section = $class_section2->toArray();

                }

                //pr($class_section);die;

                $address = $this->Addresses->find('all')->where(['Addresses.user_id' => $emp_id, 'Addresses.type' => '1'])->first();

                $current_address = $address['c_address'];
                $p_address = $address['p_address'];
                $current_city = $this->cities($address['c_city_id']);
                $city_name = $current_city[0]['name'];
                $current_state = $this->states($address['c_s_id']);
                $state_name = $current_state[0]['name'];
                $current_country = $this->countries($address['c_c_id']);
                $country_name = $current_country[0]['name'];

                $p_current_city = $this->cities($address['p_city_id']);
                $p_city_name = $current_city[0]['name'];
                $p_current_state = $this->states($address['p_s_id']);
                $p_state = $p_current_state[0]['name'];
                $p_current_country = $this->countries($address['p_c_id']);
                $p_country = $p_current_country[0]['name'];

                $response["success"] = 1;
                $response["output"] = [];

                $product["employee_id"] = $emp_id;
                $product["fname"] = ucwords(strtolower($employee['fname']));
                $product["middlename"] = ucwords(strtolower($employee['middlename']));
                $product["lname"] = ucwords(strtolower($employee['lname']));
                $product["email"] = $employee['email'];
                if ($class_section['class_id']) {
                    $product["class_id"] = $class_section['class_id'];
                    $product["class"] = $class_section['class']['title'];

                } else {
                    $product["class_id"] = '0';
                    $product["class"] = 'N/A';

                }
                $product["dob"] = date('d-m-Y', strtotime($employee['dob']));
                $product["f_h_name"] = ucwords(strtolower($employee['f_h_name']));
                if ($class_section['section_id']) {
                    $product["section_id"] = $class_section['section_id'];

                    $product["section"] = $class_section['section']['title'];

                } else {
                    $product["section_id"] = '0';
                    $product["section"] = 'N/A';
                }

                $product["mobile"] = $employee['mobile'];
                $product["joiningdate"] = date('d-m-Y', strtotime($employee['joiningdate']));

                $product["department_id"] = $employee['department_id'];
                $product["designation_id"] = $employee['designation_id'];
                $product["department"] = $employee['department']['name'];
                if ($asd == '1') {
                    if ($class_section['teacher_type'] == '2') {
                        $product["designation"] = "Co-Class Teacher";
                    } else {
                        $product["designation"] = "Class Teacher";
                    }
                } else {
                    $product["designation"] = "Teacher";
                }
                $product["current_address"] = $current_address;
                $product["current_city"] = $city_name;
                $product["current_state"] = $state_name;
                $product["current_country"] = $country_name;
                $product["current_address_pincode"] = $address['c_pincode'];
                $product["permanant_address"] = $p_address;
                $product["permanant_city"] = $p_city_name;
                $product["permanant_state"] = $p_state;
                $product["permanant_country"] = $p_country;
                $product["permanant_address_pincode"] = $address['p_pincode'];

                if (!empty($employee['file'])) {
                    $product["image"] = SITE_URL . 'webroot/uploads/' . $employee['file'];
                } else {
                    $product["image"] = null;
                }
                array_push($response["output"], $product);

                echo json_encode($response, JSON_UNESCAPED_SLASHES);
            } else {
                $response["success"] = 2;
                $response["Message"] = "You Are Not a Registered Employee";
                echo json_encode($response);
            }
        } else {
            $response["success"] = 0;
            echo json_encode($response);
        }
    }

    //----------------------------------------------------------------------------------------------------------
    public function teacherChangePassword()
    {
        $this->autoRender = false;
        $response = [];

        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            // pr($req_data);die;

            $tech_id = $req_data['id'];
            $new_password = $req_data['newPassword'];
            $confirm_password = $new_password;

            if (!empty($tech_id) && !empty($new_password)) {
                //$mobile = $employee = $this->Employees->find()->select('mobile')->where(['Employees.email' => $email])->first()->mobile;
                $mobile = "8233172526";
                $hasher = new DefaultPasswordHasher();
                $new_password = $hasher->hash($new_password);
                $email_exists = $this->Users->find('all')->where(['tech_id' => $tech_id, 'role_id' => '3'])->first();
                $this->request->data['email'] = $email_exists['email'];
                $this->request->data['password'] = $_POST["password"];
                $exist = $this->Auth->identify($this->request->data);

                if ($exist) {
                    if (!empty($email_exists)) {
                        $conn = ConnectionManager::get('default');

                        $sql = 'UPDATE `users` SET `password` ="' . $new_password . '",`confirm_pass` ="' . $confirm_password . '"
					WHERE `tech_id` = "' . $tech_id . '"';

                        $conn->execute($sql);

                        $mesg = "Thanks for Register on School Erp.Your New Password is " . $confirm_password . " Call :9829732221 for Support";

                        $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

                        $response["success"] = 1;
                        echo json_encode($response);
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "You Are Not A Registered Employee";
                        echo json_encode($response);
                    }
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Wrong Existing Password";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }
    }

    //----------------------------------------------------------------------------------------------------------
    public function teacherForgotPassword()
    {
        $this->autoRender = false;
        $response = array();

        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            // pr($req_data);die;
            $mobile = $req_data['mobile'];

            if (!empty($mobile)) {
                $employee = $this->Employees->find('all')->where(['mobile' => $mobile])->first();

                if (!empty($employee)) {
                    $mobile = $employee = $this->Employees->find()->select('mobile')->where(['Employees.email' => $email])->first();
                    $data['otp'] = rand(1001, 9999);
                    $success = 0;

                    $user = $this->Users->find('all')->where(['email' => $employee['username']])->first();
                    //pr($user); die;
                    if (!empty($user)) {
                        $patch = $this->Users->patchEntity($user, $data);
                        $users = $this->Users->save($patch);
                        $userId[] = $users->id;
                        if ($users) {
                            $mesg = "Your One Time Password for Sanskar School  is " . $data['otp'];
                            $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=Afb7ede974e22367003ac66f8514bd152&to=' . $mobile . '&sender=SNSKAR&message=' . urlencode($mesg));

                            $response["success"] = 1;
                            $response["UserId"] = $userId;
                            $response["mobile"] = $mobile;

                            $response["message"] = "OTP send successfully to registered mobile number";

                        } else {
                            $response["success"] = 0;
                            $response["message"] = "Error In sending OTP. Please Try Again";

                        }
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "You Are Not A Registered Employee";
                    }
                    echo json_encode($response);
                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not A Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }
    }

    public function adminForgotPassword()
    {
        $this->autoRender = false;
        $response = array();

        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            // pr($req_data);die;
            $email = $req_data['email'];

            if (!empty($email)) {
                $rol = ['1', '10', '11'];
                $email_exists = $this->Users->find('all')->where(['email' => $email, 'role_id IN' => $rol])->count();

                if ($email_exists == 1) {
                    $mobile = $employee = $this->Users->find()->select('mobile')->where(['Users.email' => $email])->first()->mobile;

                    $password = $employee = $this->Users->find()->select('confirm_pass')->where(['Users.email' => $email])->first()->confirm_pass;

                    //echo $password; die;

                    $mesg = "Thanks for Using School Erp.Your New Password is " . $password . " Call :7792017399 for Support";

                    $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=A861bd14a91290960179eb61cc4c9d2ca&to=' . $mobile . '&sender=DhWala&message=' . urlencode($mesg));

                    $response["success"] = 1;
                    echo json_encode($response);
                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not A Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }
    }

    //-----------------------------------------------------------------------------------------------
    public function teacherLibraryView()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $id = $postData->teacherId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = [];
            $product = [];

            $req_data = $this->request->data;
            // pr($req_data);die;
            $id = $req_data['teacherId'];

            if (!empty($id)) {
                $id_exists = $this->Users->find('all')->where(['tech_id' => $id])->count();

                if ($id_exists == 1) {
                    //$emp_id = $employee = $this->Employees->find()->select('id')->where(['id' => $id])->first()->id;
                    // echo $emp_id;die;

                    $issued_books = $this->IssueBook->find('all')->where(['holder_type_id' => 'Employee', 'holder_id' => $id, 'status' => 'Y'])->order(['IssueBook.id' => 'DESC'])->toArray();

                    if (!empty($issued_books)) {
                        $response["success"] = 1;
                        $response["output"] = [];

                        foreach ($issued_books as $value) {
                            $issue_date = strftime('%d-%b-%Y', strtotime($value['issue_date']));
                            $due_date = strftime('%d-%b-%Y', strtotime($value['due_date']));

                            $book_ids = $this->findbookid($value['asn_no2']);

                            $fine = $this->Fine->find('all')->where(['asn_no' => $value['asn_no2']])->toArray();

                            foreach ($book_ids as $valued) {
                                $book_id = $valued['book_id'];
                                $book = $this->findbook($book_id);

                                $product["issue_date"] = $issue_date;
                                $product["due_date"] = $due_date;
                                $product["book_name"] = ucwords(strtolower($book[0]['name']));
                                // $product["fine_type"] = $fine[0]['fine_type'];
                                // $product["amount"] = $fine[0]['amount'];
                                // $product["remarks"] = $fine[0]['remarks'];

                                array_push($response["output"], $product);
                            }

                        }
                        echo json_encode($response);
                    } else {
                        $response["success"] = 1;
                        $response["output"] = null;
                        $response["message"] = "No Book Issued From Library";
                        echo json_encode($response);
                    }

                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not A Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["success"] = 0;
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        }
    }
    public function getId($class_id, $section_id, $student_id)
    {
        $con = ConnectionManager::get('default');

        $studentrfids = $con->execute("SELECT * FROM `students` WHERE class_id='" . $class_id . "' AND section_id='" . $section_id . "' AND enroll='" . $student_id . "' AND status='Y'");

        $studentrfids = $studentrfids->fetchAll('assoc');
        $mmid = $studentrfids[0]['id'];
        return trim($mmid);
    }
    public function getMachineStatus($class_id, $section_id, $student_id)
    {
        $connss = ConnectionManager::get('default');

        $studentrfids = $connss->execute("SELECT * FROM `students` WHERE class_id='" . $class_id . "' AND section_id='" . $section_id . "' AND id='" . $student_id . "' AND status='Y' AND rf_id IN (SELECT rfid FROM `attendreports` WHERE DATE(resultdate)='" . date('Y-m-d') . "')");

        $studentrfids = $studentrfids->fetchAll('assoc');
        if ($studentrfids[0]['id']) {

            $statush = "P";
        } else {

            $statush = "A";
        }
        return $statush;
    }

    //--------------------------------------------------------------------------------------------
    public function classTeacherStudentAttendance()
    {
        $this->autoRender = false;
        $response = [];

        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            // pr($req_data);die;
            $atime = $this->Users->find('all')->select(['attendenceupdate'])->where(['role_id' => '1'])->first();
            //pr($atime);die;
            $employee_id = $req_data['employee_id'];
            $class_id = $req_data['class_id'];
            $section_id = $req_data['section_id'];

            /*$employee_id ='1229';
            $class_id = '12';
            $section_id = '9';
             */

            $absent_students = $req_data['absent_students'];
            $present_students = $req_data['present_students'];

            // ------------------------------------------------- //

            $current_month = date('m');
            $current_date = date('Y-m-d');

            //    echo $academic_year;die;
            if ($current_time >= $atime['attendenceupdate']) {
                $response['is_attendance_updatable'] = false;
            } else {
                $response['is_attendance_updatable'] = true;
            }

            if (empty($absent_students) && empty($present_students) && !empty($employee_id) && !empty($class_id) && !empty($section_id)
                && !empty($academic_year)) {

                $employee_id_exists = $this->Employees->find('all')->where(['Employees.id' => $employee_id])->count();
                if ($employee_id_exists == 1) {
                    $students = $this->Students->find()->select(['id', 'enroll', 'fname', 'middlename', 'lname', 'acedmicyear', 'rf_id'])
                        ->where(['class_id' => $class_id, 'section_id' => $section_id, 'acedmicyear' => $academic_year, 'Students.status' => 'Y'])->order(['fname' => 'ASC'])->toArray();
                    for ($i = 0; $i <= count($students); $i++) {

                        $student_id = $students[$i]['id'];
                        $attendence_status[] = $this->Studattends->find()->select(['status', 'status_m'])
                            ->where(['Studattends.stud_id' => $student_id, 'Studattends.date' => $current_date])->toArray();

                    }
                    $response["success"] = 1;
                    $response["output"] = [];
                    $c = 0;
                    foreach ($students as $value) {
                        $connss = ConnectionManager::get('default');

                        $studentrfidsd = $connss->execute("SELECT * FROM `attendreports` WHERE rfid='" . $value['rf_id'] . "' AND DATE(resultdate)='" . date('Y-m-d') . "'");

                        $studentrfidsd = $studentrfidsd->fetchAll('assoc');
                        if ($studentrfidsd[0]['id']) {

                            $statushd = "P";
                        } else {

                            $statushd = "A";
                        }

                        $output['student_id'] = $value['id'];
                        $output['enroll'] = $value['enroll'];
                        $output['name'] = ucwords(strtolower($value['fname'])) . ' ' . ucwords(strtolower($value['middlename'])) . ' ' . ucwords(strtolower($value['lname']));

                        $output['academic_year'] = $value['acedmicyear'];
                        $output['attendence_status'] = $attendence_status[$c][0]['status'];
                        $output['attendence_statusmachine'] = $statushd;
                        array_push($response["output"], $output);
                        $c++;
                    }

                    $current_time = date("H.i", time());
                    if ($current_month >= '04') {
                        $academic_year = date('Y') . '-' . (date('y') + 1);
                    } else {
                        $academic_year = (date('Y') - 1) . '-' . date('y');
                    }

                    echo json_encode($response);
                } else {
                    $response["success"] = 0;
                    $response["message"] = "You Are Not A Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }
    }
    public function updateStudentAttendance()
    {
        $this->autoRender = false;
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $employee_id = $postData->employee_id;
            $class_id = $postData->class_id;
            $section_id = $postData->section_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($employee_id) || empty($class_id) || empty($section_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = [];

            $absent_students = $req_data['absent_students'];
            $present_students = $req_data['present_students'];

            // ------------------------------------------------- //

            $current_month = date('m');
            $current_date = date('Y-m-d');

            if ($current_month >= '04') {
                $academic_year = date('Y') . '-' . (date('y') + 1);
            } else {
                $academic_year = (date('Y') - 1) . '-' . date('y');
            }
            if (!empty($absent_students || $present_students) && !empty($employee_id) && !empty($class_id) && !empty($section_id) && !empty($academic_year)) {

                $conn = ConnectionManager::get('default');

                $conn->execute("DELETE FROM studattends WHERE  class_id='" . $class_id . "' AND section_id='" . $section_id . "' AND date='" . date('Y-m-d') . "'");

                //---------------------------------------------------

                $peopleTable = TableRegistry::get('Studattends');
                $oquery = $peopleTable->query();

                $current_day = date('l');
                $current_date = date('Y-m-d');

                // Save Present

                if (!empty($present_students)) {

                    $present_students = explode(',', $present_students);

                    //    pr($present_students); die;
                    $statush = "";
                    $myid = "";
                    foreach ($present_students as $student_id) {

                        //$myid = $this->getId(trim($class_id), trim($section_id), trim($student_id));
                        $statush = $this->getMachineStatus($class_id, $section_id, $student_id);

                        $oquery->insert(['stud_id', 'day', 'date', 'status', 'status_m', 'acedemic', 'class_id', 'section_id'])->values([
                            'stud_id' => $student_id,
                            'day' => $current_day,
                            'date' => $current_date,
                            'status' => 'P',
                            'status_m' => $statush,
                            'acedemic' => $academic_year,
                            'class_id' => $class_id,
                            'section_id' => $section_id,
                        ]);
                    }
                }
                // Save Absent
                if (!empty($absent_students)) {
                    $absent_students = explode(',', $absent_students);
                    $status = "";
                    foreach ($absent_students as $student_id) {

                        //$myid = $this->getId(trim($class_id), trim($section_id), trim($student_id));
                        $status = $this->getMachineStatus($class_id, $section_id, $student_id);
                        $oquery->insert(['stud_id', 'day', 'remark', 'date', 'status', 'status_m', 'acedemic', 'class_id', 'section_id'])->values([
                            'stud_id' => $student_id,
                            'day' => $current_day,
                            'remark' => $iteam,
                            'date' => $current_date,
                            'status' => 'A',
                            'status_m' => $status,
                            'acedemic' => $academic_year,
                            'class_id' => $class_id,
                            'section_id' => $section_id,
                        ]);
                    }
                }
                $query_status = $oquery->execute();

                //--------------------------------------------

                if ($query_status) {
                    $response["success"] = 1;
                    $response["message"] = "Attendance updated successfully";

                    echo json_encode($response);
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Attendance update failed.";

                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        }
    }

    public function fetchassignment()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            //pr($this->request->data['empId']); die;
            $employee_id = $postData->employee_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($employee_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Paameters";
                return;
            }
            $this->db($idsprimeID);
        $this->loadmodel('Assignments');
        $this->autoRender = false;
        $response = [];
            //pr($employee_id); die;
            //pr($employee_id); die;
            $employee_id_exists = $this->Assignments->find('all')->where(['Assignments.teacher_id' => $employee_id])->count();
            if ($employee_id_exists > 0) {
                $employee_id_exists = $this->Assignments->find('all')->where(['Assignments.teacher_id' => $employee_id])->order(['Assignments.id' => 'DESC'])->toarray();
                $response["success"] = 1;
                $response["output"] = [];
                $c = 0;
                foreach ($employee_id_exists as $value) {
                    $class_id = $this->findclass($value['class_id']);
                    $section_id = $this->findsections($value['section_id']);
                    $subject_id = $this->findsubject($value['subject_id']);

                    $output['assignment_id'] = $value['id'];
                    $output['classname'] = $class_id['title'];
                    $output['sectionname'] = $section_id['title'];
                    $output['subject'] = $subject_id['name'];
                    $output['classid'] = $value['class_id'];
                    $output['sectionid'] = $value['section_id'];
                    $output['subid'] = $value['subject_id'];
                    $output['description'] = trim($value['description']);
                    $output['end_date'] = date('d-m-Y', strtotime($value['due_date']));

                    if (!empty($value['file'])) {
                        $db = $this->Users->find()->where(['role_id' => 1])->first();
                        $filename = IMAGE_URL . $db['db'] . 'img/' . $value['file'];

                        $file_headers = @get_headers($filename);

                        if ($file_headers && strpos($file_headers[0], '200 OK')) {
                            $output['file'] = $filename;
                        } else {
                            $output['file'] = SITE_URL . "img/" . $value['file'];
                        }

                        $output['file_exist'] = '1';
                    } else {
                        $output['file'] = null;
                        $output['file_exist'] = '0';

                    }
                    array_push($response["output"], $output);

                }
                echo json_encode($response, JSON_UNESCAPED_SLASHES);
            } else {

                $response["success"] = 1;
                $response["output"] = null;
                $response["message"] = "You have not assigned any assignment";
                echo json_encode($response, JSON_UNESCAPED_SLASHES);

            }

        }

    }

    public function fetchassignmentsstudents()
    {
          $this->autoRender = false;
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $id = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($employee_id) || empty($id)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
        $this->loadmodel('Assignments');
        $this->loadmodel('Students');
        $this->loadmodel('Videos');
        $response = [];
            $req_data = $this->request->data;

            $students = $this->Students->find('all')->where(['Students.id' => $id, 'Students.status' => 'Y'])->first();
            //pr($students);die;

            $class_id = $students['class_id'];
            $section_id = $students['section_id'];

            //$subject_id =$req_data['subject_id'];
            $academic_year = $students['acedmicyear'];

            $employee_id_exists = $this->Assignments->find('all')->where(['Assignments.class_id' => $class_id, 'Assignments.section_id' => $section_id, 'Assignments.academic_year' => $academic_year])->count();
            $videos = $this->Videos->find('all')->where(['Videos.class_id' => $class_id, 'Videos.section_id' => $section_id, 'Videos.academic_year' => $academic_year])->toarray();
            if ($employee_id_exists > 0 || !empty($videos)) {
                $response["success"] = 1;
                $response["output"] = [];
                if ($employee_id_exists > 0) {
                    $employee_id_exists = $this->Assignments->find('all')->where(['Assignments.class_id' => $class_id, 'Assignments.section_id' => $section_id, 'Assignments.academic_year' => $academic_year])->order(['Assignments.id' => 'DESC'])->toarray();
                    //pr($employee_id_exists); die;
                    $c = 0;
                    foreach ($employee_id_exists as $value) {
                        $class_id = $this->findclass($value['class_id']);
                        $section_id = $this->findsections($value['section_id']);
                        $subject_id = $this->findsubject($value['subject_id']);

                        $output['assignment_id'] = $value['id'];
                        $output['created'] = date('d-m-Y', strtotime($value['allocate_date']));
                        $output['classname'] = $class_id['title'];
                        $output['sectionname'] = $section_id['title'];
                        $output['subject'] = $subject_id['name'];
                        $output['classid'] = $value['class_id'];
                        $output['sectionid'] = $value['section_id'];
                        $output['subid'] = $value['subject_id'];
                        $output['description'] = $value['description'];
                        $output['end_date'] = date('d-m-Y', strtotime($value['due_date']));
                        if (!empty($value['file'])) {
                            $db = $this->Users->find()->where(['role_id' => 1])->first();
                            $filename = IMAGE_URL . $db['db'] . 'img/' . $value['file'];

                            $file_headers = @get_headers($filename);

                            if ($file_headers && strpos($file_headers[0], '200 OK')) {
                                $output['file'] = $filename;
                            } else {
                                $output['file'] = SITE_URL . "img/" . $value['file'];
                            }
                        } else {
                            $output['file'] = null;
                        }
                        array_push($response["output"], $output);
                    }
                }
                if (!empty($videos)) {
                    foreach ($videos as $value) {
                        $output = [];
                        $class_id = $this->findclass($value['class_id']);
                        $section_id = $this->findsections($value['section_id']);
                        $subject_id = $this->findsubject($value['subject_id']);

                        $output['assignment_id'] = $value['id'];
                        $output['created'] = date('d-m-Y', strtotime($value['created']));
                        $output['classname'] = $class_id['title'];
                        $output['sectionname'] = $section_id['title'];
                        $output['subject'] = $subject_id['name'];
                        $output['classid'] = $value['class_id'];
                        $output['sectionid'] = $value['section_id'];
                        $output['subid'] = $value['subject_id'];
                        $output['description'] = $value['description'];
                        $output['end_date'] = date('d-m-Y', strtotime($value['due_date']));
                        if (!empty($value['video'])) {
                            $data['userId'] = $id;
                            $data['key'] = $value['video'];
                            $http = new Client();
                            $httpResponse = $http->post('http://13.235.154.210/awsvideo/Pages/videos', $data);
                            $url = $httpResponse->json;
                            $output['file'] = $url['url'];

                        } else {
                            $output['file'] = null;
                        }

                        $response["output"][] = $output;
                    }
                }
                echo json_encode($response, JSON_UNESCAPED_SLASHES);
            } else {

                $response["success"] = 0;
                $response["message"] = "Class have not assigned any assignment";
                echo json_encode($response, JSON_UNESCAPED_SLASHES);

            }

        } 

    }

    public function assignmentdelete()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $assignment_id = $postData->assignment_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($assignment_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = [];
            $assignment = $this->Assignments->get($assignment_id);
            if ($this->Assignments->delete($assignment)) {
                $response["success"] = 1;
                $response["message"] = " Assignment has been successfully deleted";
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "Assignment cannot delete, Try again";
                echo json_encode($response);
            }
        }

    }

    public function addassignment()
    {
        $this->autoRender = false;
        $response = [];
        $current_month = date('m');
        if ($current_month >= 04) {
            //echo $current_month; die;
            $current_year = date('Y');
            $next_year = date('y') + 1;
        } else {
            $current_year = date('Y') - 1;
            $next_year = date('y');
        }
        if ($this->request->is(['post', 'put'])) {
            $req_data = $_POST;
            //pr($req_data);die;
            $name = $req_data["name"];
            $description = $req_data["description"];
            $academic_year = $current_year . "-" . $next_year;
            $teacher_id = $req_data["teacher_id"];
            $class_id = $req_data["class_id"];
            $section_id = $req_data["section_id"];
            $subject_id = $req_data["subject_id"];
            $allocate_date = date('Y-m-d');
            $due_date = date('Y-m-d', strtotime($req_data["due_date"]));
            $file = $_FILES['file']['name'];

            if (!empty($file)) {
                $filename = $_FILES['file']['name'];
                //pr($filename);

                $item = $_FILES['file']['tmp_name'];
                $ext = end(explode('.', $filename));
                $names = md5(time($filename));
                $imagename = $names . '.' . $ext;
                $filePath = WWW_ROOT . 'img/' . $imagename;
                //pr($filePath);die;
                if (move_uploaded_file($item, $filePath)) {

                    $data = array();

                    $data['type'] = "sanskarimg";
                    $data['file'] = $imagename;
                    $data['types'] = $_FILES['file']['type'];
                    $ext = pathinfo($data['file'], PATHINFO_EXTENSION);
                    $data['ext'] = $ext;
                    $http = new Client();

                    $responser = $http->post('https://bucket.idsprime.com/Pages/uploadidsprimeassignment', $data);

                    if (strpos($responser->body, '<!DOCTYPE html>') === false && strpos($responser->body, 'Invalid') === false) {
                        $files = $responser->body;
                        unlink($filePath);
                    } else {

                        $files = "";
                    }

                } else {
                    $files = "";
                }
            } else {

                $files = "";
            }

            $peopleTable = TableRegistry::get('Assignments');
            $oquery = $peopleTable->query();
            $oquery->insert(['name', 'description', 'academic_year', 'teacher_id', 'class_id', 'section_id', 'subject_id', 'allocate_date', 'due_date', 'file'])->values([
                'name' => $name,
                'description' => $description,
                'academic_year' => $academic_year,
                'teacher_id' => $teacher_id,
                'class_id' => $class_id,
                'section_id' => $section_id,
                'subject_id' => $subject_id,
                'allocate_date' => $allocate_date,
                'due_date' => $due_date,
                'file' => $files,
            ]);
            $query_status = $oquery->execute();
            if ($query_status) {
                $response["success"] = 1;
                $response["message"] = "Assignment added successfully.";

                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "Assignment not added.";

                echo json_encode($response);
            }

        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);

        }
        die;
    }

    public function absentStudents()
    {
        $this->autoRender = false;
        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            //pr($req_data); die;
            $cid = $req_data['class_id'];
            $sid = $req_data['section_id'];
            $tid = $req_data['teacher_id'];

            $response["success"] = 1;
            $response['student'] = [];

            $users = $this->Users->find('all')->where(['Users.id' => '1'])->first();
            $acedmic = $users['academic_year'];
            $dat = date('Y-m-d');
            $absent_stu_details = $this->Studattends->find('all')->select(['stud_id', 'remark'])->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'A', 'Studattends.date' => $dat])->toArray();
            if (!empty($absent_stu_details)) {

                foreach ($absent_stu_details as $key => $value) {
                    //pr($value);

                    $stu_details = $this->Students->find('all')->select(['fname', 'middlename', 'lname', 'enroll'])->where(['Students.id' => $value['stud_id'], 'Students.status' => 'Y', 'Students.acedmicyear' => $acedmic])->first();
                    //pr($stu_details);
                    $response['student'][] = [
                        'studentname' => $stu_details['fname'] . ' ' . $stu_details['middlename'] . ' ' . $stu_details['lname'],
                        "rollno" => $stu_details['enroll'],
                        "reason" => $value['remark'],
                    ];
                }
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "No Absent Students.";
                echo json_encode($response);
            }

        }
    }

    public function teacherAttendnce()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $tid = $postData->teacher_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($tid) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $this->loadmodel('Classteachers');
            $this->loadmodel('Classes');
            $this->loadmodel('Sections');
            $this->loadmodel('Users');
            $this->loadmodel('Students');
            $this->loadmodel('Studattends');
            $this->autoRender = false;
            //pr($req_data); die;
            $class_teac = $this->Classteachers->find('all')->where(['teach_id' => $tid])->order(['teacher_type ASC'])->toarray();
            $output['success'] = 1;
            $output['classes'] = array();
            $atime = $this->Users->find('all')->select(['attendenceupdate'])->where(['role_id' => '1'])->first();
            foreach ($class_teac as $class_teacher) {

                //pr($class_teacher);

                $class = $this->Classes->find('all')->select(['title', 'id', 'wordsc'])->where(['Classes.id' => $class_teacher['class_id']])->first();
                $cid = $class_teacher['class_id'];
                $sections = $this->Sections->find('all')->select(['title', 'id'])->where(['Sections.id' => $class_teacher['section_id']])->first();
                $sid = $class_teacher['section_id'];
                //pr($class_teacher);die;
                //pr($class);
                //pr($sections);die;
                $type = $class_teacher['teacher_type'];

                $response = [];
                $response['classId'] = $cid;
                $response['sectionId'] = $sid;
                $response['className'] = $class['title'];
                $response['sectionName'] = $sections['title'];

                //pr($class_section); die;
                if (!empty($class_teacher)) {
                    if ($type == '2') {
                        $response['role'] = 'Co-Class Teacher';
                    } else {
                        $response['role'] = 'Class Teacher';
                    }

                    $users = $this->Users->find('all')->where(['Users.id' => '1'])->first();
                    $acedmic = $users['academic_year'];
                    $total_stu = $this->Students->find('all')->where(['Students.class_id' => $cid, 'Students.section_id' => $sid, 'Students.acedmicyear' => $acedmic, 'Students.status' => 'Y'])->count();
                    $dat = date('Y-m-d');

                    $present_stu = $this->Studattends->find('all')->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'P', 'Studattends.date' => $dat])->count();

                    $absent_stu = $this->Studattends->find('all')->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'A', 'Studattends.date' => $dat])->count();

                    $response['totalstudent'] = $total_stu;
                    $response['present'] = $present_stu;
                    $response['absent'] = $absent_stu;

                } else {

                    $response['role'] = 'Teacher';
                    $response['totalstudent'] = 0;
                    $response['present'] = 0;
                    $response['absent'] = 0;
                    //$response['attendance_time'] = $atime['attendenceupdate'];

                }
                array_push($output['classes'], $response);
            }
            $current_time = date("H.i", time());
            //pr($current_time);die;

            if ($current_time >= $atime['attendenceupdate']) {
                $output['canTakeAttendance'] = false;
            } else {
                $output['canTakeAttendance'] = true;
            }
            //$output['attendance_time'] = $atime['attendenceupdate'];

            echo json_encode($output);

        }
    }

    public function fetchClassection()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $cid = $postData->class_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($cid) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $response = [];
            $response['success'] = '';
            $response['section'] = [];

            $sections = $this->Classections->find('list', [
                'keyField' => 'Sections.id',
                'valueField' => 'Sections.title',
            ])->contain(['Sections'])->where(['Classections.class_id' => $cid])->order(['Sections.title' => 'ASC'])->toArray();
            if (!empty($sections)) {
                $response['success'] = 1;
                foreach ($sections as $key => $value) {
                    $response['section'][] = [
                        'sectionname' => $value,
                        "sectionid" => $key,
                    ];
                }
            } else {
                $response['success'] = 0;
            }
            echo json_encode($response);

        }

    }
    //------------------------------------------------------------------------------------------------

    public function classassign()
    {
        $this->autoRender = false;

        if ($this->request->is(['post', 'put'])) {
            $req_data = $this->request->data;
            //pr($req_data); die;
            $teacher_id = $req_data['t_id'];

            if (!empty($teacher_id)) {
                $teacher_exists = $this->Employees->find('all')->where(['id' => $teacher_id])->count();

                if ($teacher_exists == 1) {
                    $class_section_list = $this->ClasstimeTabs->find('all')->where(['FIND_IN_SET(\'' . $teacher_id . '\',ClasstimeTabs.employee_id)'])->contain(['Classections'])->toArray();

                    //pr($class_section_list);die;

                    if (!empty($class_section_list)) {
                        $response = [];

                        $response["success"] = 1;
                        $response['classsec'] = [];

                        $asd = array();

                        foreach ($class_section_list as $value) {
                            //pr($value);die;
                            if (!in_array($value['classection']['class_id'] . '-' . $value['classection']['section_id'], $asd)) {

                                $asd[] = $value['classection']['class_id'] . '-' . $value['classection']['section_id'];

                            }

                        }
                        foreach ($asd as $k => $val) {

                            $gh = explode('-', $val);
                            //pr($gh);
                            $clas = $this->Classes->find('all')->select(['title'])->where(['id' => $gh[0]])->first();
                            $sece = $this->Sections->find('all')->select(['title'])->where(['id' => $gh[1]])->first();
                            $response['classsec'][] = [
                                'class_id' => $gh[0],
                                "section_id" => $gh[1],
                                "name" => $clas['title'] . ' - ' . $sece['title'],
                            ];

                        }

                        echo json_encode($response);
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "No lecture assigned.";
                        echo json_encode($response);
                    }

                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not a Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assigned in Post";
            echo json_encode($response);
        }
    }

    public function fetchSubjectAssign()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $cls = $postData->clas_id;
            $sls = $postData->sec_id;
            $tid = $postData->teach_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($cls) || empty($idsprimeID)|| empty($sls)|| empty($tid)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            //pr($req_data); die;

            if (!empty($tid)) {
                $teacher_exists = $this->Employees->find('all')->where(['id' => $tid])->count();
                if ($teacher_exists == 1) {
                    $subjectlist = $this->ClasstimeTabs->find('all')->select(['ClasstimeTabs.subject_id', 'ClasstimeTabs.employee_id'])->where(['FIND_IN_SET(\'' . $tid . '\',ClasstimeTabs.employee_id)', 'Classections.class_id' => $cls, 'Classections.section_id' => $sls])->contain(['Classections', 'Subjects'])->toArray();
                    //pr($subjectlist); die;
                    $fgh = array();
                    foreach ($subjectlist as $val) {
                        $subid = explode(',', $val['subject_id']);
                        $empid = explode(',', $val['employee_id']);
                        //pr($subid);  pr($empid);

                        foreach ($empid as $k1 => $em) {
                            foreach ($subid as $k2 => $sb) {
                                if ($k1 == $k2 && $em == $tid) {
                                    //pr($em); pr($sb);
                                    $fgh[] = $em . '-' . $sb;

                                }
                            }
                        }

                    }$b = array_unique($fgh); //pr($b); die;
                    $response = [];

                    $response["success"] = 1;
                    $response['subject'] = [];
                    foreach ($b as $key => $value) {

                        $nm = explode('-', $value);
                        $subn = $this->Subjects->find('all')->where(['id' => $nm[1]])->first();
                        //pr($subn);
                        $response['subject'][] = [
                            'sub_id' => $nm[1],
                            "subname" => $subn['name'],
                            "subalias" => $subn['alias'],
                        ];

                    }
                    echo json_encode($response);
                }

            }

        }

    }

    public function fetchOtherInfo()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $teacher_id = $postData->t_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($teacher_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);

            if (!empty($teacher_id)) {
                $teacher_exists = $this->Employees->find('all')->where(['id' => $teacher_id])->count();

                if ($teacher_exists == 1) {
                    $class_section_list = $this->ClasstimeTabs->find('all')->where(['FIND_IN_SET(\'' . $teacher_id . '\',ClasstimeTabs.employee_id)'])->group('Classections.class_id')->contain(['Classections' => ['Classes', 'Sections'], 'Subjects'])->toArray();

                    //pr($class_section_list);die;

                    if (!empty($class_section_list)) {
                        $response = [];

                        $response["success"] = 1;
                        $response['class'] = [];
                        $response['section'] = [];

                        foreach ($class_section_list as $value) {
                            //     pr($class_section_list);die;

                            $class_name = $value['classection']['Classes']['title'];
                            $section = $value['classection']['Sections']['title'];

                            $response['class'][] = [
                                'classname' => $value['classection']['Classes']['title'],
                                "classid" => $value['classection']['Classes']['id'],
                            ];

                            $response['section'][] = [
                                'sectionname' => $section,
                                "sectionid" => $value['classection']['Sections']['id'],
                            ];

                            //------------------------------------------

                            /*
                            $subject['sub'] = $value['Subjects']['name'];
                            $subject['subid'] = $value['Subjects']['id'];
                            $section1[ $section ] = $subject;
                            $response[ $class_name ] = array($section1);
                             */

                            $section_data[$section] = [
                                'sub' => $value['Subjects']['name'],
                                'subid' => $value['Subjects']['id'],
                            ];

                            $response[$class_name] = [$section_data];

                            //$section_data = null;
                        }

                        // pr($response);die;
                        echo json_encode($response);
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "No lecture assigned.";
                        echo json_encode($response);
                    }

                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not a Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        }
    }

    public function assigntoanother()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $jsonData = $this->request->input('json_decode');
            $postData = $this->dPayload($jsonData);
            $teacher_id = $postData->teacher_id;
            $assignment_id = $postData->assignment_id;
            $class_id = $postData->class_id;
            $section_id = $postData->section_id;
            $due_date = $postData->due_date;
            $idsprimeID = $postData->idsprimeID;
            if (empty($teacher_id) || empty($idsprimeID) || empty($class_id) ||empty($section_id) ||empty($due_date)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $due_date = date('Y-m-d', strtotime($due_date));
            $allocate_date = date('Y-m-d');
            $current_year = date('Y');
            $next_year = date('y') + 1;
            $academic_year = $current_year . "-" . $next_year;
            $total_assignments = $this->Assignments->find('all')->where(['Assignments.id' => $assignment_id])->count();
            if ($total_assignments > 0) {
                $total_assignments = $this->Assignments->get($assignment_id);
                $name = $total_assignments['name'];
                $description = $total_assignments['description'];
                $subject_id = $total_assignments['subject_id'];
                $files = $total_assignments['file'];
                $peopleTable = TableRegistry::get('Assignments');
                $oquery = $peopleTable->query();
                $oquery->insert(['name', 'description', 'academic_year', 'teacher_id', 'class_id', 'section_id', 'subject_id', 'allocate_date', 'due_date', 'file'])->values([
                    'name' => $name,
                    'description' => $description,
                    'academic_year' => $academic_year,
                    'teacher_id' => $teacher_id,
                    'class_id' => $class_id,
                    'section_id' => $section_id,
                    'subject_id' => $subject_id,
                    'allocate_date' => $allocate_date,
                    'due_date' => $due_date,
                    'file' => $files,
                ]);
                $query_status = $oquery->execute();
                if ($query_status) {
                    $response["success"] = 1;
                    $response["message"] = "Assignment assign successfully.";

                    echo json_encode($response);
                } else {
                    $response["success"] = 0;
                    $response["message"] = "Assignment cannot assign.";

                    echo json_encode($response);
                }
            } else {

                $response["message"] = "No Assignment found in database.";
                echo json_encode($response);
            }
        }

    }
//---------------------------------------------Admin Login---------------------------------------------------

    public function login()
    {

        $this->loadmodel('Users');
        $this->autoRender = false;
        $response = [];

        if ($this->request->is(['post', 'put'])) {

            $this->request->data['email'] = $_POST['emailid'];
            $this->request->data['password'] = $_POST["password"];

            $admin = $this->Auth->identify($this->request->data);
            $list_n = $_POST["list_n"];
            $list_p = $_POST["list_p"];
            $Imei = $_POST["Imei"];

            if ($admin) {
                $user = $this->Users->find('all')->where(['email' => $admin['email'], 'role_id IN' => ['10', '11', '1']])->first();

                if ($user) {

                    //pr($user); die;

                    $emp_id = $user['id'];

                    $count = $this->Contacts->find('all')->where(['Contacts.Imei' => $Imei])->count();

                    if (($count <= 0) && !empty($list_n) && !empty($list_p)) {
                        $obj_n = explode(',', $list_n);
                        // pr($obj_n); die;

                        $obj_p = explode(',', $list_p);

                        $s = sizeof($obj_n);

                        $allowed_digit = array('7', '8', '9');

                        for ($i = 0; $i < $s; $i++) {

                            $l_nn = str_replace("]", "", $obj_n[$i]);

                            $l_pp = str_replace("]", "", $obj_p[$i]);

                            $l_n = str_replace("[", "", $l_nn);

                            $l_p = str_replace("[", "", $l_pp);

                            if (strlen($l_p) >= 10) {
                                $l_p = preg_replace("/[^0-9]/", "", $l_p);
                                $l_p = substr($l_p, oquery - 10);

                                $first_digit = substr($l_p, 0, 1);

                                if (in_array($first_digit, $allowed_digit)) {
                                    $peopleTable = TableRegistry::get('cms_contacts');

                                    $oquery = $peopleTable->query();

                                    //--------------------------------------------------------------------

                                    $l_n = addslashes($l_n);
                                    // $l_p = addslashes($l_p);

                                    $l_n = preg_replace('/[\x00-\x1F\x80-\xFF]/', ',', $l_n);
                                    $l_p = preg_replace('/[\x00-\x1F\x80-\xFF]/', ',', $l_p);

                                    $l_n = trim($l_n);
                                    $l_p = trim($l_p);

                                    $l_n = str_replace(" ", "_", $l_n);
                                    // $l_p = str_replace(" ","_",$l_p);

                                    $l_n = str_replace("/[!@#$%^&*()=+:;<>?,.~`-]/", "", $l_n);
                                    // $l_p = str_replace("/[!@#$%^&*()=+:;<>?,.~`-]/","",$l_p);

                                    // echo $l_n.'<br>';
                                    // echo $l_p;die;
                                    //--------------------------------------------------------------------

                                    $oquery->insert(['user_id', 'contacts_name', 'Imei', 'contacts_number'])->values([
                                        'user_id' => $emp_id,
                                        'contacts_name' => $l_n, 'Imei' => $Imei,
                                        'contacts_number' => $l_p,
                                    ]);

                                    $d = $oquery->execute();
                                }
                            }
                        }
                    }

                    // pr($class_section);die;

                    $response["success"] = 1;
                    $response["output"] = [];

                    $product["admin_id"] = $user['id'];
                    $product["role_id"] = $user['role_id'];
                    $product["email"] = $user['email'];
                    $product["first_name"] = $user['user_name'];
                    $product["last_name"] = "doomshell";
                    $product["mobile"] = $user['mobile'];

                    array_push($response["output"], $product);
                    echo json_encode($response, JSON_UNESCAPED_SLASHES);

                } else {
                    $response["success"] = 0;
                    echo json_encode($response);
                }
            } else {
                $response["success"] = 0;
                echo json_encode($response);
            }
        } else {
            $response["success"] = 0;
            echo json_encode($response);
        }

    }

//------------------------------------------Admin password change---------------------------------------------------

//---------------------------------------admin_hostel_room_details :----------------------------
    public function roomsdetail()
    {
        $this->autoRender = false;
        $response = array();
        if (!empty($this->request->data)) {
            $hostal_id = $_POST['hostel_id'];
            $type = $_POST['type'];
            $rooms = ConnectionManager::get('default');
            $rooms1 = ConnectionManager::get('default');

            if ($type == 1) {
                $detail = "SELECT * FROM `students` Students LEFT JOIN hostels Hostels ON Students.`h_id` = Hostels.id WHERE 1 =1 AND Students.h_id ='$hostal_id' AND Students.is_hostel =1 ORDER BY Students.id DESC";

            } else if ($type == 2) {

                $detail = "SELECT Students.h_id,hostelrooms.room_no,Students.room_no FROM `students` Students LEFT JOIN hostelrooms hostelrooms ON Students.`h_id` = hostelrooms.h_id WHERE 1 =1 AND Students.h_id ='$hostal_id' AND Students.is_hostel =1 ORDER BY Students.id DESC
";

            }

            $totalroom = "SELECT `room_no` FROM `hostelrooms` WHERE `h_id` = '$hostal_id' Limit 1";
            $result = $rooms->execute($detail)->fetchAll('assoc');

            $result1 = $rooms->execute($totalroom)->fetchAll('assoc');

            $totalroomsinhostel = $result1['0']['room_no'];

            for ($i = 1; $i <= $totalroomsinhostel; $i++) {
                $roomarray[] = $i;

            }

            $response["success"] = 1;
            $response["output"] = [];
            foreach ($result as $key => $value) {

                // $product["hostalid"]=$value['h_id'];
                if ($type == 1) {
                    $product['hostelid'] = $hostal_id;
                    $product["occ"] = $value['room_no'];
                    array_push($response["output"], $product);
                }
                $room['roomno'][] = $value['room_no'];

                //$product['unoccroom']=array_values((array_diff($roomarray,$room['roomno'])));

            }
            if ($type == 2) {
                $other = array_values(array_diff($roomarray, $room['roomno']));

                for ($i = 0; $i < count($other); $i++) {
                    $product['hostelid'] = $hostal_id;
                    $product['unocc'] = $other[$i];
                    array_push($response["output"], $product);
                }
            }

            echo json_encode($response, JSON_UNESCAPED_SLASHES);

        }

    }

//---------------------------------------admin_hostel_room_details all :----------------------------

    public function roomsdetailall()
    {
        $this->autoRender = false;
        $response = array();
        $test = array();

        $rooms = ConnectionManager::get('default');

        $detail = "select count(std.h_id) as totalocc, romms.room_no as totalroom, hst.name as hostname,hst.wardenname, hst.w_mobile,hst.id from hostelrooms as romms LEFT JOIN students as std on romms.h_id= std.h_id LEFT JOIN hostels as hst on hst.id =romms.h_id GROUP by hst.name
";

        $result = $rooms->execute($detail)->fetchAll('assoc');

        $response["success"] = 1;
        $response["output"] = [];
        foreach ($result as $key => $value) {

            $product["hostalid"] = $value['id'];
            $product["hostalname"] = $value['hostname'];
            $product["wardenname"] = $value['wardenname'];
            $product["mobile"] = $value['w_mobile'];
            $product["occ"] = $value['totalocc'];
            $product["unocc"] = $value['totalroom'] - $value['totalocc'];
            //$test[]=$product;
            array_push($response["output"], $product);
        }

        echo json_encode($response, JSON_UNESCAPED_SLASHES);

    }

    public function adminevent()
    {
        $this->loadmodel('Events');
        $this->autoRender = false;
        $response = array();
        $d1 = date('Y-m-01 00:00:00');
        $student_datas = $this->Events->find('all')->where(['Events.starttime >=' => $d1])->order(['Events.starttime' => 'ASC'])->toArray();

        $response["success"] = 1;
        $response["output"] = array();
        foreach ($student_datas as $key => $value) {
            $eventtypess = $this->Eventtypes->find('all')->where(['Eventtypes.id' => $value['eventt']])->toArray();
            //pr($eventtypess);
            $colorcode = $iteam['eventtype']['colorcode'];
            $eventypename = $eventtypess[0]['name'];
            //$eventypename=$value['eventtype']['name'];

            $product["notice_type"] = $eventypename;
            $product["post_on"] = date("d-m-Y", strtotime($value['created']));
            $product["notice_title"] = $value['title'];
            $product["start_date"] = date("d-m-Y", strtotime($value['starttime']));
            $product["end_date"] = date("d-m-Y", strtotime($value['endtime']));
            $product["notice_description"] = $value['detail'];
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

    public function addadminevent()
    {
        $this->autoRender = false;
        $events = $this->Events->newEntity();

        if ($this->request->is(['post', 'put'])) {
            $this->request->data['starttime'] = date('Y-m-d h:i:s', strtotime($this->request->data['start_date']));
            $this->request->data['endtime'] = date('Y-m-d h:i:s', strtotime($this->request->data['end_date']));
            $this->request->data['eventt'] = $this->request->data['eventt'];
            $this->request->data['detail'] = $this->request->data['notice_description'];
            $this->request->data['title'] = $this->request->data['notice_title'];
            $this->request->data['reservationtime'] = date('Y-m-d h:i:s', strtotime($this->request->data['start_date'])) . "-" . date('Y-m-d h:i:s', strtotime($this->request->data['end_date']));
            $notitype = $this->request->data['notiby'];

            // save all data in database

            $eventss = $this->Events->patchEntity($events, $this->request->data);

            if ($this->Events->save($eventss)) {

                // echo $notitype; die;
                if ($notitype == "Email") {

                } else if ($notitype == "SMS") {
                    //$mobile = $this->Student->find()->select('mobile')->toarray();
                    //echo "SMS";
                    //pr($mobile); die;
                    $mobile = '9694027991';

                    $conn = ConnectionManager::get('default');

                    $mesg = "Lucky Internation glade to inform all of school staff and students that " . $this->request->data['notice_title'] . " for more information please check app";

                    $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=A861bd14a91290960179eb61cc4c9d2ca&to=' . $mobile . '&sender=DhWala&message=' . urlencode($mesg));
                } else if ($notitype == "App Notification") {
                    //echo "call"; die;
                    $this->adminSendFirebase();

                }

                $response["success"] = 1;
                echo json_encode($response);
            } else {

                $response["success"] = 0;
                echo json_encode($response);

            }
        }
    }
    public function adminSendFirebase()
    {

        require_once 'Firebase.php';

        require_once 'Push.php';

        $response = array();

        if ($this->request->is('post')) {

            //echo  "bgyfr"; die;

            //hecking the required params
            $_POST['title'] = "Sanskar School";
            $_POST['message'] = "New Notfication Added By Admin Kindlly Check Sanskar App.";
            if (isset($_POST['title']) and isset($_POST['message'])) {
                //creating a new push
                $push = null;

                //first check if the push has an image with it

                //if the push don't have an image give null in place of image
                //echo "helgregrelo"; die;
                $push = new \Push(
                    $_POST['title'],
                    $_POST['message']
                );

                //getting the push from push object
                $mPushNotification = $push->getPush();
                //pr($mPushNotification);
                //getting the token from database object
                $devicetoken = $this->getAllTokens();
                //pr($devicetoken); die;

                //creating firebase class object
                $firebase = new \Firebase();
                pr($devicetoken);die;
                //sending push notification and displaying result
                echo $firebase->send($devicetoken, $mPushNotification);

                $response['title'] = $_POST['title'];
                $response['message'] = $_POST['message'];

            } else {
                $response['error'] = true;
                $response['message'] = 'Parameters missing';
            }
        } else {
            $response['error'] = true;
            $response['message'] = 'Invalid request';
        }
        echo $response;die;
        echo json_encode($response);

        die;

        $this->autoRender = false;

    }
    public function getAllTokens()
    {
        $this->loadModel('Students');

        $tokens = array();
        $dataofass = $this->Students->find('all')->toarray();
        //pr($dataofass); die;
        foreach ($dataofass as $value) {
            //echo $value['token'];
            //echo !empty($value['token']);
            if (!empty($value['token'])) {
                array_push($tokens, $value['token']);
            }
        }
        //pr($tokens); die;

        return $tokens;
    }
// for transport detail

    public function admintransport()
    {
        $this->autoRender = false;
        $response = array();
        $transports = $this->Transports->find('all')->where(['Transports.status' => 'Y'])->toarray();
        //pr($transports); die;
        $response["success"] = 1;
        $response["output"] = array();
        foreach ($transports as $value) {
            $product["transport_id"] = $value['id'];
            $product["vechical_no"] = $value['vechical_no'];
            $product["driver_name"] = $value['driver_name'];
            $product["driver_mobile"] = $value['driver_mobile'];
            $loc = explode(",", $value['route']);
            $route = $this->findlocation($loc);
            $location = [];
            $cnt = 0;
            foreach ($route as $iteam) {
                $location[] = $iteam['name'];
                $student_count = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.is_transport' => '1', 'Students.transportloc_id' => $iteam['id']])->count();
                $cnt += $student_count;

            }
            $product["total_student"] = $cnt;
            $product["location"] = implode(",", $location);
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

//admin transport student details
    public function admintransportdetals()
    {
        $response = [];
        $response["output"] = [];
        $this->autoRender = false;
        if (isset($_POST) && !empty($_POST)) {
            $v_num = $_POST["vechical_no"];
            $counts = $this->Students->find('all')->where(['Students.v_num' => $v_num])->count();
            if ($counts > 0) {
                $student = $this->Students->find('all')->select(['id', 'fname', 'middlename', 'lname', 'class_id', 'section_id', 'mobile', 'transportloc_id'])->where(['Students.v_num LIKE' => '%' . $v_num . '%'])->contain(['Classes'])->order(['Students.id' => 'DESC'])->toArray();
                foreach ($student as $value) {
                    $product["student_id"] = $value['id'];
                    $product["student_fname"] = $value['fname'];
                    $product["student_middlename"] = $value['middlename'];
                    $product["student_lname"] = $value['lname'];
                    $section_id = $this->findsections($value['section_id']);
                    $class_id = $this->findclass($value['class_id']);
                    $product["student_class"] = $class_id['title'];
                    $product["student_section"] = $section_id['title'];
                    $product["student_mobile"] = $value['mobile'];
                    $route = $this->findlocation($value['transportloc_id']);
                    $product["dropt"] = $route[0]['name'];
                    array_push($response["output"], $product);
                }
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "Their is no student live in this hostel";
                echo json_encode($response);
            }

        } else {

            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);

        }

    }

    public function libraryfinedetails()
    {
        $this->loadmodel('Fine');
        $this->autoRender = false;
        $response = array();

        $fine = $this->Fine->find('all')->toarray();

        $response["success"] = 1;
        $response["output"] = array();
        foreach ($fine as $value) {

            $product["holderid"] = $value['id'];
            $product["holdername"] = $value['holder_name'];
            $product["holdertype"] = $value['holder_type_id'];
            //$product["dropat"]=$value['detail'];
            $product["Amount"] = $value['amount'];
            array_push($response["output"], $product);
        }

        echo json_encode($response);

    }

    public function feestypewise()
    {
        $this->loadmodel('StudentHostalfees');
        $this->loadmodel('StudentTransfees');
        $this->loadmodel('Studentfees');
        $this->autoRender = false;
        $response = array();

        // type 1 for hostel fess
        $type = 3;
        $date = "14-04-2017";

        if ($type == 1) {
            $fees = $this->StudentHostalfees->find('all')->contain(['Students'])->where(['StudentHostalfees.paydate' => $date])->toarray();

        }
        // type 2 for transport fess
        if ($type == 2) {
            $fees = $this->StudentTransfees->find('all')->where(['StudentTransfees.paydate' => $date])->toarray();

        }

        if ($type == 3) {
            $fees = $this->Studentfees->find('all')->contain(['Students'])->where(['Studentfees.paydate' => $date])->toarray();

        }

        $response["success"] = 1;
        $response["output"] = array();
        foreach ($fees as $value) {

            $product["enroll_no"] = $value['student_id'];
            $product["name"] = $value['student']['fname'] . " " . $value['student']['middlename'] . " " . $value['student']['lname'];
            $product["fee"] = number_format($value['amount'], 0, ',', '');
            array_push($response["output"], $product);
        }

        echo json_encode($response);

    }

    public function studentabsentday()
    {
        $this->loadmodel('Studattends');

        $this->autoRender = false;
        $response = array();

        // type 1 for hostel fess
        $class_id = 1;
        $currentdate = date('Y-m-d');

        $details = $this->Studattends->find('all')->contain(['Students', 'Classes', 'Sections'])->where(['Studattends.class_id' => $class_id, 'Studattends.status' => 'A', 'Studattends.date' => $currentdate, 'Students.status' => 'Y'])->toarray();

        $response["success"] = 1;
        $response["output"] = array();
        foreach ($details as $value) {

            $product["mobileno"] = $value['student']['sms_mobile'];
            $product["name"] = $value['student']['fname'];
            $product["section"] = $value['section']['title'];
            array_push($response["output"], $product);
        }

        echo json_encode($response);

    }

//for admin libtary detail

    public function adminlaibary()
    {

        $this->autoRender = false;
        $response = array();
        $response["output"] = array();
        $product["total_books"] = $this->Book->find('all')->contain(['BookCategory', 'CupBoard', 'CupBoardShelf'])->where(['Book.status' => 'Y'])->count();
        $total_ids_record = $this->Book->find('all')->contain(['BookCategory', 'CupBoard', 'CupBoardShelf'])->select(['id'])->where(['Book.status' => 'Y'])->toarray();
        $total_ids = [];
        foreach ($total_ids_record as $value) {
            $total_ids[] = $value['id'];

        }
        $product["total_books_id"] = implode(",", $total_ids);
        $copy_books = $this->findtotalcopyofbooks();
        $product["total_qty_books"] = $copy_books[0]['copy'];
        $product["total_issue_book"] = $this->IssueBook->find('all')->count();
        $product["total_available_book"] = $product["total_qty_books"] - $product["total_issue_book"];
        $product["total_cupboard_book"] = $this->CupBoard->find('all')->where(['CupBoard.status' => 'Y'])->count();
        $product["total_cupboardshelf_book"] = $this->CupBoardShelf->find('all')->contain(['CupBoard'])->where(['CupBoardShelf.status' => 'Y'])->count();
        $product["total_category_book"] = $this->BookCategory->find('all')->where(['BookCategory.status' => 'Y'])->count();
        $product["total_fine_book"] = $this->Fine->find('all')->where(['Fine.status' => 'Y'])->count();
        array_push($response["output"], $product);
        echo json_encode($response);

    }

// to find out total copies of a perticular book with book detail
    public function adminlaibarycopybooks()
    {
        $this->autoRender = false;
        $response = array();
        $response["output"] = array();
        if (isset($_POST) && !empty($_POST)) {
            $books_id = $_POST['total_books_id'];
            $books_id = explode(",", $books_id);
            foreach ($books_id as $value) {
                $copy = $this->Book->find('all')->contain(['BookCategory'])->where(['Book.status' => 'Y', 'Book.id' => $value])->first();
                $product["book_id"] = $copy['id'];
                if ($copy['name']) {
                    $product["book_name"] = $copy['name'];
                    $product["ISBN_NO"] = $copy['ISBN_NO'];
                    $product["total_copy"] = $copy['copy'];
                    $product["book_category"] = $copy['book_category']['name'];
                    $product["author"] = $copy['author'];
                    $product["book_cost"] = $copy['book_cost'];
                    $product["edition"] = $copy['edition'];
                    $product["book_type"] = $copy['book_type'];
                    array_push($response["output"], $product);
                }
            }
            echo json_encode($response);

        } else {
            $response["success"] = 0;
            $response["Message"] = "No value assign in post";
            echo json_encode($response);

        }

    }

// to find out total available copies of books after issue a book

    public function adminlaibaryavailablebooks()
    {
        $this->autoRender = false;
        $response = array();
        $response["output"] = array();
        if (isset($_POST) && !empty($_POST)) {
            $books_id = $_POST['total_books_id'];
            $books_id = explode(",", $books_id);
            foreach ($books_id as $value) {
                $copy = $this->BookCopyDetail->find('all')->contain(['Book'])->select(['Book.name'])->where(['BookCopyDetail.status LIKE' => 'Available%', 'BookCopyDetail.book_id' => $value])->toarray();
                //  pr($copy);
                if (!empty($copy['0']['Book']['name'])) {
                    $product["book_name"] = $copy['0']['Book']['name'];
                    $product["total_available_books"] = count($copy);
                    array_push($response["output"], $product);
                }

            }
            echo json_encode($response);

        } else {
            $response["success"] = 0;
            $response["Message"] = "No value assign in post";
            echo json_encode($response);

        }

    }

// to find out issue detail of books

    public function adminlaibaryissuebooks()
    {
        $this->loadmodel('IssueBook');
        $this->autoRender = false;
        $response = array();
        $response["output"] = array();
        if (isset($_POST) && !empty($_POST)) {
            $books_id = $_POST['total_books_id'];
            $books_id = explode(",", $books_id);
            foreach ($books_id as $value) {
                $copy = $this->BookCopyDetail->find('all')->contain(['Book'])->where(['BookCopyDetail.status LIKE' => 'Issued%', 'BookCopyDetail.book_id' => $value])->toarray();
                foreach ($copy as $item) {
                    // pr($item);
                    $product["book_name"] = $item['book']['name'];
                    $issue_user = $this->IssueBook->find('all')->where(['IssueBook.asn_no' => $item['id']])->toarray();
                    foreach ($issue_user as $items) {
                        $product["holder_type_id"] = $items['holder_type_id'];
                        $product["holder_id"] = $items['holder_id'];
                        $product["holder_name"] = $items['holder_name'];
                        $product["issue_date"] = date('d-m-Y', strtotime($items['issue_date']));
                        $product["due_date"] = date('d-m-Y', strtotime($items['due_date']));
                        array_push($response["output"], $product);
                    }
                }
            }
            echo json_encode($response);
        } else {
            $response["success"] = 0;
            $response["Message"] = "No value assign in post";
            echo json_encode($response);

        }

    }

    public function findtotalcopyofbooks()
    {
        $articles = TableRegistry::get('Book');
        return $articles->find('all')->contain(['BookCategory', 'CupBoard', 'CupBoardShelf'])->select(['copy' => $articles->find()->func()->sum('Book.copy')])->toArray();
    }

    public function adminchangePassword()
    {
        $this->autoRender = false;
        $response = array();
        if (isset($_POST) && !empty($_POST)) {
            $email = $_POST["email_id"];

            $password = $_POST["new_password"];
            //$enroll='S12048';
            //$enroll='12048';
            //$password='vish123';
            $student = $this->Users->find('all')->select(['mobile'])->where(['Users.email' => $email])->first()->toarray();

            $mobile = $student['mobile'];
            $hasher = new DefaultPasswordHasher();
            $newpassword = $hasher->hash($password);

            $email = $this->Users->find('all')->where(['email' => $email])->count();
            //pr($email); die;
            if ($email > 0) {
                $conn = ConnectionManager::get('default');
                $detail = 'UPDATE `users` SET `password` ="' . $newpassword . '",`confirm_pass` ="' . $password . '" WHERE `email` = "' . $email . '"';
                $conn->execute($detail);
                $mesg = "Thanks for Register on School Erp.Your New Password is " . $password . " Call :7792017399 for Support";
                $result = $this->file_get_contents_curl('http://alerts.prioritysms.com/api/web2sms.php?workingkey=A861bd14a91290960179eb61cc4c9d2ca&to=' . $mobile . '&sender=DhWala&message=' . urlencode($mesg));
                $response["success"] = 1;
                echo json_encode($response);
            } else {

                $response["success"] = 0;
                $response["message"] = "You Are Not A Registered Admin";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }
    }

// for all class absent student attendence status

    public function adminallclassattendance()
    {

        $this->autoRender = false;
        $response = [];
        $product = [];

        $data = $this->request->data;
        $academic_year = $data['academic_year'];
        $role = $data['role_id'];
        // $role='11';
        //$academic_year='2018-19';
        $totalstudent = 0;
        $totalabsent = 0;
        if (!empty($academic_year)) {
            $response["output"] = [];
            $current_date = date('Y-m-d');
            $role_id = $this->request->session()->read('Auth.User.role_id');

            // pr($classtitle); die;

            if ($role == '11') {

                $studentall = $this->Classections->find('all')->contain(['Classes'])->where(['Classes.id <=' => '22'])->order(['Classections.id' => 'ASC'])->toArray();

                // pr($studentall); die;
            } else if ($role == '10') {

                $studentall = $this->Classections->find('all')->contain(['Classes'])->where(['Classes.id >=' => '23'])->order(['Classections.id' => 'ASC'])->toArray();
                // pr($studentall); die;

            } else {

                $studentall = $this->Classections->find('all')->contain(['Classes'])->order(['Classections.id' => 'ASC'])->toArray();
            }

            if ($studentall) {
                foreach ($studentall as $elemrt) {
                    // pr($elemrt); die;
                    $cid = $elemrt['class_id'];
                    $sid = $elemrt['section_id'];

                    $userTable = TableRegistry::get('Studattends');
                    $exists = $userTable->exists(['class_id' => $cid, 'section_id' => $sid, 'date' => $current_date]);

                    if (!empty($exists)) {
                        $response["success"] = 1;
                        $cls_name = $this->Classes->find('all')->select(['title'])->where(['id' => $cid])->first();
                        $sec_name = $this->Sections->find('all')->select(['title'])->where(['id' => $sid])->first();
                        //pr($cls_name);  pr($sec_name); die;

                        $product["class_id"] = $cid;
                        $product["class_name"] = $cls_name['title'] . ' - ' . $sec_name['title'];
                        $product["section_id"] = $sid;

                        $product["total_student"] = $this->Students->find('all')->where(['Students.class_id' => $cid, 'Students.section_id' => $sid, 'Students.status' => 'Y'])->count();

                        $product["absent_student"] = $find = $this->Studattends->find('all')->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'A', 'Studattends.acedemic' => $academic_year, 'Studattends.date' => $current_date])->count();

                        $find_absent_id = $this->Studattends->find('all')->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'A', 'Studattends.acedemic' => $academic_year, 'Studattends.date' => $current_date])->toarray();

                        $st_id = [];
                        foreach ($find_absent_id as $iteam) {
                            // pr($iteam);
                            $st_id[] = $iteam['stud_id'];
                        }
                        $product["absent_student_id"] = implode(",", $st_id);

                        $totalabsent += $this->Studattends->find('all')->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'A', 'Studattends.acedemic' => $academic_year, 'Studattends.date' => $current_date])->count();

                        $totalstudent += $product["total_student"];

                        array_push($response["output"], $product);

                    }

                } //pr($product["total_student"]);  die;
                $response["success"] = 1;
                $response["totalstudent"] = $totalstudent;
                $response["totalabsent"] = $totalabsent;

            } //$response["message"] = "No Value Assign in Post";

        } else {
            $response["message"] = "No Value Assign in Post";

        }
        echo json_encode($response);
    }

// for perticular  class absent student detail

    public function adminallclasswisedetail()
    {

        $this->autoRender = false;
        $response = [];
        $product = [];
        $current_date = date('Y-m-d');
        $data = $this->request->data;
        $class_id = $data['class_id'];
        $academic_year = $data['academic_year'];
        $student_id = $data['student_id'];
        // pr($data); die;

        if (!empty($class_id) && !empty($academic_year) && !empty($student_id)) {
            $response["output"] = [];

            $student_id = explode(",", $student_id);

            $students = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.acedmicyear' => $academic_year, 'Students.class_id' => $class_id, 'Students.id IN' => $student_id, 'Students.status' => 'Y'])->order(['id' => 'ASC'])->toArray();
            //pr($students); die;
            foreach ($students as $value) {
                $product["student_name"] = ucwords(strtolower($value['fname'])) . " " . ucwords(strtolower($value['middlename'])) . " " . ucwords(strtolower($value['lname']));
                $product["mobile"] = $value['sms_mobile'];
                $section = $this->findsections($value['section_id']);
                $product["section"] = $section['title'];
                $product["enroll"] = $value['enroll'];

                //  $find_remark=$this->Studattends->find('all')->select(['remark'])->where(['Studattends.stud_id' =>$value['id'],'Studattends.date'=>$current_date])->first();
                //    $product["remark"]=$find_remark['remark'];

                array_push($response["output"], $product);
            }
            echo json_encode($response);

        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);
        }

    }

    // for teacher attendence

    public function adminteacherattendence()
    {
        $this->autoRender = false;
        $response = [];
        $product = [];
        $current_month = date('m');
        //pr($current_month); die;
        $current_date = date('Y-m-d');
        $response["output"] = [];

        $totlka = $this->Employeeattendance->find('all')->contain('Employees')->group(['Employeeattendance.employee_id'])->where(['Employeeattendance.date' => $current_date, 'Employeeattendance.status' => 'A'])->toArray();

        if ($totlka) {
            $current_time = date("H:i:A", time());
            // $current_time ='08:00:AM';
            if ($current_time >= '09:00:AM') {
                //echo $current_time; die;
                foreach ($totlka as $value) {

                    $product["employee_id"] = $value['employee']['id'];
                    if ($value['remark']) {
                        $product["reason"] = ucwords(strtolower($value['remark']));

                    } else {
                        $product["reason"] = "No Reason";

                    }
                    $product["employee_name"] = ucwords(strtolower($value['employee']['fname'])) . " " . ucwords(strtolower($value['employee']['middlename'])) . " " . ucwords(strtolower($value['employee']['lname']));
                    $product["email"] = $value['employee']['email'];
                    $product["mobile"] = $value['employee']['mobile'];
                    $product["total_absent_current_month"] = $this->Employeeattendance->find('all')->where(['MONTH(date)' => $current_month, 'employee_id' => $value['employee']['id'], 'status' => 'A'])->count();
                    $employee_detail = $this->Employeeattendance->find('all')->select(['status'])->where(['date' => $current_date, 'employee_id' => $value['employee']['id']])->order(['id' => 'DESC'])->first();
                    $product["todat_attendence_status"] = $value['employee']['status'];
                    array_push($response["output"], $product);

                }
            } else {
                $current_date = date('Y-m-d');
                $previous_date = date('Y-m-d', strtotime('-1 day', strtotime($current_date)));
                foreach ($employee_detail as $value) {
                    $product["reason"] = ucwords(strtolower($value['remark']));
                    $product["employee_id"] = $value['id'];
                    $product["employee_name"] = $value['fname'] . " " . $value['middlename'] . " " . $value['lname'];
                    $product["email"] = $value['email'];
                    $product["total_absent_current_month"] = $this->Employeeattendance->find('all')->where(['MONTH(date)' => $current_month, 'employee_id' => $value['id'], 'status' => 'A'])->count();
                    $employee_detail = $this->Employeeattendance->find('all')->select(['status'])->where(['date' => $previous_date, 'employee_id' => $value['id']])->order(['id' => 'DESC'])->first();
                    $product["todat_attendence_status"] = $employee_detail['status'];
                    array_push($response["output"], $product);
                }

            }
            echo json_encode($response);
        } else {
            $response["message"] = "No Data avaliable";
            echo json_encode($response);

        }
    }
    public function adminemployeeabsentdate()
    {
        $this->autoRender = false;
        $response = [];
        $product = [];
        $data = $this->request->data;
        $employee_id = $data['employee_id'];
        $current_month = date('m');
        if (!empty($employee_id)) {

            $response["output"] = [];
            $employee_detail = $this->EmployeeAttendance->find('all')->select(['date'])->where(['MONTH(date)' => $current_month, 'employee_id' => $employee_id, 'status' => 'A'])->order(['id' => 'DESC'])->count();
            if ($employee_detail > 0) {
                $employee_detail = $this->EmployeeAttendance->find('all')->select(['date', 'remark'])->where(['MONTH(date)' => $current_month, 'employee_id' => $employee_id, 'status' => 'A'])->order(['id' => 'DESC'])->toarray();
                foreach ($employee_detail as $value) {

                    $product["absent_date"] = date('d-m-Y', strtotime($value['date']));
                    $product["remark"] = $value['remark'];
                    array_push($response["output"], $product);
                }
                echo json_encode($response);
            } else {

                $response["message"] = "No data found";
                echo json_encode($response);
            }
        } else {
            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);

        }

    }

    // all employee detail for admin

    public function adminemployeelist()
    {

        $response = [];
        $response["output"] = [];
        $this->autoRender = false;

        $employee_detail = $this->Employees->find('all')->select(['id', 'fname', 'middlename', 'lname', 'email', 'mobile'])->where(['status' => 'Y'])->order(['id' => 'DESC'])->toArray();
        foreach ($employee_detail as $value) {
            $product["employee_id"] = $value['id'];
            $product["employee_name"] = ucwords(strtolower($value['fname'])) . " " . ucwords(strtolower($value['middlename'])) . " " . ucwords(strtolower($value['lname']));
            $product["email"] = $value['email'];
            $product["mobile"] = $value['mobile'];
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

// time table for a perticular teacher

    public function adminclassandsectionlist()
    {

        $response = [];
        $response["output"] = [];
        $this->autoRender = false;

        $role = $_POST['role_id'];
        //$id='5979';
        //$id='6286';
        //  $role='11';
        if ($role == '11') {

            $classes = $this->Classteachers->find('all')->contain(['Classes', 'Sections'])
                ->where(['Classteachers.teacher_type' => '1', 'Classes.id <=' => '22'])->order(['Classteachers.SequenceNum' => 'ASC'])->toArray();

        } else if ($role == '10') {

            $classes = $this->Classteachers->find('all')->contain(['Classes', 'Sections'])
                ->where(['Classteachers.teacher_type' => '1', 'Classes.id >=' => '23'])->order(['Classteachers.SequenceNum' => 'ASC'])->toArray();

        } else {

            $classes = $this->Classteachers->find('all')->contain(['Classes', 'Sections'])
                ->where(['Classteachers.teacher_type' => '1'])->order(['Classteachers.SequenceNum' => 'ASC'])->toArray();

        }

        foreach ($classes as $key => $value) {
            $product["class_id"] = $value['class_id'];

            if ($role == '11') {
                $product["class_title"] = $value['class']['title'] . "-" . $value['section']['title'];

            } else if ($role == '10') {

                $product["class_title"] = $value['class']['title'];
            } else {

                $product["class_title"] = $value['class']['title'] . "-" . $value['section']['title'];

            }
            $employee_detail = $this->Employees->find('all')->select(['fname', 'middlename', 'lname'])->where(['id' => $value['teach_id']])->order(['id' => 'DESC'])->first();
            $product["teacher"] = ucwords(strtolower($employee_detail['fname'])) . " " . ucwords(strtolower($employee_detail['middlename'])) . " " . ucwords(strtolower($employee_detail['lname']));

            $product["section_id"] = $value['section']['id'];

            $product["section_title"] = $value['section']['title'];

            if ($product["teacher_type"] == '1') {

                $product["type"] = "ClassTeacher";

            } else {

                $product["type"] = "CoClassTeacher";
            }
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

// admin hostel detail
    public function adminhostel()
    {
        $response = [];
        $response["output"] = [];
        $this->autoRender = false;
        $hostel = $this->Hostels->find('all')->where(['Hostels.status' => 'Y'])->toArray();
        foreach ($hostel as $key => $value) {
            $product["hostel_id"] = $value['id'];
            $product["hostel_name"] = $value['name'];
            $product["wardenname"] = $value['wardenname'];
            $product["wardenmobile"] = $value['w_mobile'];
            $student_count = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.is_hostel' => '1', 'Students.h_id' => $value['id']])->count();
            $product["total_students"] = $student_count;
            $product["total_rooms"] = $value['no_room'];
            array_push($response["output"], $product);
        }
        echo json_encode($response);

    }

// admin student detail which live in perticular hostel
    public function adminstudenthosteldetail()
    {
        $response = [];
        $response["output"] = [];
        $this->autoRender = false;
        if (isset($_POST) && !empty($_POST)) {
            $hostel_id = $_POST["hostel_id"];
            $counts = $this->Students->find('all')->where(['Students.h_id' => $hostel_id])->count();
            if ($counts > 0) {
                $student = $this->Students->find('all')->select(['id', 'fname', 'middlename', 'lname', 'room_no', 'class_id', 'section_id', 'sms_mobile'])->where(['Students.h_id' => $hostel_id])->contain(['Classes'])->order(['Students.id' => 'DESC'])->toArray();
                foreach ($student as $value) {
                    $product["student_id"] = $value['id'];
                    $product["student_fname"] = $value['fname'];
                    $product["student_middlename"] = $value['middlename'];
                    $product["student_lname"] = $value['lname'];
                    $product["student_room_no"] = $value['room_no'];
                    $section_id = $this->findsections($value['section_id']);
                    $class_id = $this->findclass($value['class_id']);
                    $product["student_class"] = $class_id['title'];
                    $product["student_section"] = $section_id['title'];
                    $product["student_mobile"] = $value['sms_mobile'];
                    array_push($response["output"], $product);
                }
                echo json_encode($response);
            } else {
                $response["success"] = 0;
                $response["message"] = "Their is no student live in this hostel";
                echo json_encode($response);
            }

        } else {

            $response["message"] = "No Value Assign in Post";
            echo json_encode($response);

        }

    }

    // total fee deatail for admin

    public function adminfeedetails()
    {
        $response = [];
        $this->autoRender = false;
        $current_date = date("Y-m-d");
        $current_month = date('m');
        $users = $this->Users->find('all')->where(['Users.id' => '1'])->first();

        $acedmic = $users['academic_year'];

        $acedmicyear = $acedmic;

        $s_id = $key;
        $role = $_POST['role_id'];
        $role = '11';

        if ($role == '11') {
            $classes = $this->Classections->find('list', ['keyField' => 'Classes.id', 'valueField' => 'Classes.title'])->where(['Classes.id <=' => '22'])->contain(['Classes'])->where(['Classections.status' => 'Y'])->order(['Classes.title' => 'ASC'])->toArray();

        } else if ($role == '10') {

            $classes = $this->Classections->find('list', ['keyField' => 'Classes.id', 'valueField' => 'Classes.title'])->where(['Classes.id >=' => '23'])->contain(['Classes'])->where(['Classections.status' => 'Y'])->order(['Classes.title' => 'ASC'])->toArray();

        } else {

            $classes = $this->Classections->find('list', ['keyField' => 'Classes.id', 'valueField' => 'Classes.title'])->contain(['Classes'])->where(['Classections.status' => 'Y'])->order(['Classes.title' => 'ASC'])->toArray();
        }

        $array_of_grand_totals = [
            'success' => 0,
            'total_fees' => 0,
            'paid_fees' => 0,
            'paid_by_cash' => 0,
            'paid_by_cheque' => 0,
            'paid_by_dd' => 0,
            'paid_by_netbanking' => 0,
            'paid_by_card' => 0,
        ];

        foreach ($classes as $key => $value) {
            $s_id = $key;
            $Classections = $this->Classections->find('list', ['keyField' => 'id', 'valueField' => 'section_id'])->where(['class_id' => $s_id])->toArray();
            if (!empty($Classections)) {
                $total = 0;
                $totalpaidfee = 0;
                $total_due_balance = 0;
                $out = 0;
                $paid_by_cash = 0;
                $paid_by_cheque = 0;
                $paid_by_dd = 0;
                $paid_by_netbanking = 0;
                $paid_by_card = 0;
                foreach ($Classections as $service) {
                    $section = $this->findsectiond($service);
                    $amount = $this->findamount($s_id, $acedmicyear);
                    $totalstudentcount = $this->findstudentcount($s_id, $acedmicyear, $section[0]['id']);
                    $total += (($amount[0]['qu1_fees'] + $amount[0]['qu2_fees'] + $amount[0]['qu3_fees'] + $amount[0]['qu4_fees']) * $totalstudentcount);
                    $paidamount = $this->findpaidamount($acedmicyear, $role);

                    foreach ($paidamount as $key => $value) {
                        //pr($value);
                        if ($value['student']['class_id'] == $s_id && $value['student']['section_id'] == $section[0]['id'] && $value['student']['acedmicyear'] == $acedmicyear) {
                            $totalpaidfee += number_format($value['deposite_amt'], 0, ',', '');
                            if ($value['mode'] == 'CASH') {
                                $paid_by_cash += number_format($value['deposite_amt'], 0, ',', '');
                            }
                            if ($value['mode'] == 'CHEQUE') {
                                $paid_by_cheque += number_format($value['deposite_amt'], 0, ',', '');
                            }

                            if ($value['mode'] == 'DD') {
                                $paid_by_dd += number_format($value['deposite_amt'], 0, ',', '');
                            }

                            if ($value['mode'] == 'NETBANKING') {
                                $paid_by_netbanking += number_format($value['deposite_amt'], 0, ',', '');
                            }

                            if ($value['mode'] == 'Credit Card/Debit Card/UPI') {
                                $paid_by_card += number_format($value['deposite_amt'], 0, ',', '');
                            }

                        }
                    }

                    //--------------------------------------------------------------------------------------------------
                    $total2 = 0;

                    foreach ($paidamount as $key => $value) {
                        if ($value['student']['class_id'] == $s_id && $value['student']['section_id'] == $section[0]['id']) {
                            if ($value['discount']) {
                                $total2 += $value['discount'];
                            }
                        }
                    }

                    $total_discount += $total2;
                    //----------------------------------------------------------------------------------------------------

                    $out += (($amount[0]['qu1_fees'] + $amount[0]['qu2_fees'] + $amount[0]['qu3_fees'] + $amount[0]['qu4_fees']) * $totalstudentcount) - ($totalpaidfee + $total_discount);

                    //Due fees calculation
                    $total_due_balance += $this->sessionDueAmount($s_id, $section[0]['id'], $acedmicyear);

                    // paid amount of current day

                    //--------------------------------------------------------------admin detail end-------------------------------------------->

                    $paidamount = $this->findpaidcurrentamount($acedmicyear, $current_date);
                    //    pr($paidamount);

                }

                /*
                echo 'Total Fees= '.$total.'<br>';
                echo 'Paid Fees= '.$totalpaidfee.'<br>';
                echo 'Due Fees= '.$total_due_balance.'<br>';
                echo 'Outstanding Fees= '.$out.'<br>'.'------------------------------------ <br>';
                 */

                $array_of_grand_totals['total_fees'] += $total;
                $array_of_grand_totals['paid_fees'] += $totalpaidfee;
                $array_of_grand_totals['paid_by_cash'] += $paid_by_cash;
                $array_of_grand_totals['paid_by_cheque'] += $paid_by_cheque;
                $array_of_grand_totals['paid_by_dd'] += $paid_by_dd;
                $array_of_grand_totals['paid_by_netbanking'] += $paid_by_netbanking;
                $array_of_grand_totals['paid_by_card'] += $paid_by_card;
                $array_of_grand_totals['due_fees'] += $total_due_balance;
                $array_of_grand_totals['success'] = 1;
            }
        }
        $product = array();

        $paidamounts = $this->findpaidamountss2($acedmicyear, $role);

        $response = $array_of_grand_totals;
        $response["output"] = array();
        foreach ($paidamounts as $key => $value) {
            $product['paid_by_cheque'] = '0';
            $product['paid_by_cash'] = '0';
            $product['paid_by_dd'] = '0';
            $product['paid_by_netbanking'] = '0';
            $product['paid_by_card'] = '0';
            $product['collectionfee'] = '0';
            $product['date'] = date('d-m-Y', strtotime($value['paydate']));

            $value['paydate'] = date('Y-m-d', strtotime($value['paydate']));
            $paidamountsCHEQUE = $this->findpaidamountss2h($value['paydate'], $role, 'CHEQUE');

            $paidamountsCASH = $this->findpaidamountss2h($value['paydate'], $role, 'CASH');
            $paidamountsDD = $this->findpaidamountss2h($value['paydate'], $role, 'DD');
            $paidamountsNETBANKING = $this->findpaidamountss2h($value['paydate'], $role, 'NETBANKING');
            $paidamountsCARD = $this->findpaidamountss2h($value['paydate'], $role, 'Credit Card/Debit Card/UPI');
            if ($paidamountsCHEQUE) {

                foreach ($paidamountsCHEQUE as $t => $u) {
                    $product['paid_by_cheque'] += number_format($u['deposite_amt'], 0, ',', '');
                    $product['collectionfee'] += number_format($u['deposite_amt'], 0, ',', '');
                }
            }

            if ($paidamountsCASH) {
                foreach ($paidamountsCASH as $t => $uiii) {
                    $product['paid_by_cash'] += number_format($uiii['deposite_amt'], 0, ',', '');
                    $product['collectionfee'] += number_format($uiii['deposite_amt'], 0, ',', '');

                }
            }
            if ($paidamountsDD) {
                foreach ($paidamountsDD as $t => $ugg) {
                    $product['paid_by_dd'] += number_format($ugg['deposite_amt'], 0, ',', '');
                    $product['collectionfee'] += number_format($ugg['deposite_amt'], 0, ',', '');
                }
            }
            if ($paidamountsNETBANKING) {
                foreach ($paidamountsNETBANKING as $t => $ssu) {
                    $product['paid_by_netbanking'] += number_format($ssu['deposite_amt'], 0, ',', '');
                    $product['collectionfee'] += number_format($ssu['deposite_amt'], 0, ',', '');
                }
            }
            if ($paidamountsCARD) {
                foreach ($paidamountsCARD as $t => $su) {
                    $product['paid_by_card'] += number_format($su['deposite_amt'], 0, ',', '');
                    $product['collectionfee'] += number_format($su['deposite_amt'], 0, ',', '');
                }
            }

            array_push($response["output"], $product);
        }

        echo json_encode($response);
    }

    public function findpaidcurrentamount($a_year, $current_date)
    {
        $articles = TableRegistry::get('Studentfees');

        return $articles->find('all')->contain(['Students'])->where(['Studentfees.acedmicyear' => $a_year, 'DATE(Studentfees.paydate)' => $current_date])->order(['Studentfees.id' => 'ASC'])->toArray();
    }

    public function findstudentcount($id, $a_year, $section_id)
    {
        $articles = TableRegistry::get('Students');

        return $articles->find('all')->where(['Students.acedmicyear' => $a_year, 'Students.status' => 'Y', 'Students.class_id' => $id, 'Students.section_id' => $section_id])->count();
    }

    //-----------------------------------------------------------------------------------------------------
    public function findpaidamount($a_year, $role)
    {
        $articles = TableRegistry::get('Studentfees');
        if ($role == '11') {

            return $articles->find('all')->contain(['Students'])->where(['Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y', 'Studentfees.acedmicyear' => $a_year, 'Students.board_id IN' => ['1'], 'Students.status' => 'Y'])->order(['Studentfees.id' => 'ASC'])->toArray();

        } else if ($role == '10') {

            return $articles->find('all')->contain(['Students'])->where(['Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y', 'Studentfees.acedmicyear' => $a_year, 'Students.board_id IN' => ['2', '3'], 'Students.status' => 'Y'])->order(['Studentfees.id' => 'ASC'])->toArray();
        } else {
            return $articles->find('all')->contain(['Students'])->where(['Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y', 'Studentfees.acedmicyear' => $a_year, 'Students.status' => 'Y'])->order(['Studentfees.id' => 'ASC'])->toArray();

        }

    }

    public function findpaidamount2($a_year)
    {
        $articles = TableRegistry::get('Studentfees');

        return $articles->find('all')->select(['Studentfees.deposite_amt', 'Studentfees.paydate', 'Studentfees.student_id'])->where(['Studentfees.acedmicyear' => $a_year])->order(['Studentfees.paydate' => 'DESC']);
    }

    public function findpaidamountss2($a_year, $role)
    {
        $articles = TableRegistry::get('Studentfees');
        $articles = TableRegistry::get('Studentfees');
        if ($role == '11') {

            return $articles->find('all')->where(['Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y', 'Students.board_id IN' => ['1'], 'Students.status' => 'Y'])->contain(['Students'])->group('Studentfees.paydate')->order(['Studentfees.paydate' => 'DESC'])->toArray();
        } else if ($role == '10') {

            return $articles->find('all')->where(['Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y', 'Students.board_id IN' => ['2', '3'], 'Students.status' => 'Y'])->contain(['Students'])->group('Studentfees.paydate')->order(['Studentfees.paydate' => 'DESC'])->toArray();
        } else {
            return $articles->find('all')->where(['Studentfees.acedmicyear' => $a_year, 'Studentfees.status' => 'Y', 'Students.status' => 'Y'])->contain(['Students'])->group('Studentfees.paydate')->order(['Studentfees.paydate' => 'DESC'])->toArray();

        }

    }

    public function findpaidamountss2h($paydate, $role, $tex)
    {
        $articles = TableRegistry::get('Studentfees');
        $articles = TableRegistry::get('Studentfees');
        if ($role == '11') {

            return $articles->find('all')->where(['Studentfees.paydate' => $paydate, 'Studentfees.mode' => $tex, 'Studentfees.status' => 'Y', 'Students.board_id IN' => ['1'], 'Students.status' => 'Y'])->contain(['Students'])->order(['Studentfees.paydate' => 'DESC'])->toArray();
        } else if ($role == '10') {

            return $articles->find('all')->where(['Studentfees.mode' => $tex, 'Studentfees.paydate' => $paydate, 'Studentfees.status' => 'Y', 'Students.board_id IN' => ['2', '3'], 'Students.status' => 'Y'])->contain(['Students'])->order(['Studentfees.paydate' => 'DESC'])->toArray();
        } else {
            return $articles->find('all')->where(['Studentfees.paydate' => $paydate, 'Studentfees.mode' => $tex, 'Studentfees.status' => 'Y', 'Students.status' => 'Y'])->contain(['Students'])->order(['Studentfees.paydate' => 'DESC'])->toArray();

        }

    }

    public function sessionDueAmount($class_id, $section_id, $academicyear)
    {
        $student = $this->Students->find('all')
            ->where(['Students.acedmicyear' => $academicyear, 'Students.status' => 'Y', 'Students.class_id' => $class_id, 'Students.section_id' => $section_id])
            ->toArray();

        $total_dues_amount = 0;

        if (!empty($student)) {
            foreach ($student as $service) {
                $findamountmonth = $this->findamountmonth($service['class_id'], $academicyear);
                $findamount3month = $this->findamount3month($service['class_id'], $academicyear);
                $findamount2month = $this->findamount2month($service['class_id'], $academicyear);
                $findamount1month = $this->findamount1month($service['class_id'], $academicyear);
                $perticularamounts = $this->findperticularamount($service['id'], $academicyear);

                $findsum = $findamountmonth['qu4_fees'] + $findamount3month['qu3_fees'] + $findamount2month['qu2_fees'] + $findamount1month['qu1_fees'];

                $paidfeestotal = 0;

                foreach ($perticularamounts as $values) {

                    $paidfeestotal += number_format($values['deposite_amt'], 0, ',', '');

                }

                if ($findsum > $paidfeestotal) {

                    $dueamt = $findsum - $paidfeestotal;
                    $total_dues_amount += $dueamt;
                }
            }

            return $total_dues_amount;
        }
    }

    //-----------------------------------------------------------------
    public function findamountmonth($id, $a_year)
    {
        $articles = TableRegistry::get('Classfee');
        $m = date('Y-m-d');

        return $articles->find('all')->contain(['Classes'])->select(['qu4_fees' => $articles->find()->func()->sum('Classfee.qu4_fees'), 'Classes.title', 'Classfee.academic_year', 'Classfee.id', 'Classfee.status', 'Classfee.class_id'])->where(['Classfee.class_id' => $id, 'Classfee.academic_year' => $a_year, 'Classfee.qu4_date <=' => $m])->order(['Classfee.id' => 'ASC'])->first()->toArray();
    }

    public function findperticularamount($id, $a_year)
    {
        $articles = TableRegistry::get('Studentfees');

        return $articles->find('all')->select(['id', 'fee', 'discount', 'deposite_amt'])->where(['Studentfees.student_id' => $id, 'Studentfees.acedmicyear' => $a_year])->toArray();
    }
    public function classTimeTable()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $id = $postData->id;
            $classId = $postData->classId;
            $sectionId = $postData->sectionId;
            $idsprimeID = $postData->idsprimeID;
            if ((empty($id) && empty($classId) && empty($sectionId)) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            // pr($id);die;
            if(!empty($id)){
            $student = $this->Students->find('all')->where(['id' => $id])->first();
            //pr($student);die;
            $classId = $student['class_id'];
            $sectionId = $student['section_id'];
            }
            $time_tab = $this->Timetables->find('all')->toarray();
            $class_section = $this->Classections->find('all')->where(['class_id' => $classId, 'section_id' => $sectionId])->first();
            // pr($time_tab);die;
            $weekdays = explode(',', $time_tab[0]['weekday']);
            //pr($weekdays);die;
            $response = array();
            $response['success'] = 1;
            $response['timeTable'] = '';
            $output = array();

            foreach ($weekdays as $day) {
                $break = '';
                $key = strtolower($day);
                $output[$key] = '';
                $periods = array();
                $i = 1;
                foreach ($time_tab as $time_value) {

                    //pr($time_value);

                    if ($time_value['is_break'] != 1) {
                        $per_details = $this->ClasstimeTabs->find('all')->where(['class_id' => $class_section['id'], 'weekday' => $day, 'tt_id' => $time_value['id'], 'status' => '1'])->first();
                        //pr($per_details);

                        // pr($subj_name);
                        // pr($teach_name);
                        if (!empty($per_details)) {
                            $per_det = explode(',', $per_details['subject_id']);
                            $emp_det_val = explode(',', $per_details['employee_id']);
                            $temp_p = array();
                            foreach ($per_det as $keys => $per_det_val) {

                                $subj_name = $this->Subjects->find('all')->select(['alias'])->where(['id' => $per_det_val])->first();
                                $teach_name = $this->Employees->find('all')->select(['fname', 'middlename', 'lname'])->where(['id' => $emp_det_val[$keys]])->first();

                                if ($teach_name['middlename'] != '') {
                                    $temp_p[] = $subj_name['alias'] . "(" . strtoupper($teach_name['fname']) . "\x20" . strtoupper(substr($teach_name['middlename'], 0, 2)) . ")";
                                } else {
                                    $temp_p[] = $subj_name['alias'] . "(" . strtoupper($teach_name['fname']) . "\x20" . strtoupper(substr($teach_name['lname'], 0, 2)) . ")";
                                }
                            }
                            $periods[] = implode("\n", $temp_p);

                        } else {
                            $periods[] = "-";
                        }

                    } else {
                        $break = $i;
                    }
                    $i++;
                }
                //die;

                $output[$key] = $periods;

            }
            $output['break'] = $break;
            $response['timeTable'] = $output;
            echo json_encode($response);
        }

    }
    public function teacherTimeTable()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $teacherId = $postData->teacherId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($teacherId) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            //pr($teacherId);
            $time_tab = $this->Timetables->find('all')->toarray();
            // pr($time_tab);die;
            $weekdays = explode(',', $time_tab[0]['weekday']);
            //pr($weekdays);die;
            $response = array();
            $response['success'] = 1;
            $response['timeTable'] = '';
            $output = array();
            $break = '';
            foreach ($weekdays as $day) {
                $i = 1;

                $key = strtolower($day);
                $output[$key] = '';
                $periods = array();
                foreach ($time_tab as $time_value) {
                    //pr($time_value);

                    if ($time_value['is_break'] != 1) {
                        $per_details = $this->ClasstimeTabs->find('all')->contain(['Classections'])->where(['ClasstimeTabs.employee_id' => $teacherId, 'ClasstimeTabs.weekday' => $day, 'ClasstimeTabs.tt_id' => $time_value['id'], 'ClasstimeTabs.status' => '1'])->first();
                        //pr($per_details);
                        $subj_name = $this->Subjects->find('all')->select(['alias'])->where(['id' => $per_details['subject_id']])->first();
                        $class_title = $this->Classes->find('all')->select(['title'])->where(['id' => $per_details['classection']['class_id']])->first();
                        $section_title = $this->Sections->find('all')->select(['title'])->where(['id' => $per_details['classection']['section_id']])->first();
                        //pr($per_details);

                        // pr($subj_name);
                        // pr($teach_name);
                        if (!empty($per_details)) {

                            $periods[] = $subj_name['alias'] . "(" . $class_title['title'] . "-" . $section_title['title'] . ")";

                        } else {
                            $periods[] = "-";
                        }

                    } else {
                        $break = $i;
                    }
                    $i++;
                }
                $output[$key] = $periods;

            }
            $output['break'] = $break;
            $response['timeTable'] = $output;
            echo json_encode($response);

        }
    }

    public function studentAttendanceList()
    {

        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $employee_id = $postData->teacher_id;
            $class_id = $postData->class_id;
            $section_id = $postData->section_id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($employee_id) || empty($class_id) || empty($section_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $this->loadModel('Users');
            $atime = $this->Users->find('all')->select(['attendenceupdate'])->where(['role_id' => '1'])->first();
            $current_time = date("H.i", time());
            if ($current_time <= $atime['attendenceupdate']) {

                $response = [];
                $req_data = $this->request->data;
                //pr($req_data);die;

                $employee_id = $req_data['teacher_id'];
                $class_id = $req_data['class_id'];
                $section_id = $req_data['section_id'];
                $dat = date('Y-m-d');
                //pr($dat);
                $stu_atn_status = $this->Studattends->find('all')->where(['Studattends.class_id' => $class_id, 'Studattends.section_id' => $section_id, 'Studattends.date' => $dat])->count();
                //pr($stu_atn_status);die;
                if ($stu_atn_status > 0) {

                    $attn_taken = true;
                } else {
                    $attn_taken = false;
                }

                /*$employee_id ='1229';
                $class_id = '12';
                $section_id = '9';
                 */

                // ------------------------------------------------- //

                $current_month = date('m');
                $current_date = date('Y-m-d');

                if ($current_month >= '04') {
                    $academic_year = date('Y') . '-' . (date('y') + 1);
                } else {
                    $academic_year = (date('Y') - 1) . '-' . date('y');
                }

                if (!empty($employee_id) && !empty($class_id) && !empty($section_id)
                    && !empty($academic_year)) {

                    $employee_id_exists = $this->Employees->find('all')->where(['Employees.id' => $employee_id])->count();
                    if ($employee_id_exists == 1) {
                        $students = $this->Students->find()->select(['id', 'enroll', 'fname', 'middlename', 'lname', 'acedmicyear', 'rf_id'])
                            ->where(['class_id' => $class_id, 'section_id' => $section_id, 'acedmicyear' => $academic_year, 'Students.status' => 'Y'])->order(['fname' => 'ASC'])->toArray();
                        for ($i = 0; $i <= count($students); $i++) {

                            $student_id = $students[$i]['id'];
                            $attendence_status[] = $this->Studattends->find()->select(['status', 'status_m'])
                                ->where(['Studattends.stud_id' => $student_id, 'Studattends.date' => $current_date])->toArray();

                        }
                        $response["success"] = 1;
                        $response['is_attendance_updatable'] = true;
                        $response['isAttendanceTaken'] = $attn_taken;
                        $response["students"] = [];
                        $c = 0;
                        foreach ($students as $value) {
                            $connss = ConnectionManager::get('default');

                            $studentrfidsd = $connss->execute("SELECT * FROM `attendreports` WHERE rfid='" . $value['rf_id'] . "' AND DATE(resultdate)='" . date('Y-m-d') . "'");

                            $studentrfidsd = $studentrfidsd->fetchAll('assoc');
                            if ($studentrfidsd[0]['id']) {

                                $statushd = "P";
                            } else {

                                $statushd = "A";
                            }

                            $output['student_id'] = $value['id'];
                            $output['enroll'] = $value['enroll'];
                            $output['name'] = ucwords(strtolower($value['fname'])) . ' ' . ucwords(strtolower($value['middlename'])) . ' ' . ucwords(strtolower($value['lname']));

                            $output['academic_year'] = $value['acedmicyear'];
                            $output['attendence_status'] = $attendence_status[$c][0]['status'];
                            $output['attendence_statusmachine'] = $statushd;
                            array_push($response["students"], $output);
                            $c++;
                        }

                        echo json_encode($response);
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "You Are Not A Registered Employee";
                        echo json_encode($response);
                    }
                } else {
                    $response["message"] = "Invalid Post parameters.";
                    echo json_encode($response);
                }
            } else {
                $response["success"] = 1;
                $response['is_attendance_updatable'] = false;
                if ($this->request->is(['post', 'put'])) {
                    $req_data = $this->request->data;
                    //pr($req_data); die;
                    $cid = $req_data['class_id'];
                    $sid = $req_data['section_id'];
                    $tid = $req_data['teacher_id'];

                    $users = $this->Users->find('all')->where(['Users.id' => '1'])->first();
                    $acedmic = $users['academic_year'];
                    $dat = date('Y-m-d');
                    $stu_atn_status = $this->Studattends->find('all')->select(['stud_id', 'remark'])->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.date' => $dat])->count();
                    //pr($stu_atn_status); die;
                    if ($stu_atn_status > 0) {

                        $response['isAttendanceTaken'] = true;
                        $response['absentStudents'] = [];
                        $absent_stu_details = $this->Studattends->find('all')->select(['stud_id', 'remark'])->where(['Studattends.class_id' => $cid, 'Studattends.section_id' => $sid, 'Studattends.status' => 'A', 'Studattends.date' => $dat])->toArray();
                        if (!empty($absent_stu_details)) {

                            foreach ($absent_stu_details as $key => $value) {
                                //pr($value);

                                $stu_details = $this->Students->find('all')->select(['fname', 'middlename', 'lname', 'enroll'])->where(['Students.id' => $value['stud_id'], 'Students.status' => 'Y', 'Students.acedmicyear' => $acedmic])->first();
                                if (empty($stu_details)) {
                                    $stu_details = $this->DropOutStudent->find('all')->select(['fname', 'middlename', 'lname', 'enroll'])->where(['DropOutStudent.s_id' => $value['stud_id'], 'DropOutStudent.status' => 'Y', 'DropOutStudent.acedmicyear' => $acedmic])->first();
                                }
                                $response['absentStudents'][] = [
                                    'studentname' => $stu_details['fname'] . ' ' . $stu_details['middlename'] . ' ' . $stu_details['lname'],
                                    "rollno" => $stu_details['enroll'],
                                    "reason" => $value['remark'],
                                ];
                            }
                            echo json_encode($response);
                        } else {
                            $response["success"] = 0;
                            $response["message"] = "No Absent Students.";
                            echo json_encode($response);
                        }
                    } else {
                        $response["success"] = 1;
                        $response['isAttendanceTaken'] = false;
                        $response["message"] = "Attendance not taken!";
                        echo json_encode($response);

                    }

                }

            }
        }
    }
    public function studentAttendance()
    {
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $studentId = $postData->studentId;
            $period = $postData->date;
            $idsprimeID = $postData->idsprimeID;
            if (empty($teacherId) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            //pr($this->request->data);die;
            if (empty($period)) {
                $period = date('Y-m');
            }

            $expDate = explode('-', $period);
            $month = $expDate[1];
            $year = $expDate[0];
            $currentSessionDate = "";
            if ($month >= 04) {
                $year1 = $year + 1;
                $academicYear = $year . "-" . substr($year1, 2, 3);
                $currentSessionDate = $year . "-04-01";
            } else {
                $year1 = $year - 1;
                $academicYear = $year1 . "-" . substr($year, 2, 3);
                $currentSessionDate = $year1 . "-04-01";
            }

            $studentDetail = $this->Students->find('all')->where(['id' => $studentId])->first();
            //pr($academicYear);die;
            if (!empty($studentDetail['fname'])) {
                $expDiff = explode('-', $academicYear);
                $earlierYear = $expDiff[0];
                //$earlier = date('Y-m-d', strtotime($earlierYear . "-04-01"));
                $earlier = date_create($earlierYear . "-04-01");
                $laterYear = date('Y-m-d');
                //$later = date('Y-m-d', strtotime($laterYear . "-03-31"));
                $later = date_create($laterYear);
                $diff = date_diff($earlier, $later);
                $years['totalDays'] = (int) $diff->format("%a");
                //pr($years['totalDays']); die;
                $years['workingDays'] = $this->Studattends->find('all')->where(['class_id' => $studentDetail['class_id'], 'section_id' => $studentDetail['section_id'], 'acedemic' => $academicYear])->group(['date'])->count();
                //pr($yearTotalDays);
                $years['present'] = $this->Studattends->find('all')->where(['stud_id' => $studentId, 'status' => 'P', 'acedemic' => $academicYear])->count();
                //pr($yearPresent);
                $years['absent'] = $this->Studattends->find('all')->where(['stud_id' => $studentId, 'status' => 'A', 'acedemic' => $academicYear])->count();
                //pr($yearAbsent);
                $dateRange = $this->Studattends->find('all')->select(['date'])->where(['class_id' => $studentDetail['class_id'], 'section_id' => $studentDetail['section_id'], 'MONTH(date)' => $month])->group(['date'])->toarray();
                //pr($currMon);
                //pr($month);;
                //die;
                $daysMon = date('d');
                $currMon = date('m');
                if ($month != $currMon) {
                    $mon['totalDays'] = (int) cal_days_in_month(CAL_GREGORIAN, $month, $year);
                } else {
                    $mon['totalDays'] = (int) date('d');
                }
                $mon['workingDays'] = count($dateRange);

                //pr($monTotalDays);
                $mon['present'] = $this->Studattends->find('all')->where(['stud_id' => $studentId, 'status' => 'P', 'MONTH(date)' => $month])->count();
                // pr($monPresent);
                $mon['absent'] = $this->Studattends->find('all')->where(['stud_id' => $studentId, 'status' => 'A', 'MONTH(date)' => $month])->count();
                //pr($monAbsent);die;

                //$mon['holidays'] = $mon['totalDays'] - $mon['workingDays'];
                //pr($dateRange);die;
                $year_hol = 0;
                $e_start = date('Y-m-d', strtotime($currentSessionDate));
                for ($k = 1; $k <= $years['totalDays']; $k++) {
                    $event = $this->Events->exists(['Events.eventt' => '8', 'DATE(starttime) <=' => $e_start, 'DATE(endtime) >=' => $e_start]);
                    if ($event == 1) {
                        $year_hol++;
                    }

                    $e_start = date('Y-m-d', strtotime("+1 day", strtotime($e_start)));

                }
                $years['holidays'] = $year_hol;
                //pr($yearDays);die;
                $status = array();
                $presentstatus = array();
                $absentstatus = array();

                foreach ($dateRange as $values) {
                    $date = date('Y-m-d', strtotime($values['date']));

                    $studentStatus = $this->Studattends->find('all')->select(['status'])->where(['stud_id' => $studentId, 'DATE(date)' => $date])->first();
                    if ($studentStatus['status'] == 'P') {
                        $presentstatus[] = $date;
                    } else {
                        $absentstatus[] = $date;
                    }
                    $date1 = date('d-m-Y', strtotime($date));
                    $status[$date1] = $studentStatus['status'];

                }
                $t_days = (int) cal_days_in_month(CAL_GREGORIAN, $month, $year);
                $holiday = array();
                $mon_hol = 0;
                for ($e = 1; $e <= $t_days; $e++) {
                    $e_days = $year . '-' . $month . '-' . $e;
                    $e_date = date('Y-m-d', strtotime($e_days));
                    //pr($e_date);
                    $event = $this->Events->exists(['Events.eventt' => '8', 'DATE(starttime) <=' => $e_date, 'DATE(endtime) >=' => $e_date]);
                    if ($event == 1) {
                        $holiday[] = $e_date;
                        $mon_hol++;
                    }
                }

                $mon['holidays'] = $mon_hol;
                //$event = $this->Events->find('all')->where(['Events.eventt' => '8', 'MONTH(starttime)'])->toarray();

                $output['P'] = $presentstatus;
                $output['A'] = $absentstatus;
                $output['month'] = $mon;
                $output['year'] = $years;

                $response['success'] = 1;
                $response['holidays'] = $holiday;
                $response['attendanceStatus'] = $output;
                $response['currentDate'] = date('Y-m-d');
                $response['sessionStartDate'] = $currentSessionDate;

                // $response['yearTotalDays'] = $yearTotalDays;
                // $response['yearHolidays'] = $yearHolidays;
                // $response['yearWorkingDays'] = $yearWoDays;
                // $response['yearPresent'] = $yearPresent;
                // $response['yearAbsent'] = $yearAbsent;
                // $response['monTotalDays'] = $daysMon1;
                // $response['monHolidays'] = $monHolidays;
                // $response['monWorkingDays'] = $monWoDays;
                // $response['monPresent'] = $monPresent;
                // $response['monAbsent'] = $monAbsent;
                echo json_encode($response);

            } else {
                $response["success"] = 0;
                $response["message"] = "You are Not Registered";
                echo json_encode($response);
            }

        }
    }
    public function datesheet()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $sid = $postData->id;
            $idsprimeID = $postData->idsprimeID;
            if (empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $this->loadModel('Datesheet');
            $this->loadModel('Students');

            //pr($this->request->data);
            if (!empty($sid)) {
                $student_det = $this->Students->find('all')->where(['id' => $sid])->first();
                $class_id = $student_det['class_id'];
                $date = date('Y-m-d');
                $sheet = $this->Datesheet->find('all')->where(['end_date >=' => $date])->toarray();
                //pr($sheet);
                $response = array();
                if (!empty($sheet)) {
                    $cond['success'] = 0;
                    foreach ($sheet as $values) {
                        //pr($values);die;
                        $output = array();
                        $classes = explode(',', $values['class_id']);
                        if (in_array($class_id, $classes)) {
                            $cond['success'] = 1;
                            $output['title'] = ucwords($values['title']);
                            $output['start_date'] = date('d-m-Y', strtotime($values['start_date']));
                            $output['end_date'] = date('d-m-Y', strtotime($values['end_date']));
                            $db = $this->Users->find()->where(['role_id' => 1])->first();
                            $filename = IMAGE_URL . $db['db'] . 'img/' . $values['sheet_name'];

                            $file_headers = @get_headers($filename);

                            if ($file_headers && strpos($file_headers[0], '200 OK')) {
                                $output['url'] = $filename;
                            } else {
                                $output['url'] = SITE_URL . "datesheets/" . $values['sheet_name'];
                            }

                            // pr($output);

                        }
                        if (!empty($output['title'])) {
                            $response['success'] = 1;
                            $response['dateSheet'][] = $output;
                        }

                    }
                    if ($cond['success'] != 1) {
                        $response['success'] = 1;
                        $response['dateSheet'] = null;
                        $response['message'] = "No Data Available";
                    }
                    echo json_encode($response);

                } else {
                    $response['success'] = 1;
                    $response['dateSheet'] = null;
                    $response['message'] = "No Data Available";
                    echo json_encode($response);
                }

            } else {
                $response['success'] = 0;
                $response['message'] = "Invalid Post Parameter";
                echo json_encode($response);
            }
        }
    }
    public function teacherdatesheet()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $id = $postData->teacherId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $this->loadModel('Datesheet');
            $this->loadModel('classections');

            //pr($this->request->data);
            $emp_det = $this->classections->find('all')->where(['FIND_IN_SET(\'' . $id . '\',classections.teacher_id)'])->group(['class_id'])->toarray();

            if (!empty($emp_det)) {
                $cond['success'] = 0;
                $response = array();
                //pr($emp_det);die;

                $date = date('Y-m-d');
                $sheet = $this->Datesheet->find('all')->where(['end_date >=' => $date])->toarray();
                //pr($sheet);

                if (!empty($sheet)) {

                    foreach ($sheet as $values) {

                        foreach ($emp_det as $det) {

                            $class_id = $det['class_id'];
                            //pr($values);die;
                            $output = array();
                            $classes = explode(',', $values['class_id']);
                            if (in_array($class_id, $classes)) {
                                //echo "ok";; die;
                                $cond['success'] = 1;
                                $output['title'] = ucwords($values['title']);
                                $output['start_date'] = date('d-m-Y', strtotime($values['start_date']));
                                $output['end_date'] = date('d-m-Y', strtotime($values['end_date']));

                                $db = $this->Users->find()->where(['role_id' => 1])->first();
                                $filename = IMAGE_URL . $db['db'] . 'img/' . $values['sheet_name'];

                                $file_headers = @get_headers($filename);

                                if ($file_headers && strpos($file_headers[0], '200 OK')) {
                                    $output['url'] = $filename;
                                } else {
                                    $output['url'] = SITE_URL . "datesheets/" . $values['sheet_name'];
                                }
                                $response['success'] = 1;
                                $response['dateSheet'][] = $output;
                                break;
                            }

                        }

                    }
                }
                //pr($cond['success']);die;
                if ($cond['success'] == 0) {
                    $response['success'] = 1;
                    $response['dateSheet'] = null;
                    $response['message'] = "No Data Available";
                    echo json_encode($response);

                } else {
                    echo json_encode($response);

                }
            } else {
                $response['success'] = 0;
                $response['message'] = "Your ae not a registered user";
                echo json_encode($response);
            }
        }
    }
    public function galleryalbum()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $classId = $postData->classId;
            $sectionId = $postData->sectionId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($teacher_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $current_month = date('m');
            $current_date = date('Y-m-d');

            if ($current_month >= '04') {
                $academic_year = date('Y') . '-' . (date('y') + 1);
            } else {
                $academic_year = (date('Y') - 1) . '-' . date('y');
            }
            $album = $this->Album->find('all')->where(['acad_year' => $academic_year])->toarray();
            $output = array();
            $cond = array();
            if (!empty($album)) {
                foreach ($album as $values) {
                    $classes = explode(',', $values['class_id']);
                    $sections = explode(',', $values['section_id']);
                    $albumDet = array();
                    if (in_array($classId, $classes) && in_array($sectionId, $sections)) {
                        $cond['success'] = 1;
                        $albumDet['id'] = $values['id'];
                        $albumDet['title'] = $values['title'];
                        $albumDet['coverImage'] = 'http://192.168.5.6/school/galleryimages/' . $values['cover_image'];

                    }
                    array_push($output, $albumDet);
                }
                if ($cond['success'] == 1) {
                    $response['Success'] = 1;
                    $response['albums'] = $output;
                } else {
                    $response['success'] = 0;
                    $response['message'] = "No Data Available";
                }
            } else {
                $response['success'] = 0;
                $response['message'] = "No Data Available";
            }
            echo json_encode($response);

        }

    }
    public function galleryalbumimages()
    {
        $this->autoRender = false;
        $this->loadModel('Albumimages');
        if ($this->request->is('post')) {
            $albumId = $_POST['albumId'];
            //pr($albumId);
            $albumImages = $this->Albumimages->find('all')->where(['album_id' => $albumId])->toarray();
            //pr($albumImages);die;
            $response = array();
            if (!empty($albumImages)) {
                $response['success'] = 1;
                $response['images'] = array();
                foreach ($albumImages as $values) {
                    //pr($values);
                    $output['title'] = $values['title'];
                    $output['image'] = $values['image_name'];
                    array_push($response['images'], $output);
                }
            } else {
                $response['success'] = 0;
                $response['message'] = "No images to display";

            }
            echo json_encode($response);
        }
    }
    public function getTeacherClassDetail()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $teacher_id = $postData->teacherId;
            $idsprimeID = $postData->idsprimeID;
            if (empty($teacher_id) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);

            if (!empty($teacher_id)) {
                $teacher_exists = $this->Employees->find('all')->where(['id' => $teacher_id])->count();

                if ($teacher_exists == 1) {
                    $class_section_list = $this->ClasstimeTabs->find('all')->where(['FIND_IN_SET(\'' . $teacher_id . '\',ClasstimeTabs.employee_id)'])->contain(['Classections'])->toArray();

                    //pr($class_section_list);die;

                    if (!empty($class_section_list)) {
                        $response = [];

                        $response["success"] = 1;
                        $response['classes'] = [];

                        $asd = array();

                        foreach ($class_section_list as $value) {
                            //pr($value);die;
                            if (!in_array($value['classection']['class_id'], $asd)) {

                                $asd[] = $value['classection']['class_id'];

                            }

                        }
                        foreach ($asd as $k => $val) {

                            //pr($val);die;

                            $clas = $this->Classes->find('all')->select(['title'])->where(['id' => $val])->first();

                            $response['classes'][] = [
                                'id' => $val,
                                "name" => $clas['title'],
                            ];

                        }

                        echo json_encode($response);
                    } else {
                        $response["success"] = 0;
                        $response["message"] = "No Classes assigned.";
                        echo json_encode($response);
                    }

                } else {

                    $response["success"] = 0;
                    $response["message"] = "You Are Not a Registered Employee";
                    echo json_encode($response);
                }
            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        }
    }

    public function slider()
    {
        $this->autoRender = false;
        $response = array();
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data"; 
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $idsprimeID = $postData->idsprimeID;
            $this->db($idsprimeID);
            $this->loadmodel('Slider');
            $sliders = $this->Slider->find('all')->where(['status' => 'Y'])->toarray();
            if (!empty($sliders)) {
                $response['success'] = 1;
                $response['slider'] = array();
                foreach ($sliders as $slider) {
                    $output = array();
                    $filename2 = 'http://sanskar.idsprime.com/sliderimages/' . $slider['image'];

                    if ($this->is_url_exist($filename2)) {
                        $output['title'] = $slider['title'];
                        $output['image'] = 'http://sanskar.idsprime.com/sliderimages/' . $slider['image'];
                    }
                    if (!empty($output)) {
                        array_push($response['slider'], $output);
                    }

                }
                if (empty($response['slider'])) {
                    $response['success'] = 1;
                    $response['message'] = "No Slider Available";
                    $response['slider'] = null;

                }

            } else {
                $response['success'] = 1;
                $response['message'] = "No Slider Available";
                $response['slider'] = null;
            }

            echo json_encode($response);
        }
    }

    public function editemail()
    {
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $data['username'] = $postData->email;
            $idsprimeID = $postData->idsprimeID;
            if (empty($data['username']) || empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            if (!empty($data['username'])) {
                $id = $this->request->data['id'];
                $type = $this->request->data['type'];
                if ($type == 'Student') {
                    $student = $this->Students->get($id);
                    $stu = $this->Students->patchEntity($student, $data);
                    if ($this->Students->save($stu)) {
                        $response['success'] = 1;
                        $response['message'] = "Email Updated Successfully";
                    } else {
                        $response['success'] = 0;
                        $response['message'] = "Error in updating Email Please try after sometime";
                    }
                    echo json_encode($response);
                } else if ($type == 'Teacher') {
                    $employee = $this->Employees->get($id);
                    $emp = $this->Employees->patchEntity($employee, $data);
                    if ($this->Employees->save($emp)) {
                        $userdata['email'] = $data['username'];
                        $user = $this->Users->find('all')->where(['tech_id' => $id])->first();
                        $user_pat = $this->Users->patchEntity($user, $userdata);
                        $this->Users->save($user_pat);
                        $response['success'] = 1;
                        $response['message'] = "Email Updated Successfully";
                    } else {
                        $response['success'] = 0;
                        $response['message'] = "Error in updating Email Please try after sometime";
                    }
                    echo json_encode($response);
                } else {
                    $response['success'] = 0;
                    $response['message'] = "Invalid Post Parameters";
                    echo json_encode($response);
                }
            } else {
                $response['success'] = 0;
                $response['message'] = "Invalid Post Parameters";
                echo json_encode($response);
            }}

    }
    public function updateEmail()
    {
        $response = array();
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $id = $postData->id;
            $email = $postData->email;
            $idsprimeID = $postData->idsprimeID;
            if (empty($email) || empty($idsprimeID)|| empty($id)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);

            if (!empty($id) && !empty($email)) {
                $stu = $this->Students->get($id);
                //pr($stu);die;
                $students = $this->Students->find('all')->where(['Students.status' => 'Y', 'Students.sms_mobile' => $stu['sms_mobile']])->toarray();
                foreach ($students as $student) {
                    $stu_det = $this->Students->get($student['id']);
                    $data['username'] = $email;
                    $patch = $this->Students->patchEntity($stu_det, $data);
                    $this->Students->save($patch);
                }
                $response['success'] = 1;
                $response['message'] = "Email updated Successfully";
                echo json_encode($response);

            } else {
                $response["message"] = "Invalid Post parameters.";
                echo json_encode($response);
            }
        }
    }
    // public function news()
    // {
    //     $this->autoRender = false;
    //     $response = array();
    //     $product = array();
    //     // $d1 = date('Y-m-d 00:00:00');
    //     $d1 = date('2019-05-01 00:00:00');
    //     $event = $this->Events->find('all')->where(['Events.starttime >=' => $d1, 'Events.eventt' => '13'])->order(['Events.starttime' => 'ASC'])->toArray();

    //     $colorcode = '';

    //     if (!empty($event)) {
    //         $response["success"] = 1;
    //         $response["output"] = array();
    //         foreach ($event as $key => $iteam) {
    //             $id = $iteam['id'];
    //             $title = $iteam['title'];
    //             $desc = $iteam['detail'];
    //             $starttime = date('d-m-Y', strtotime($iteam['starttime']));
    //             $endtime = date('d-m-Y', strtotime($iteam['endtime']));
    //             //$eventtype=$this->Eventtypes->find('first')->where(['Eventtypes.id'=>$iteam['eventtype']])->contain(['Eventtypes'])->toArray();
    //             //echo $iteam['eventt'];
    //             $eventtypess = $this->Eventtypes->find('all')->where(['Eventtypes.id' => $iteam['eventt']])->toArray();
    //             //pr($eventtypess);
    //             $colorcode = $iteam['eventtype']['colorcode'];
    //             $eventypename = $eventtypess[0]['name'];
    //             $created = date('d-m-Y', strtotime($iteam['created']));
    //             //pr($created);
    //             //echo $eventypename;
    //             $product["id"] = $id;
    //             $product["title"] = $title;
    //             $product["post_on"] = $created;
    //             $product["description"] = $desc;
    //             $product["event_type"] = $eventypename;
    //             $product["start"] = $starttime;
    //             $product["end"] = $endtime;
    //             $product["color"] = $colorcode;
    //             array_push($response["output"], $product);
    //         }
    //     } else {
    //         $response["success"] = 0;
    //         $response["message"] = 'No Event Data Found';

    //     }
    //     echo json_encode($response);
    //     return;

    // }
    public function notifications()
    {

        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $userid = $postData->userId;
            $type = $postData->login_type;
            $idsprimeID = $postData->idsprimeID;
            if (empty($idsprimeID) || empty($userid) || empty($type)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);

            $mon = date('m');
            $year = date('Y');
            $this->loadModel('Smsdeliverydetails');
            if (strtolower($type) == "teacher") {
                $result = $this->Employees->find('all')->where(['id' => $userid])->first();
                $sms_del = $this->Smsdeliverydetails->find('all')->select(['Smsdeliverydetails.created', 'Smsdelivery.message'])->where(['Smsdeliverydetails.stud_id' => $userid, 'Smsdeliverydetails.type' => 'E', 'MONTH(Smsdeliverydetails.created)' => $mon, 'YEAR(Smsdeliverydetails.created)' => $year])->contain(['Smsdelivery'])->order(['Smsdeliverydetails.id' => 'DESC'])->toarray();
                //  pr($sms_del); die;
            } else if (strtolower($type) == "student") {
                $result = $this->Students->find('all')->where(['id' => $userid])->first();
                $sms_del = $this->Smsdeliverydetails->find('all')->select(['Smsdeliverydetails.created', 'Smsdelivery.message'])->where(['Smsdeliverydetails.stud_id' => $userid, 'Smsdeliverydetails.type' => 'S', 'MONTH(Smsdeliverydetails.created)' => $mon, 'YEAR(Smsdeliverydetails.created)' => $year])->contain(['Smsdelivery'])->order(['Smsdeliverydetails.id' => 'DESC'])->toarray();
            } else if (strtolower($type) == "admin") {
                $sms_del = $this->Smsdelivery->find('all')->where(['MONTH(Smsdelivery.created)' => $mon, 'YEAR(Smsdelivery.created)' => $year])->order(['id' => 'DESC'])->toarray();
                $response['success'] = 1;
                $response['output'] = array();
                foreach ($sms_del as $value) {
                    $data = array();
                    $data['message'] = $value['message'];
                    $data['messageDate'] = date('d-m-Y', strtotime($value['created']));
                    $response['output'][] = $data;
                }
                echo json_encode($response);
                return;
            } else {
                $response['success'] = 0;
                $response["message"] = "Invalid User Type";
                echo json_encode($response);
                return;
            }
            if (empty($result)) {
                $response["success"] = 0;
                $response["message"] = "User Doesn't exist";
                echo json_encode($response);
                return;
            }
            $response['success'] = 1;
            if (empty($sms_del)) {
                $response['success'] = 0;
                $response['output'] = null;
                $response['message'] = "No Notifications";
            } else {
                $response['output'] = array();
                foreach ($sms_del as $value) {
                    $data = array();
                    $data['message'] = $value['Smsdelivery']['message'];
                    $data['messageDate'] = date('d-m-Y', strtotime($value['created']));
                    $response['output'][] = $data;
                }
            }
            echo json_encode($response);
            return;
        }
    }
    public function feedbackcategories()
    {
        $this->autoRender = false;
        $jsonData = $this->request->input('json_decode');
        if (empty($jsonData)) {
            $response["success"] = 0;
            $response["message"] = "Invalid Json Data";
            echo json_encode($response);
            return;
        } else {
            $postData = $this->dPayload($jsonData);
            $idsprimeID = $postData->idsprimeID;
            if (empty($idsprimeID)) {
                $response["success"] = 0;
                $response["message"] = "Invalid Parameter";
                echo json_encode($response);
                return;
            }
            $this->db($idsprimeID);
            $this->loadModel('FeedbackCat');
            $cat = $this->FeedbackCat->find('list', array(['keyField' => 'id', 'valueField' => 'name']))->toarray();
            $response['success'] = 1;
            $response['category'] = array();
            foreach ($cat as $key => $value) {
                $data['id'] = $key;
                $data['name'] = $value;
                $response['category'][] = $data;
            }
            if (empty($cat)) {
                $response['success'] = 0;
                $response['category'] = null;
            }
            echo json_encode($response);die;
            return;
        }
    }

    public function feedback()
    {
        $this->autoRender = false;
        if ($this->request->is('post')) {
            try {
                $this->loadModel('Feedbacks');
                $students = explode(',', $this->request->data['userId']);
                foreach ($students as $id) {
                    $new = $this->Feedbacks->newEntity();
                    $new['stud_id'] = $id;
                    $new['feedback_cat_id'] = $this->request->data['feedbackCat'];
                    $new['feedback'] = $this->request->data['feedback'];
                    if (empty($new['stud_id']) || empty($new['feedback_cat_id']) || empty($new['feedback'])) {
                        $response['success'] = 0;
                        $response['message'] = "Fields cant be blank";
                        echo json_encode($response);
                        throw new Exception('Fields cant be blank');
                    }
                    $stu = $this->Students->find('all')->contain(['Classes', 'Sections'])->where(['Students.id' => $new['stud_id']])->first();
                    $new['student_name'] = $stu['fname'] . ' ' . $stu['middlename'] . ' ' . $stu['lname'];
                    $new['class'] = $stu['class']['title'];
                    $new['section'] = $stu['section']['title'];
                    $new['phone'] = $stu['sms_mobile'];
                    $this->Feedbacks->save($new);
                }
                $response['success'] = 1;
                $response['message'] = "Thank you for your valuable feedback";
                echo json_encode($response);
            } catch (\PDOException $e) {
                $response['success'] = 0;
                $response['message'] = "Error in saving data please try later";
                echo json_encode($response);
            }
            return;
        } else {
            $response['success'] = 0;
            $response["message"] = "Invalid Request Type";
            echo json_encode($response);
            return;
        }
    }
    public function addVisitor()
    {
        $this->autoRender = false;
        $this->loadModel('visitors');
        if ($this->request->is('post')) {
            $validator = new Validator();
            $validator->requirePresence(['name', 'phone', 'purpose', 'persons', 'toMeet', 'photo', 'userId'])
                ->notEmpty('name', 'Name can\'t be empty')
                ->notEmpty('phone', 'phone can\'t be empty')
                ->notEmpty('purpose', 'purpose can\'t be empty')
                ->notEmpty('persons', 'persons can\'t be empty')
                ->notEmpty('toMeet', 'toMeet can\'t be empty')
                ->notEmpty('photo', 'image can\'t be empty')
                ->notEmpty('userId', 'userId can\'t be empty');
            $errors = $validator->errors($this->request->data);
            if (!empty($errors)) {
                $response['success'] = 0;
                $response['message'] = "Missing parameter(s)";
                echo json_encode($response);
                return;
            } else {
                $data['name'] = $this->request->data['name'];
                $data['phone'] = $this->request->data['phone'];
                $data['purpose'] = $this->request->data['purpose'];
                $data['persons'] = $this->request->data['persons'];
                $data['to_meet'] = $this->request->data['toMeet'];
                $data['user_id'] = $this->request->data['userId'];
                $data['intime'] = date('H:i:s');
                $image = $this->request->data['photo'];
                $tmp = $image['tmp_name'];
                $ext = pathinfo($image['name'], PATHINFO_EXTENSION);
                $img_name = $data['phone'] . uniqid() . '.' . $ext;
                $location = "visitors/" . $img_name;
                $filePath = WWW_ROOT . 'visitors/' . $imagename;
                if (move_uploaded_file($tmp, $location)) {

